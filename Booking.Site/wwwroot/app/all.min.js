var __extends=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}if(typeof i!="function"&&i!==null)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),It,lists,common,days,resources,messages,access,auth,system,permissions,roles,rules,users,help,templates,jobs,settings_ui,configs,calendars,docs,expenses,paydocs,paychannels,tarifs,discounts,abonements,spheres,bases,equipments,rooms,prices,app,booking,clients,favorites,groups,points,promo,reviews,trans,orders,order_rules,domains,mailings;(function(n){var t;(function(t){function i(t){t===void 0&&(t="lib/webix/pivot/");n.Web.loadCSS(t+"pivot.css?v=5.1.5");n.Web.loadJS(t+"pivot.js?v=5.1.5");n.Web.loadJS("lib/webix-ext/xlsx.core.min.js")}var r=function(n){function r(t){t===void 0&&(t=!0);var i=n.call(this)||this;return i.loadjs=t,i}return __extends(r,n),r.prototype.config=function(){this.loadjs&&i();return new t.Configs.PivotConfig(this)},r.prototype.clearConfig=function(n){(n===void 0&&(n=!1),!n||confirm("Сбросить настройки таблицы?"))&&(webix.storage.local.remove(this._configName),this.ref.setStructure(this._structure))},r.prototype.setConfig=function(n,t){var r=this,i;return t===void 0&&(t=!0),this._structure=this.ref.getStructure(),this._configName=location.host+"."+n,i=webix.storage.local.get(this._configName),i&&this.ref.setStructure(i),t&&this.ref.attachEvent("onBeforeApply",function(n){return r.saveConfig(n)}),this},r.prototype.saveConfig=function(n){webix.storage.local.put(this._configName,n)},r}(t.RefTable);t.RefPivot=r})(t=n.UI||(n.UI={}))})(It||(It={})),function(n){var t;(function(n){var t;(function(n){var t=function(n){function t(t){var i=n.call(this)||this,r;return i.__pivot=t,r={view:"pivot",id:i.__pivot.id,borderless:!0,totalColumn:"sumOnly",footer:"sumOnly"},i.extend(r),i}return __extends(t,n),t}(n.ContainerConfig);n.PivotConfig=t})(t=n.Configs||(n.Configs={}))})(t=n.UI||(n.UI={}))}(It||(It={})),function(n){var t;(function(n){var t;(function(){var n=webix;webix.protoUI({name:"ace-editor",defaults:{mode:"javascript",theme:"monokai"},$init:function(){this.$ready.push(this._render_cm_editor)},_render_cm_editor:function(){var n=this;window.It.Web.loadJSAsync("https://cdn.webix.com/components/ace/ace/src-min-noconflict/ace.js",function(){return n._render_when_ready()})},_render_when_ready:function(){var n="https://cdn.webix.com/components/ace/ace/src-min-noconflict/";ace.config.set("basePath",n);ace.config.set("modePath",n);ace.config.set("workerPath",n);ace.config.set("themePath",n);this.editor=ace.edit(this.$view);this.editor.$blockScrolling=Infinity;this.editor.setOptions({fontFamily:"consolas,monospace",fontSize:"12pt"});this.config.theme&&this.editor.setTheme("ace/theme/"+this.config.theme);this.config.mode&&this.editor.getSession().setMode("ace/mode/"+this.config.mode);this.config.value&&this.setValue(this.config.value);this._focus_await&&this.focus();this.editor.navigateFileStart();this.callEvent("onReady",[this.editor])},setValue:function(n){n||n===0||(n="");this.config.value=n;this.editor&&this.editor.setValue(n)},getValue:function(){return this.editor?this.editor.getValue():this.config.value},focus:function(){this._focus_await=!0;this.editor&&this.editor.focus()},getEditor:function(){return this.editor}},n.ui.view,webix.EventSystem)})(t=n.acejs||(n.acejs={}))})(t=n.UI||(n.UI={}))}(It||(It={})),function(n){var t;(function(t){var i;(function(){var t=webix.ui;webix.protoUI({name:"html-editor",defaults:{config:{theme:"modern",statusbar:!1,menubar:!1},barHeight:74,value:""},$init:function(){n.Web.loadJS("lib/tinymce/tinymce.min.js");this.$view.className+=" webix_selectable";this._waitEditor=webix.promise.defer();this.$ready.push(this.render)},render:function(){this._set_inner_size()},_init_tinymce_once:function(){this._mce_id="webix_mce_"+this.config.id;this.$view.innerHTML="<textarea id='"+this._mce_id+"' style='width:1px; height:1px'><\/textarea>";this._allowsClear=!0;tinyMCEPreInit={query:"",base:"lib/tinymce5",suffix:".min"};tinyMCE.baseURL="lib/tinymce/";tinyMCE.suffix=".min";webix.require("../tinymce/tinymce.min.js",function(){webix.html.addStyle(".mce-tinymce.mce-container{ border-width:0px !important}");var n=this.config.config;n.mode="exact";n.theme_url="lib/tinymce/themes/modern/theme.min.js";n.height=300;n.setup=webix.bind(this._mce_editor_setup,this);n.elements=[this._mce_id];n.id=this._mce_id;n.paste_data_images=!0;n.plugins="fullscreen table paste hr link image charmap print preview searchreplace visualblocks visualchars code media emoticons template textcolor autolink";n.toolbar=" insert | undo redo | forecolor backcolor styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image code";tinyMCE.init(n)},this);this._init_tinymce_once=function(){}},_mce_editor_setup:function(n){n.on("init",webix.bind(this._mce_editor_ready,this))},_mce_editor_ready:function(){this._3rd_editor=tinyMCE.get(this._mce_id);this._set_inner_size();this._waitEditor.resolve(this._3rd_editor);this.setValue(this.config.value);this._focus_await&&this.focus()},_set_inner_size:function(){this._3rd_editor&&this.$width&&this._3rd_editor.theme.resizeTo(this.$width,this.$height-this.config.barHeight)},$setSize:function(n,t){webix.ui.view.prototype.$setSize.call(this,n,t)&&(this._init_tinymce_once(),this._set_inner_size())},setValue:function(n){this.config.value=n;this._3rd_editor&&this._3rd_editor.setContent(n)},getValue:function(){return this._3rd_editor?this._3rd_editor.getContent():this.config.value},focus:function(){this._focus_await=!0;this._3rd_editor&&this._3rd_editor.focus()},getEditor:function(n){return n?this._waitEditor:this._3rd_editor}},webix.ui.view)})(i=t.tinymce||(t.tinymce={}))})(t=n.UI||(n.UI={}))}(It||(It={})),function(n){var f=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.list=function(t){return n.prototype.load.call(this,"list",t)},t.prototype.archive=function(n){return this.post("archive",{id:n})},t}(It.Web.WebSource),u,r,t,i;n.AppDataSource=f;u=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.reset=function(n){n===void 0&&(n="");n&&(this.name=n);this.hash=this.getLastUpdateHash(this.name)},t.prototype.has=function(n){n===void 0&&(n=!1);var t=this.getLastUpdateHash(this.name);return console.log("check: ",t,this.hash),t!=this.hash},t.prototype.getLastUpdateHash=function(n){return this.load("last",{name:n})},t}(n.AppDataSource);n.UpdatesSource=u;n.meta={timePattern:{mask:"##-##",allow:/[0-9]/g},timeValidator:function(n){return n>=0&&n<=24}},function(n){n[n.Undefined=0]="Undefined";n[n.UseDiscount=1]="UseDiscount";n[n.IgnoreDiscount=2]="IgnoreDiscount"}(r=n.DiscountKind||(n.DiscountKind={}));n.discountKinds=[{id:r.UseDiscount,value:"Учитываем"},{id:r.IgnoreDiscount,value:"Блокируем"},],function(n){n[n.WorkFirstDay=1]="WorkFirstDay";n[n.WorkDay=3]="WorkDay";n[n.WorkLastDay=5]="WorkLastDay";n[n.Weekend1=6]="Weekend1";n[n.Weekend2=7]="Weekend2"}(t=n.DayKind||(n.DayKind={}));n.dayKinds=[{id:t.WorkFirstDay,value:"Перв.Рабочий"},{id:t.WorkDay,value:"Рабочий"},{id:t.WorkLastDay,value:"Посл.Рабочий"},{id:t.Weekend1,value:"СБ"},{id:t.Weekend2,value:"ВС"},],function(n){n[n.Reserv=1]="Reserv";n[n.Payment=2]="Payment";n[n.Cancel=3]="Cancel";n[n.Forfeit=4]="Forfeit";n[n.Review=5]="Review"}(i=n.NotifyKind||(n.NotifyKind={}));n.notifications=[{id:i.Reserv,value:"Резерв"},{id:i.Payment,value:"Оплата"},{id:i.Cancel,value:"Отмена"},{id:i.Forfeit,value:"Штраф"},{id:i.Review,value:"Отзыв"},];n.booleans=[{id:"false",value:"Нет"},{id:!0,value:"Да"},]}(app||(app={})),function(n){var t=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.names=function(n){return this.load("names",n)},t}(app.AppDataSource);n.DataSource=t}(lists||(lists={})),function(n){n.timeZones=[{id:"+02:00",value:"MSK–1 (UTC+2) Калининград"},{id:"+03:00",value:"MSK+0 (UTC+3) Москва"},{id:"+04:00",value:"MSK+1 (UTC+4) Самара"},{id:"+05:00",value:"MSK+2 (UTC+5) Екатеринбург"},{id:"+06:00",value:"MSK+3 (UTC+6) Омск"},{id:"+07:00",value:"MSK+4 (UTC+7) Красноярск"},{id:"+08:00",value:"MSK+5 (UTC+8) Иркутск"},{id:"+09:00",value:"MSK+6 (UTC+9) Якутск"},{id:"+10:00",value:"MSK+7 (UTC+10) Владивосток"},{id:"+11:00",value:"MSK+8 (UTC+11) Магадан"},{id:"+12:00",value:"MSK+9 (UTC+12) Камчатск"},]}(common||(common={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n}return __extends(i,t),i.prototype.$config=function(){var u=this,i,r;return t.prototype.$config.call(this),i=this.grid.config().extend({columns:[$u.column("date").Header("Дата").AsDate().Sort().Edit(),$u.column("isWeekend").Header("Выходной").AsCheckbox().Sort().Edit(),$u.column("description").Header("Описание",-1).Edit(),],scheme:{date:new Date},data:n.db.list(),save:n.db.getSaveCfg(!0)}).Editable(),r={rows:[$u.panelbar(this.grid.btnAdd(),this.grid.btnDel(),this.grid.btnRefresh(function(){return u.refresh()}),{}),i,]},r},i.prototype.refresh=function(){var t=n.db.list();this.grid.refresh(t)},i}($u.View);n.GridView=t}(days||(days={})),function(n){n.create={grid:function(){return new n.GridView}};var t=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.isWeekend=function(n){this.days||(this.days=this.list());var i=webix.i18n.dateFormatStr(n),t=this.days.find(function(n){return webix.i18n.dateFormatStr(n.date)==i});return t?t.isWeekend:n.isWeekend()},t}(app.AppDataSource);n.db=new t("days")}(days||(days={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.list=new $u.RefList,n}return __extends(i,t),i.prototype.$config=function(){var t=this.list.config().extend({view:"dataview",itemheight:!0,select:!1,template:function(n){var i="base_"+n.type,t="<div class='".concat(i,"'><strong>").concat(n.name,"<\/strong><hr>"),r=n.resources;return r.forEach(function(n){return t+="<div>".concat(n.name,"<\/div>").link(n.value,{target:"_blank"})}),t+="<\/div>"},type:{height:150,width:250},url:n.db.camerasUrl});return{rows:[{cols:[$u.label("Список камер"),this.list.btnRefresh(),{},]},t,]}},i}($u.View);n.CamerasView=t}(resources||(resources={})),function(n){var t=function(t){function i(n,i){var r=t.call(this)||this;return r.kind=n,r.caption=i,r.grid=new $u.RefGrid,r.view=new $u.RefUI,r}return __extends(i,t),i.prototype.$config=function(i){i===void 0&&(i=!0);t.prototype.$config.call(this);var r=this.grid.config().extend({columns:[$u.column("name").Header("Тип",100).AsSelect(n.phoneTypes).Sort().Edit(),$u.column("value").Header("Телефон",-1).Edit().extend({format:"###",pattern:"(###) ###-##-##"}),],scheme:{id:-1,name:"без имени",kind:this.kind},type:{href:"#!"},rules:{value:function(t,i){var r=n.db.testPhone(i.id,t);return r?(It.UI.w.info(r),!1):!0}},save:n.db.getSaveCfg(!0)}).Editable().Disable(!i);return $u.rows($u.panelbar($u.label(this.caption),this.grid.btnAdd().Visible(i),this.grid.btnDel().Visible(i),{}),r).Ref(this.view)},i.prototype.$reload=function(i){t.prototype.$reload.call(this,i);this.grid.scheme({objectId:i,kind:this.kind});var r=n.db.getItems(this.kind,i);this.grid.refresh(r)},i.prototype.enable=function(n){this.view.enable(n)},i}($u.View);n.PhonesView=t}(resources||(resources={})),function(n){var i,t;n.create={cameras:function(){return new n.CamerasView}},function(n){n[n.RoomPhoto=3]="RoomPhoto";n[n.RoomUrl=4]="RoomUrl";n[n.BaseCamera=7]="BaseCamera";n[n.ClientPhone=8]="ClientPhone"}(i=n.ResourceKind||(n.ResourceKind={}));n.phoneTypes=[{id:"MOBILE",value:"Мобильный"},{id:"WORK",value:"Рабочий"},{id:"HOME",value:"Домашний"},];n.urlTypes=[{id:"sound",value:"Sound Cloud"},{id:"video",value:"Видео"},{id:"web",value:"Ссылка"},{id:"other",value:"Другое"},];t=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.camerasUrl=t.url("cameras"),t}return __extends(t,n),t.prototype.getItems=function(n,t){return this.load("list",{kind:n,id:t})},t.prototype.testPhone=function(n,t){return t?this.loadStr("testPhone",{id:n,phone:t}):null},t}(app.AppDataSource);n.db=new t("resources")}(resources||(resources={})),function(n){var t=function(t){function i(){var n=t.call(this)||this;return n.grid=new $u.RefGrid,n}return __extends(i,t),i.prototype.$config=function(){t.prototype.$config.call(this);var i=this.grid.config().extend({columns:[$u.column("name").Header("Тип",100).AsSelect(n.urlTypes).Sort().Edit(),$u.column("description").Header("Описание",-1).Edit(),$u.column("value").Header("Ссылка",-1).Edit().Template("#value#".link("#value#",{target:"_blank"})),],type:{href:"#!"},save:n.db.getSaveCfg(!0)}).Editable();return $u.rows($u.header("О площадке".tag("b"),this.grid.btnAdd(),this.grid.btnDel()),i)},i.prototype.$reload=function(i){t.prototype.$reload.call(this,i);this.grid.scheme({objectId:i,kind:n.ResourceKind.RoomUrl});var r=n.db.getItems(n.ResourceKind.RoomUrl,i);this.grid.refresh(r)},i}($u.View);n.UrlView=t}(resources||(resources={})),function(n){var t=function(t){function i(){return t!==null&&t.apply(this,arguments)||this}return __extends(i,t),i.prototype.$config=function(){return this.form.config().extend({width:400,elements:[$u.label("Текст сообщения"),$u.element("text").Label("Текст сообщения").AsHtmlEditor(200).Require(),$u.element("scope").Label("Доступ").AsSelect(n.scopeTypes).Tooltip("Если не указано, то везде"),t.prototype.$config.call(this),]})},i.prototype.$action=function(){return this.hide(),t.prototype.$action.call(this)},i.prototype.$clear=function(){this.form.clear({text:""})},i}($u.PopupView);n.CreateView=t}(messages||(messages={})),function(n){var t=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i.filter={},i.list=new $u.RefList,i.createMsgView=new n.CreateView(i).onAction(function(n){return i.add(n)}),i}return __extends(i,t),i.prototype.setDefaults=function(n){this.defaulVals=n},i.prototype.$config=function(){var t=this.list.config().extend({template:"http->"+It.Web.WebSource.base+"/html/message-list.html",type:{href:"#!",height:"auto",d:function(n){return webix.i18n.fullDateFormatStr(n.date)}}}).Editable(n.db.getSaveCfg(!0)).Scrollable(),i=$u.toolbar($u.label("Сообщения"),$u.button("Добавить").Popup(this.createMsgView.$config()),{});return $u.rows(i,t).Size(0,800)},i.prototype.refresh=function(){var t=n.db.list(this.filter);this.list.refresh(t)},i.prototype.add=function(n){this.defaulVals&&(n=webix.extend(n,this.defaulVals,!0));n.date=new Date;this.list.add(n,0);this.createMsgView.$clear()},i}($u.View);n.ListView=t}(messages||(messages={})),function(n){var t,r,i;(function(n){n[n.Any=0]="Any";n[n.Zone=1]="Zone";n[n.Private=2]="Private"})(t=n.ScopeType||(n.ScopeType={}));n.scopeTypes=[{id:t.Zone,value:"Партнер"},{id:t.Private,value:"Только я"},],function(n){n[n.Unknown=0]="Unknown";n[n.User=1]="User";n[n.System=2]="System";n[n.Error=3]="Error";n[n.Bitrix=4]="Bitrix";n[n.Review=5]="Review";n[n.Calendar=7]="Calendar";n[n.ViewRoom=8]="ViewRoom"}(r=n.MessageKind||(n.MessageKind={}));i=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t}(app.AppDataSource);n.db=new i("messages")}(messages||(messages={})),function(n){var t=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.form=new $u.RefForm,t}return __extends(t,n),t.prototype.$config=function(){n.prototype.$config.call(this);var t=this,i=$u.template('<div>Для получения доступа к системе бронирования обратитесь к администратору портала -&nbsp;<a href="mailto: partner@musbooking.com" target="_blank" rel="nofollow">partner@musbooking.com<\/a>&nbsp;или отправьте запрос на регистрацию, заполнив форму по адресу&nbsp;<a href="http://musbooking.com/zapros/" target="_blank" rel="nofollow">http://musbooking.com/zapros/<\/a><\/div>').Autoheight().Css("it-warning111"),r="Вход в "+"MUSBOOKING".link("http://musbooking.com/",{target:"_blank"}),u=this.form.config().extend({width:300,padding:10,borderless:!1,elements:[$u.cols($u.label(r.tag("div",{"class":"it-login-header"})),{gravity:.1},$u.icon("question").Popup(i)).Autoheight().Css("it-login-header"),{height:20},$u.template("img/logo-2018.png".img({"class":"it-login-img"}).link("./")),$u.cols($u.rows($u.element("login").Label("Логин").Value(It.Web.auth.logins.last).Require(),{height:7},$u.element("password").Label("Пароль").Type("password").Require(),{height:20})),$u.cols({},$u.button("Войти").Type("form").Click(function(){return t.login()}).Hotkey("enter"),$u.button("Закрыть").Click(It.Web.goReturnUrl)),],elementsConfig:{}});return $u.viewCenter(u)},t.prototype.login=function(){if(this.form.validate()){var n=this.form.values(),t=auth_logins.db.login(n);t&&(It.Web.auth.tokens.save(t.token),It.Web.auth.logins.save(n.login),It.Web.goReturnUrl())}},t}($u.View);n.LoginView=t}(access||(access={})),function(n){function i(){var n=new $u.Navigator;n.view.show();n.routers("access")}function r(){It.Web.auth.tokens.current&&n.dbauth.checkLogin()}n.run=i;n.create={"default":function(){return new n.LoginView},login:function(){return new n.LoginView},logout:function(){return It.Web.auth.tokens.clear(),new n.LoginView}};var t=function(n){function t(t){return n.call(this,t,"api/")||this}return __extends(t,n),t.prototype.login=function(){return this.load("login")},t.prototype.checkLogin=function(){return this.load("check",null)},t.prototype.context=function(){return this.load("context")},t}(app.AppDataSource);n.AuthSource=t;n.dbauth=new t("auth");n.checkLogin=r}(access||(access={})),function(n){n.oper={lists:"lists",listBases:"list-bases",equipments:"list-eq",eqRest:"eq-rest",promo:"promo",days:"days",orderPromo:"order-promo",statisticPromo:"statistic-promo",basesAll:"bases-all",cameras:"cameras",groups:"crm-lists",clients:"clients",clientFin:"client-fin",clientDiscBan:"l14",expGroups:"exp-groups",reviews:"reviews",crmView:"crm-view",crmEdit:"crm-edit",orders:"orders",orderNew:"order-new",orderFullAccess:"order-full",orderPay:"order-pay",orderPoints:"order-points",orderForfeit:"order-forfeit",orderEdit:"order-edit",orderEditHold:"order-edit-payd",orderEditGroup:"order-edit-group",orderHistory:"order-history",orderCancel:"order-cancel",orderCancelAny:"order-cancel-any",orderDelete:"order-delete",orderViewQuick:"order-view-quick",orderViewFull:"order-view-full",accounts:"accounts",anyReportDate:"accounts-all-dates",transEdit:"trans-edit",abonements:"abonements",abonementEdit:"ab-edit",abonementDel:"ab-del",abonementOrderEdit:"ab-order-edit",abonementOrderCalc:"ab-order-calc",abonementOrderCreate:"ab-order-create",orderReserv:"ab-order-reserv",abonementOrderPay:"ab-order-pay",expDocs:"exp-docs",expDocsAdmin:"exp-docs-admin",users:"users",domainsEdit:"domains-edit",anyIP:"any-ip",editIP:"ip-edit",domainsAll:"domains-all"};var t={lists:"Справочники",calendar:"Календарь",crm:"CRM",orders:"Бронь",account:"Учет и Отчеты",abonements:"Абонементы",admin:"Администрирование"};n.opers=[{id:n.oper.lists,value:"Настройка справочников",group:t.lists,description:"Общий доступ к редактированию справочников"},{id:n.oper.listBases,value:"Настройка баз и комнат",group:t.lists,description:"Редактирование справочника баз и комнат"},{id:n.oper.equipments,value:"Настройка позиций",group:t.lists,description:"Редактирование справочника позиций и типов позиций"},{id:n.oper.basesAll,value:"Доступ все базы",group:t.lists,description:"предоставление доступа к любой базе"},{id:n.oper.days,value:"Редактирование дат",group:t.lists,description:"редактирование праздничных дат для календаря","super":!0},{id:n.oper.promo,value:"Управление промокодами",group:t.lists,description:"Редактирование списков промокодов"},{id:n.oper.cameras,value:"Камеры",group:t.lists,description:"Доступ к камерам базы"},{id:n.oper.groups,value:"CRM справочники",group:t.lists,description:"Справочники CRM системы","super":!0},{id:n.oper.expGroups,value:"Статьи расходов",group:t.lists,description:"Ввод статей расходов для указания в расходных документах"},{id:n.oper.crmView,value:"CRM-справочники",group:t.crm,description:"Доступ к CRM справочниками","super":!0},{id:n.oper.crmEdit,value:"CRM-редактирование",group:t.crm,description:"Редактированиеs CRM данных","super":!0},{id:n.oper.clients,value:"Клиенты",group:t.crm,description:"Поиск и работа с карточками клиентов"},{id:n.oper.clientFin,value:"Финансы клиента",group:t.crm,description:"Редактирование финансовых параметров клиентов"},{id:n.oper.clientDiscBan,value:"Скидка, блок клиента",group:t.crm,description:"Редактирование полей скидки и блокировки клиентов"},{id:n.oper.orderEdit,value:"Редактирование календаря",group:t.calendar,description:"Открытие брони на редактирование в календаре"},{id:n.oper.orderViewQuick,value:"Краткий формат календаря",group:t.calendar,description:"Отображение минимальной информации по брони в календаре"},{id:n.oper.orderViewFull,value:"Полный формат календаря",group:t.calendar,description:"Отображение полной информации по брони в календаре"},{id:n.oper.orders,value:"Бронирование",group:t.orders,description:"Общие операции с бронью"},{id:n.oper.orderNew,value:"Создание брони",group:t.orders,description:"Возможность создания новых броней в календаре"},{id:n.oper.orderEditHold,value:"Редактирование опл. брони",group:t.orders,description:"Возможность редактирования оплаченной брони с пересчетом"},{id:n.oper.orderEditGroup,value:"Редактирование опций",group:t.orders,description:"Возможность редактирования опций"},{id:n.oper.orderHistory,value:"Просмотр истории",group:t.orders,description:"Просмотр истории бронирования"},{id:n.oper.orderPromo,value:"Выбор промокода",group:t.orders,description:"Редактирование промокода в карточке брони"},{id:n.oper.orderReserv,value:"Резерв брони",group:t.orders,description:"Резервирование брони"},{id:n.oper.orderCancel,value:"Отмена брони (правила)",group:t.orders,description:"Выставление статуса Отмены у брони"},{id:n.oper.orderCancelAny,value:"Отмена брони (любая)",group:t.orders,description:"Отмена брони без проверки правил"},{id:n.oper.orderPay,value:"Оплата брони",group:t.orders,description:"Выставление статуса Оплаты у брони"},{id:n.oper.orderForfeit,value:"Подтверждение штрафов",group:t.orders,description:"Подтверждение штрафа у брони"},{id:n.oper.orderPoints,value:"Списание баллов",group:t.orders,description:"Возможность списания баллов"},{id:n.oper.orderDelete,value:"Удаление брони",group:t.orders,description:"Удаление брони из списков и календаря","super":!0},{id:n.oper.orderFullAccess,value:"Любая операция с бронью",group:t.orders,description:"Возможность резервирования, редактирования и удаления брони в любом статусе, в т.ч и оплаченной"},{id:n.oper.reviews,value:"Отзывы по брони",group:t.orders,description:"Работа с отзывами клиента по брони"},{id:n.oper.accounts,value:"Движение денег",group:t.account,description:"Доступ к отчету о движении денег"},{id:n.oper.transEdit,value:"Редактирование транзакций",group:t.account,description:"Возможность просмотра и редактирования тразнакций","super":!0},{id:n.oper.anyReportDate,value:"Движение - любой период",group:t.account,description:"Возможность выставления любого периода в отчете о движении денег"},{id:n.oper.statisticPromo,value:"Статистика промокодов",group:t.account,description:"Отчет по статистике клиентов"},{id:n.oper.eqRest,value:"Остатки ооборудования",group:t.account,description:"Доступ к отчету об остатках оборудования на текущий момент"},{id:n.oper.expDocs,value:"Расходные документы",group:t.account,description:"Доступ к расходным документам"},{id:n.oper.expDocsAdmin,value:"Расходные документы (Полн)",group:t.account,description:"Полный доступ к редактированию расходных документов по базам"},{id:n.oper.abonements,value:"Абонементы",group:t.abonements,description:"Доступ к разделу 'Абонементы'"},{id:n.oper.abonementEdit,value:"Абон-Редактирование",group:t.abonements,description:"Редактирование данных абонемента"},{id:n.oper.abonementDel,value:"Абон-Удаление",group:t.abonements,description:"Удаление абонемента"},{id:n.oper.abonementOrderCreate,value:"Абон-Добавление брони",group:t.abonements,description:"Добавление брони в абонементах"},{id:n.oper.abonementOrderEdit,value:"Абон-Изменение брони",group:t.abonements,description:"Абонемент - изменение реквизитов брони в окне детальной информации"},{id:n.oper.abonementOrderCalc,value:"Абон-Пересчет брони",group:t.abonements,description:"Перерасчет брони в абонементе"},{id:n.oper.abonementOrderPay,value:"Абон-Оплата брони",group:t.abonements,description:"Оплата брони в абонементе"},{id:n.oper.users,value:"Настройка пользователей",group:t.admin,description:"Редактирование логинов пользователей"},{id:n.oper.domainsEdit,value:"Настройка партнеров",group:t.admin,description:"Редактирование настроек партнеров","super":!0},{id:n.oper.anyIP,value:"Доступ с любого IP",group:t.admin,description:"Настройка разрешений для доступа с любого компьютера"},{id:n.oper.editIP,value:"Настройки IP",group:t.admin,description:"Настройка фильтров IP"},{id:n.oper.domainsAll,value:"Все партнерские зоны",group:t.admin,description:"Доступ ко всем партнерским зонам","super":!0},];n.roles={"super":"super"}}(auth||(auth={})),function(n){function r(){if(n.context=new t,It.Web.auth.tokens.current){var i=n.dbsys.context();webix.extend(n.context,i,!0)}}var i=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.context=function(){return this.load("context")},t}(app.AppDataSource),t;n.dbsys=new i("system");t=function(){function n(){this.isSuper=!1;this.permissions={}}return n.prototype.allow=function(n){if(!this.permissions)return!1;var t=this.permissions[n];return t===!0},n.prototype.allowCrmEdit=function(){return!this.isSuper||this.allow(auth.oper.crmEdit)},n}();n.SystemContext=t;n.loadContext=r}(system||(system={})),function(n){var t=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t}(app.AppDataSource);n.PermissionsSource=t;n.db=new t("permissions2");n.create={grid:function(){return new n.GridView}}}(permissions||(permissions={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefTree,n.form=new $u.RefForm,n}return __extends(i,t),i.prototype.setGroup=function(n){if(n&&n.operation){var t=auth.opers.findById(n.operation);t&&(n.group=t.group,n.description=t.description)}},i.prototype.$config=function(){var i=this;t.prototype.$config.call(this);var u=this,r=!1,f=this.grid.configTreeTable().extend({columns:[$u.column("group").Header("Операция",-2).Template(function(n,t){return n.$group?t.treetable(n,t)+n.group:"          "+auth.opers.findById(n.operation,{}).value}),$u.column("operation").Header("Операция",100).Sort().Filter(),$u.column("roles").Header("Роли",-1).Sort().Edit().Filter(),$u.column("description").Header("Описание",-1),],scheme:{id:-1,$group:{by:"group",map:{votes:["votes","sum"],group:["group"]}},$init:function(n){return u.setGroup(n)}},save:n.db.getSaveCfg(!0)}).Editable(),e={view:"form",id:this.form.id,borderless:!0,gravity:.6,elements:[{cols:[$u.button("Сохранить").Click(function(){return i.save()}),{},]},$u.element("operation").Label("Операция","top").AsSelect(auth.opers).Disable(),$u.element("roles").Label("Роли","top").AsMultiSelect(roles.db.names()),$u.element("description").Label("Описание").AsTextArea(0).Disable(),{},]};return{rows:[$u.toolbar(this.grid.btnAdd().Hidden(!r),this.grid.btnDel().Hidden(!r),$u.button("Инициализировать").Click(function(){return i.initDomain()}),this.grid.btnRefresh(function(){return i.refresh()}),{}),{cols:[f,e,]},]}},i.prototype.$init=function(){this.form.bind(this.grid);this.refresh()},i.prototype.refresh=function(){var t=n.db.list();this.grid.refresh(t)},i.prototype.initDomain=function(){var n=system.context;domains.db.init(n.domainId,n.isSuper);this.refresh()},i.prototype.save=function(){this.form.ref.save()},i}($u.View);n.GridView=t}(permissions||(permissions={})),function(n){var t=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.names=function(){return t.load("names")},t}return __extends(t,n),t}(app.AppDataSource);n.RolesSource=t;n.db=new t("roles2");n.create={grid:function(){return new n.GridView}}}(roles||(roles={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n}return __extends(i,t),i.prototype.$config=function(){t.prototype.$config.call(this);var i=this.grid.config().extend({columns:[$u.column("name").Header("Имя роли",200).Sort().Edit().Filter(),$u.column("description").Header("Описания",-1).Sort().Edit().Filter(),],scheme:{id:-1},data:n.db.list(),save:n.db.getSaveCfg(!0)}).Editable();return $u.rows($u.toolbar(this.grid.btnAdd(),this.grid.btnDel(),{}),i)},i}($u.View);n.GridView=t}(roles||(roles={})),function(n){n.create={grid:function(){return new n.GridView}};var t=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.itemsUrl=t.url("list"),t}return __extends(t,n),t}(app.AppDataSource);n.db=new t("rules")}(rules||(rules={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n}return __extends(i,t),i.prototype.$config=function(){var i=this;t.prototype.$config.call(this);var r=$u.panelbar(this.grid.btnAdd(),this.grid.btnDel(),this.grid.btnRefresh(function(){return i.refresh()}),{}),u=this.grid.config().extend({columns:[$u.column("ip").Header("IP").Sort().Edit(),$u.column("description").Header("Описание",-1).Edit(),$u.column("isDisabled").Header("Арх").AsCheckbox().Sort().Edit(),],scheme:{},data:n.db.list(),save:n.db.getSaveCfg(!0)}).Editable();return $u.rows(r,u)},i.prototype.refresh=function(){var t=n.db.list();this.grid.refresh(t)},i}($u.View);n.GridView=t}(rules||(rules={})),function(n){var t=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.$config=function(){return this.form.config().extend({width:400,elements:[$u.element("login").Label("Логин").Require(),$u.element("password").Label("Пароль").AsPassword().Require(),$u.element("fio").Label("ФИО").AsTextArea(70),$u.element("email").Label("e-mail"),$u.element("roles").Label("Роли").AsMultiSelect(roles.db.names()),$u.element("baseIds").Label("Базы").AsMultiSelect(bases.db.names()),n.prototype.$config.call(this),]})},t.prototype.$action=function(){return this.hide(),n.prototype.$action.call(this)},t}($u.PopupView);n.CreateView=t}(users||(users={})),function(n){var t=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i.grid=new $u.RefGrid,i.form=new $u.RefForm,i.creator=(new n.CreateView).onAction(function(n){return i.create(n)}),i}return __extends(i,t),i.prototype.$config=function(){var i=this;t.prototype.$config.call(this);var r=this.grid.config().extend({columns:[$u.column("login").Header("Логин",-1).Sort().Filter(),$u.column("fio").Header("ФИО",-1).Sort().Filter(),$u.column("roles").Header("Роли",-1).Sort().Edit().Filter(),$u.column("isArchive").Header("Блок").Tooltip("Флаг блокировки клиента #login#").AsCheckbox().Sort(),],scheme:{id:-1},data:n.db.list(),save:n.db.getSaveCfg(!0)}).Editable(),u=this.form.config().extend({gravity:.7,elements:[{cols:[$u.button("Сохранить").Click(function(){return i.save()}),{},]},$u.element("login").Label("Логин").Disable(),$u.element("fio").Label("ФИО").AsTextArea(70),$u.element("email").Label("e-mail"),$u.element("roles").Label("Роли").AsMultiSelect(roles.db.names()),$u.element("baseIds").Label("Базы","top").AsMultiSelect(bases.db.namesUrl),$u.element("domainIds").Label("Партнеры","top").AsMultiSelect(domains.db.namesUrl).Visible(system.context.allow(auth.oper.domainsEdit)),$u.element("bitrixNum").Label("Код CRM").Tooltip("Внутренний код в CRM системе"),$u.element("isArchive").Label("Арх").AsCheckbox(),{},]});return $u.rows($u.toolbar($u.button("Добавить").Popup(this.creator.$config()),this.grid.btnDel(),$u.button("Пароль").Tooltip("Сгенерировать новый пароль для пользователя").Click(function(){return i.reset()}),{}),$u.cols(r,u))},i.prototype.$init=function(){this.form.bind(this.grid)},i.prototype.create=function(n){this.grid.add(n)},i.prototype.reset=function(){var t=this.grid.getSelectedItem(),i;if(!t)return webix.message("Выделите пользователя");if(!confirm("Сгенерировать новый пароль для пользователя ".concat(t.login,"?")))return webix.message("Сброс пароля отменен");i=n.db.resetUserPassword(t.id);webix.alert({title:"Генерация пароля для "+t.login,text:"Новый пароль: "+i.password})},i.prototype.save=function(){this.form.updateBindings()},i}($u.View);n.GridFormView=t}(users||(users={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n}return __extends(i,t),i.prototype.$config=function(){t.prototype.$config.call(this);var i=system.context.allowCrmEdit(),r=this.grid.config().extend({columns:[$u.column("login").Header("Логин",100).Sort().Edit(),$u.column("phone").Header("Телефон",100).Sort(),$u.column("email").Header("E-mail",-1).Sort(),$u.column("fio").Header("ФИО",-1).Sort().Edit(),$u.column("fcm").Header("Push ID").Sort().Edit(),$u.column("isConfirmed").Header("Подтв.",60).AsCheckboxReadly().Sort().Visible(!i),$u.column("isArchive").Header("Блок").Tooltip("Флаг блокировки клиента #login#").AsCheckboxReadly().Sort().Visible(!i)],scheme:{id:-1},save:n.db.getSaveCfg(!0)});return i&&r.Editable().Columns($u.column("isConfirmed").Header("Подтв.").AsCheckbox().Sort().Visible(i),$u.column("isArchive").Header("Блок").Tooltip("Флаг блокировки клиента #login#").AsCheckbox().Sort().Visible(i)),r},i.prototype.refresh=function(n){return this.grid.refresh(n),this},i}($u.View);n.GridView=t}(users||(users={})),function(n){var t=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.itemsUrl=t.url("list"),t.search=function(n){return t.load("search",{client:n})},t.resetUserPassword=function(n){return t.post("resetUser",{user:n})},t}return __extends(t,n),t}(app.AppDataSource);n.db=new t("users");n.create={grid:function(){return new n.GridFormView}}}(users||(users={})),function(n){function u(){var i=r.config();n.config=new t;webix.extend(n.config,i,!0)}var i=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.config=function(){return this.load("config")},t}(app.AppDataSource),r=new i("help"),t=function(){function n(){this.items=[{page:"test",text:"test",url:""},];this._current=this.items[0]}return n.prototype.current=function(n){return n?(this.items.find&&(this._current=this.items.find(function(t){return n.indexOf(t.page)>=0})),this._current):this._current},n}();n.HelpConfig=t;n.load=u}(help||(help={})),function(n){function r(i,r){r="Заявка "+r;i=t.Request+i;n.kinds.push({id:i,value:r});n.kinds.push({id:i+t.OrderDomain,value:r+" (Партнер)"});n.kinds.push({id:i+t.OrderService,value:r+" (Сервис)"})}function i(i,r){n.kinds.push({id:i+t.OrderBaseRequest,value:r+" (Заявка)"});n.kinds.push({id:i+t.OrderChannelCash,value:r+" (Наличные)"});n.kinds.push({id:i+t.OrderChannelInstruction,value:r+" (Инструкция)"});n.kinds.push({id:i+t.OrderChannelTinkoff,value:r+" (Тиньков)"})}var u,t;n.create={grid:function(){return new n.GridView},edit:function(){return new n.EditView}};u=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.names=function(n){return this.loadList("names",n)},t}(lists.DataSource);n.db=new u("templates");t=function(){function n(){}return n.Unknown="unknown",n.Code="code",n.Registration="registration",n.Restore="restore",n.Feedback="feedback",n.CheckEmailConfirmation="email-confirm",n.Manual="manual",n.OrderReserv="order.reserv",n.OrderPaid="order.paid",n.OrderCancel="order.cancel",n.OrderForfeit="order.forfeit",n.OrderClose="order.close",n.OrderError="order.error",n.Request="request",n.RequestNew=".new",n.RequestUnprocessed=".unprocessed",n.RequestConfirmed=".confirmed",n.RequestCanceled=".canceled",n.OrderDomain=".domain",n.OrderService=".service",n.OrderBaseRequest=".request",n.OrderChannelCash=".cash",n.OrderChannelTinkoff=".tinkoff",n.OrderChannelInstruction=".instruction",n.DomainRegistration="DomainRegistration",n.DomainYellow="DomainYellow",n.DomainBeforeBlock="DomainBeforeBlock",n.DomainAfterBlock="DomainAfterBlock",n.DomainPayment="DomainPayment",n.ClientForfeit="client.forfeit",n.ClientBanTrue="client.ban.true",n.ClientBanFalse="client.ban.false",n.CalendarArchive="calendar.archive",n}();n.TemplateKind=t;n.kinds=[{id:t.Code,value:"СМС Код"},{id:t.Registration,value:"Регистрация"},{id:t.Restore,value:"Восстановление"},{id:t.Feedback,value:"Обратная связь"},{id:t.CheckEmailConfirmation,value:"Подтверждение почты"},{id:t.Manual,value:"Ручная рассылка"},{id:t.OrderError,value:"Бронь ошибка"},{id:t.CalendarArchive,value:"Календарь - архивация"},{id:t.DomainRegistration,value:"Партнер-Регистрация"},{id:t.DomainYellow,value:"Партнер-Желтая"},{id:t.DomainBeforeBlock,value:"Партнер-Перед блок."},{id:t.DomainAfterBlock,value:"Партнер-После блок"},{id:t.DomainPayment,value:"Партнер-Оплата"},{id:t.ClientForfeit,value:"Клиент-изм.штрафа"},{id:t.ClientBanTrue,value:"Клиент-бан"},{id:t.ClientBanFalse,value:"Клиент-снятие бана"},{id:"review.new",value:"Отзыв-Новый"},{id:"review.processed",value:"Отзыв-Обработано"},{id:"review.ok",value:"Отзыв-Отвечено"},{id:"review.cancel",value:"Отзыв-Отмена"},];r(t.RequestNew,"новая");r(t.RequestCanceled,"отмена");r(t.RequestConfirmed,"подтверждение");r(t.RequestUnprocessed,"Не обработана");i(t.OrderReserv,"Резерв");i(t.OrderReserv+t.OrderDomain,"Резерв-Партнер");i(t.OrderPaid,"Оплата");i(t.OrderPaid+t.OrderDomain,"Оплата-Партнер");i(t.OrderCancel,"Отмена");i(t.OrderCancel+t.OrderDomain,"Отмена-Партнер");i(t.OrderForfeit,"Штраф");i(t.OrderForfeit+t.OrderDomain,"Штраф-Партнер");i(t.OrderClose,"Закрыт");i(t.OrderClose+t.OrderDomain,"Закрыт-Партнер")}(templates||(templates={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.form=new $u.RefForm,n}return __extends(i,t),i.prototype.$config=function(){return this.form.config().Labels(120).extend({elements:[$u.header("Список шаблонов рассылок"),$u.element("isArchive").Label("(x)").AsCheckbox(),$u.element("key").Label("Тип","top").AsSelect(n.kinds),$u.element("name").Label("Название","top").Require(),$u.element("description").Label("Описание").AsTextArea(100),$u.element("text").Label("Шаблон").AsHtml().Size(200,300),{},]})},i}($u.View);n.FormView=t}(templates||(templates={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n}return __extends(i,t),i.prototype.$config=function(){var i=this;t.prototype.$config.call(this);var r=this.grid.config().extend({columns:[$u.column("idd").Header("*",30).Template(Symbols.pencil.link("{common.href}/templates/edit/?oid=#id#")),$u.column("key").Header("Тип",250).AsSelect(n.kinds).Sort().Edit().Filter(),$u.column("name").Header("Название",-1).Sort().Edit().Filter(),$u.column("subject").Header("Заголовок",-1).Sort().Edit().Filter(),$u.column("description").Header("Описание",-1).Edit().Filter(),$u.column("isArchive").Header(Symbols.Cross).AsCheckbox().Sort().Filter(),],scheme:{},save:n.db.getSaveCfg(!0)}).Editable(),u=$u.panelbar(this.grid.btnAdd(),this.grid.btnDel(),this.grid.btnRefresh(function(){return i.reload()}),{});return $u.rows(u,r)},i.prototype.$init=function(){t.prototype.$init.call(this);this.reload()},i.prototype.reload=function(){var t=n.db.list();this.grid.refresh(t);webix.message($u.loc.Msg.Reloaded)},i}($u.View);n.GridView=t}(templates||(templates={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.form=new $u.RefForm,n}return __extends(i,t),i.prototype.$config=function(){var t=this;return this.form.config().Labels(120).extend({elements:[$u.header("Список шаблонов рассылок",$u.button("Сохранить").Click(function(){return t.save()})),$u.element("key").Label("Тип").AsSelect(n.kinds).Require(),$u.element("name").Label("Название").Require(),$u.element("description").Label("Описание").AsTextArea(100),$u.element("subject").Label("Заголовок"),$u.element("email").Label("Email (фикс)"),$u.element("sms").Label("Шаблон СМС").AsTextArea(150),$u.template("Шаблон письма"),$u.element("text").Label("Шаблон письма").AsHtml().Size(-1,600),$u.element("isArchive").Label("Архив").AsCheckbox(),{},]})},i.prototype.$reload=function(i){t.prototype.$reload.call(this,i);var r=n.db.get(i);r.text=r.text||"";this.form.setValues(r)},i.prototype.save=function(){this.form.validate()&&(this.form.save(n.db.saveUrl(this.objectId),!1),webix.message("Данные сохранены на сервере"))},i}($u.View);n.EditView=t}(templates||(templates={})),function(n){var i=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.list=function(n){return this.loadList("list",{id:n})},t}(app.AppDataSource),t;n.db=new i("jobs"),function(n){n[n.Unknown=0]="Unknown";n[n.Active=1]="Active";n[n.Pause=2]="Pause";n[n.Ok=10]="Ok";n[n.Error=11]="Error";n[n.Canceled=12]="Canceled"}(t=n.JobStatus||(n.JobStatus={}));n.statuses=[{id:t.Unknown,value:"(неизвестно)"},{id:t.Active,value:"Активно"},{id:t.Canceled,value:"Отменено"},{id:t.Error,value:"Ошибка"},{id:t.Ok,value:"ОК"},{id:t.Pause,value:"Пауза"},]}(jobs||(jobs={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.form=new $u.RefForm,n.editor=new $u.RefUI,n}return __extends(i,t),i.prototype.$config=function(){var n=this;return t.prototype.$config.call(this),this.form.config().extend({elements:[$u.label("Административные настройки").Size(-1),$u.cols($u.button("Обновить код Битрикс").Click(function(){return n.refreshToken()}),{}),this.ui_editor(),{},]})},i.prototype.ui_editor=function(){var n=this,t=$u.view("ace-editor").Ref(this.editor).extend({theme:"textmate",mode:"json"}).Size(0,400);return $u.rows($u.toolbar($u.label("Файл конфигурации"),{},$u.button("Обновить").Click(function(){return n.load()}),$u.button("Сохранить").Click(function(){return n.save()})),t)},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.first&&this.load()},i.prototype.load=function(){var t=n.dbsystem.getConfig(),i=JSON.stringify(t,null,"\t");this.editor.setValue(i)},i.prototype.save=function(){try{var i=this.editor.getValue(),r=JSON.parse(i);n.dbsystem.saveConfig(r);webix.message("Файл конфигурации сохранен на сервере")}catch(t){$u.w.error(t.name+": "+t.message)}},i.prototype.refreshToken=function(){if(confirm("Получить новый код Битрикс и записать в БД?")){var t="".concat(location.protocol,"//").concat(location.host),n="https://hendrix.bitrix24.ru/oauth/authorize/?client_id=local.56376c666ab472.43252042&response_type=code&redirect_uri=https://hendrix.musbooking.com/&scope=crm,entity";It.Web.openUrl(n,null,!0);alert("URL: "+n);webix.message("Новый авторизационный код битрикс успешно получен и сохранен: ")}},i}($u.View);n.SettingsView=t}(settings_ui||(settings_ui={})),function(n){n.create={edit:function(){return new n.SettingsView}};var t=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.getConfig=function(){return t.load("config")},t.saveConfig=function(n){return t.post("config",{data:n})},t}return __extends(t,n),t}(It.Web.WebSource);n.System2Source=t;n.dbsystem=new t("system")}(settings_ui||(settings_ui={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n.crform=new $u.RefForm,n.edform=new $u.RefForm,n}return __extends(i,t),i.prototype.$config=function(){var i=this,r,u;return t.prototype.$config.call(this),r=this.grid.config().extend({columns:[$u.column("name").Header("Параметр",-1).Sort().Edit(),$u.column("description").Header("Описание",-3).Sort().Edit(),$u.column("isArchive").Header("Арх").AsCheckbox().Sort().Edit(),],scheme:{id:-1},save:n.db.getSaveCfg(!0)}).Editable(),u=$u.rows($u.toolbar($u.icon("plus-circle").Popup(this.ui_create()),this.grid.btnDel(),this.grid.btnRefresh(function(){return i.reload()}),{},$u.button("Обновить сервер").Click(function(){return i.reset()})),$u.cols(r,this.ui_form())),u},i.prototype.$init=function(){this.edform.bind(this.grid)},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.first&&this.reload()},i.prototype.ui_form=function(){var n=this;return this.edform.config().extend({gravity:.7,elements:[$u.cols($u.button("Сохранить").Click(function(){return n.save()}),{}),$u.element("name").Label("Параметр"),$u.element("description").Label("Описание").AsTextArea(120),$u.element("isArchive").Label("Скрыть (архив)").AsCheckbox(),$u.element("asBool").Label("Флаг").AsCheckbox(),$u.element("asDate").Label("Дата").AsDate(),$u.element("asLong").Label("Целое").AsInt(),$u.element("asMoney").Label("Деньги").AsNumber(),$u.element("asNumber").Label("Число").AsNumber(),$u.element("asText").Label("Текст").AsTextArea(100),$u.element("asVal").Label("Партнеры","top").AsMultiSelect(domains.db.names()),$u.element("asVal1").Label("Источники","top").AsMultiSelect(orders.sourceTypes),$u.element("asVal2").Label("Базы (только чтение)","top").AsTextArea(150).Readonly(),$u.element("asVal3").Label("Комнаты","top").AsTextArea(150),{},]})},i.prototype.ui_create=function(){var n=this;return this.crform.config().extend({gravity:.7,elements:[$u.element("name").Label("Параметр","top"),$u.element("description").Label("Описание").AsTextArea(70),{},$u.cols({},$u.button("Создать").Click(function(){return n.create()})),]})},i.prototype.create=function(){var n=this.crform.values();this.grid.add(n);this.crform.clear()},i.prototype.save=function(){this.edform.updateBindings()},i.prototype.reload=function(){var t=n.db.list();this.grid.refresh(t)},i.prototype.reset=function(){n.db.reset();webix.message("Параметры обновлены")},i}($u.View);n.GridFormView=t}(configs||(configs={})),function(n){var t=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.list=function(){return t.loadList("list")},t.reset=function(){return t.post("reset")},t}return __extends(t,n),t}(app.AppDataSource);n.db=new t("configs");n.create={grid:function(){return new n.GridFormView}}}(configs||(configs={})),function(n){var t=function(t){function i(){return t!==null&&t.apply(this,arguments)||this}return __extends(i,t),i.prototype.$config=function(){return this.form.config().Labels(100).extend({width:400,elements:[$u.label("Синхронизация с календарем".tag("strong")).Css("webix_toolbar"),$u.element("provider").Label("Источник").AsSelect(n.calendarSources).Require(),$u.element("roomId").Label("Комната").AsSelect(rooms.db.names(null,!0)).Require(),t.prototype.$config.call(this),]})},i.prototype.$action=function(){if(this.form.validate())return this.hide(),t.prototype.$action.call(this),this.$clear(),!0},i.prototype.$clear=function(){t.prototype.$clear.call(this)},i}($u.PopupView);n.CreateView=t}(calendars||(calendars={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.form=new $u.RefForm,n.toolbar=new $u.RefUI,n.onCalendarLink=new It.Event,n}return __extends(i,t),i.prototype.$config=function(){var i=this,r,u;return t.prototype.$config.call(this),r=this.form.config().extend({elementsConfig:{labelWidth:80},elements:[$u.element("provider").Label("Источник").AsSelect(n.calendarSources).Disable(),$u.element("name").Label("Календарь").AsSelect([]),$u.element("minDate").Label("Обновлено").AsDate(!0).Tooltip("Дата последней синхронизации").Disable(),$u.element("roomId").Label("Комната").AsSelect(rooms.db.names(null,!0)),$u.element("timeZone").Label("Час.пояс").AsSelect(common.timeZones),$u.element("isArchive").Label("На паузе").AsCheckbox(),$u.element("watchStatus").Label("Push").AsSelect(n.watch_statuses).Readonly(),$u.element("watchResult").Label("Push result").AsTextArea(100).Readonly(),$u.element("attempts").Label("Попыток").Readonly(),$u.element("description").Label("Описание").AsTextArea(100),],on:{onBindApply:function(n){return i.reload(n)}}}),u=$u.rows($u.panelbar({},$u.button("Связать").Click(function(){return i.link()}),$u.button("Тест").Click(function(){return i.test()}),$u.button("Сохранить").Click(function(){return i.save()})).Ref(this.toolbar),r,{}),u},i.prototype.bind=function(n){this.form.bind(n)},i.prototype.reload=function(n){if(!n)return this.enable(!1);t.prototype.$reload.call(this,n.id);this.enable(n.provider);var i=n.calendars||[];this.form.setElement(this.form.elements.name,{options:i})},i.prototype.enable=function(n){this.form.enable(n);this.toolbar.enable(n)},i.prototype.save=function(){return this.form.validate()?(this.form.updateBindings(),!0):!1},i.prototype.link=function(){var r=this,t,i;this.save()&&(t=this.form.values(),i=n.oauth2.authUrl(t.id,t.provider),setTimeout(function(){return It.Web.openUrl(i,null,!0)},100),webix.alert("Нажмите ОК для обновления связанных календарей",function(){return r.onCalendarLink.call()}))},i.prototype.test=function(){if(this.save()){var t=n.db.test(this.objectId)||[];alert("Результат синхронизации: "+t)}},i}($u.View);n.EditView=t}(calendars||(calendars={})),function(n){var t=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i.grid=new $u.RefGrid,i.createForm=new n.CreateView(i).onAction(function(n){return i.create(n)}),i.editForm=new n.EditView(i),i}return __extends(i,t),i.prototype.$config=function(){var i=this;t.prototype.$config.call(this);var r=this.grid.config().extend({columns:[$u.column("isArchive").Header("[x]").AsCheckboxReadly(),$u.column("provider").Header("Источник",120).AsSelect(n.calendarSources),$u.column("description").Header("Описание",-1),$u.column("roomId").Header("Комната",100).AsSelect(rooms.db.names()),$u.column("minDate").Header("Обновлен",-1).AsDate(webix.i18n.fullDateFormatStr),$u.column("watchStatus").Header("Push").AsSelect(n.watch_statuses),$u.column("attemtps").Header("Попыток").AsInt(),],scheme:{},save:n.db.getSaveCfg(!0)}).Editable(),u=$u.panelbar($u.icon("plus-circle").Popup(this.createForm.$config()).Tooltip("Добавить календарь"),this.grid.btnDel(),this.grid.btnRefresh(function(){return i.reload()}),$u.icon("cloud-download").Click(function(){return i.sync()}).Tooltip("Синхронизировать выделенные календари"),$u.icon("cloud-upload").Click(function(){return i.sync(!0)}).Tooltip("Тестировать PUSH-синхронизацию для выделенных календарей"),{}),f=$u.rows(u,$u.cols(r,$u.splitter(),this.editForm.$config().Size(380)));this.editForm.onCalendarLink.on(function(){return i.reload()});return f},i.prototype.$init=function(){t.prototype.$init.call(this);this.editForm.bind(this.grid)},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.reload()},i.prototype.reload=function(){var t=n.db.list();this.grid.refresh(t)},i.prototype.create=function(n){var t=this.grid.add(n)},i.prototype.sync=function(t){t===void 0&&(t=!1);var i=this.grid.getSelectedIds(),r=n.db.sync({ids:i,last:t});this.reload();alert("Календарь успешно обновлен с результатом: "+r)},i}($u.View);n.GridView=t}(calendars||(calendars={})),function(n){var t=function(t){function i(){return t!==null&&t.apply(this,arguments)||this}return __extends(i,t),i.prototype.$config=function(){var n=this;return t.prototype.$config.call(this),$u.rows($u.panelbar($u.button("Синхронизировать календари").Click(function(){return n.sync()}),{}),{height:1})},i.prototype.$reload=function(n){t.prototype.$reload.call(this,n)},i.prototype.sync=function(){var t=n.db.sync({domain:this.objectId});alert("Результат синхронизации: "+t)},i}($u.View);n.SyncView=t}(calendars||(calendars={})),function(n){var i,r,t;n.create={grid:function(){return new n.GridView}};n.calendarSources=[{id:"google",value:"Google календарь"},{id:"microsoftOnline",value:"Outlook календарь"},];i=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.list=function(n){return this.load("list",n)},t.prototype.sync=function(n){return this.loadStr("sync",n)},t.prototype.test=function(n){return this.loadStr("test",{id:n})},t}(app.AppDataSource);n.db=new i("calendars");r=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.authUrl=function(n,i){return t.url("authorize",{id:n,provider:i})},t}return __extends(t,n),t}(app.AppDataSource);n.oauth2=new r("oauth2"),function(n){n[n.Unknown=0]="Unknown";n[n.Error=1]="Error";n[n.Stop=3]="Stop";n[n.Active=10]="Active"}(t=n.WatchStatus||(n.WatchStatus={}));n.watch_statuses=[{id:t.Unknown,value:""},{id:t.Stop,value:"Стоп"},{id:t.Active,value:"Включено"},{id:t.Error,value:"Ошибки"},]}(calendars||(calendars={})),function(n){n.create={};n.types=[{id:"abonement",value:"Абонемент"},{id:"order",value:"Заказ"},];var t=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.list=function(n){return this.load("list",n)},t}(app.AppDataSource);n.db=new t("docs")}(docs||(docs={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.filter={},n.grid=new $u.RefGrid,n.filterView=new $u.RefForm,n}return __extends(i,t),i.prototype.$config=function(){var t=this,i=this.grid.config().extend({columns:[$u.column("idd").Header("",30).Template($u.getViewLink("#type#s")),$u.column("type").Header("Документ",90).AsSelect(n.types).Filter().Sort(),$u.column("date").Header("Дата").AsDate(webix.i18n.dateFormatStr).Sort().Filter(),$u.column("total").Header("Сумма").AsInt().Sort().Filter().Footer({content:"summColumn"}),$u.column("forfeit").Header("Штрафы").AsInt().Sort().Filter().Footer({content:"summColumn"}),$u.column("text").Header("Описание",-1).Filter(),$u.column("clientComment").Header("Комментарий",-1).Filter(),$u.column("status").AsSelect(orders.statuses).Header("Статус",100).Sort().Filter(),],scheme:{name:"без имени",$init:function(n){orders.logic.getStateCss(n)}}}).Tooltip("<b>Описание и комментарий:<\/b><br/><blockquote>#text#<hr/>#clientComment#<\/blockquote>").Footer().Autoheight(),r=this.filterView.config().extend({cols:[$u.label("Список документов"),$u.element("dfrom").Label("Дата с:",null,60).AsDate().Size(180),$u.element("dto").Label("По:",null,40).AsDate().Size(160),$u.icon("refresh").Click(function(){return t.refresh()}),{}]});return $u.rows(r,i)},i.prototype.$init=function(){t.prototype.$init.call(this);var n=new Date;this.filterView.setValuesEx({dfrom:n,dto:n.addDays(7)})},i.prototype.refresh=function(){var t=webix.extend(this.filter,this.filterView.values(),!0),i=n.db.list(t);this.grid.refresh(i)},i}($u.View);n.GridView=t}(docs||(docs={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.form=new $u.RefForm,n.grid=new $u.RefGrid,n.messagesView=new messages.ListView(n),n}return __extends(i,t),i.prototype.$config=function(){var r=this;t.prototype.$config.call(this);this.groups=groups.db.names(groups.GroupType.Expense,!0);var u=$u.rows($u.toolbar(this.grid.btnAdd(),this.grid.btnDel(),$u.label("Распределение по статьям, сохраняются по кнопке 'Сохранить'").Size(-1),{}),this.grid.config().extend({columns:[$u.column("groupId").Header("Статья",200).AsSelect(this.groups).Edit(),$u.column("amount").Header("Стоимость",100).Edit().Footer({content:"summColumn"}),$u.column("description").Header("Описание",-1).Edit(),],scheme:{},rules:{groupId:webix.rules.isNotEmpty}}).Editable(n.itemsdb.getSaveCfg(!1)).Footer()),i=system.context.allow(auth.oper.expDocsAdmin);return this.form.config().Labels(100).extend({elements:[$u.cols($u.button("Сохранить").Click(function(){return r.save()}),{}),$u.element("baseId").Label("База").AsSelect(bases.db.names(!0)).Require(null,!i).Css("it-warning"),$u.element("date").Label("Дата").AsDate().Disable(!i).Css("it-warning"),$u.cols($u.element("isPublic").Label("Отразить в отчетах").AsCheckbox(!0).Tooltip("Расходы проведены для отражения в статистике").Css("it-warning"),$u.element("isArchive").Label("Архив").AsCheckbox(!0)),$u.element("description").Label("Описание").AsTextArea(100),$u.tabview().Tab("Статьи",u).Tab("История",this.messagesView.$config()).Autoheight()]})},i.prototype.$reload=function(i){t.prototype.$reload.call(this,i);var r=this.form.load(n.db.getUrl(i)),u=r.items;this.grid.refresh(u);this.grid.scheme({expenseId:i,groupId:this.groups.length>0?this.groups[0].id:null});this.messagesView.filter.expense=i;this.messagesView.refresh();this.messagesView.setDefaults({expenseId:i})},i.prototype.save=function(){if(this.form.validate())this.grid.save(),this.form.save(n.db.saveUrl(this.objectId),!1),webix.message("Данные сохранены на сервере")},i}($u.View);n.EditView=t}(expenses||(expenses={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.filterForm=new $u.RefForm,n.grid=new $u.RefGrid,n}return __extends(i,t),i.prototype.$config=function(){var r=this;t.prototype.$config.call(this);var u=this.grid.config().extend({scrollAlignY:!0,leftSplit:3,columns:[$u.column("id").Header("*",30).Template(Symbols.pencil.link("{common.href}/expenses/edit/?oid=#id#")),$u.column("date").Header("Дата").AsDate().Sort().Filter(),$u.column("baseId").Header("База",200).AsSelect(bases.db.names(!1)).Sort().Filter(),$u.column("isPublic").Header("Отч").AsCheckboxReadly().Sort(),$u.column("isArchive").Header("Арх").AsCheckboxReadly().Sort(),$u.column("totals").Header("Расход",65),$u.column("login").Header("Пользователь",170).Sort().Filter(),$u.column("description").Header("Описание",200).Sort().Filter(),$u.column("details").Header("Позиции",900).Sort().Filter(),],scheme:{id:-1,name:"новый элемент"},save:n.db.getSaveCfg(!0)}).Editable(),i=orders.logic.allowAnyReportDay(),f=this.filterForm.config().extend({cols:[this.grid.btnAdd(),$u.element("dfrom").Label("Дата с",null,50).Size(170).AsDate().Disable(!i),$u.element("dto").Label("По",null,40).Size(170).AsDate().Disable(!i),this.grid.btnRefresh(function(){return r.refresh()}),{},]});return $u.rows(f,u)},i.prototype.$init=function(){t.prototype.$init.call(this);var n=new Date(Date.now());n=webix.Date.weekStart(n);this.filterForm.setValuesEx({dfrom:n,dto:n.addDays(6)})},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.refresh()},i.prototype.refresh=function(){var t=this.filterForm.values(),i=n.db.list_items(t.dfrom,t.dto);this.grid.refresh(i)},i}($u.View);n.GridView=t}(expenses||(expenses={})),function(n){var t,i;n.create={grid:function(){return new n.GridView},edit:function(){return new n.EditView}};t=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.list_items=function(n,i){return t.list({dateFrom:n,dateTo:i})},t}return __extends(t,n),t}(app.AppDataSource);n.db=new t("expenses");i=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.list_items=function(n){return t.list(n)},t}return __extends(t,n),t}(app.AppDataSource);n.itemsdb=new i("expitems")}(expenses||(expenses={})),function(n){var t=function(t){function i(){return t!==null&&t.apply(this,arguments)||this}return __extends(i,t),i.prototype.$config=function(){var n=this;return this.form.config().extend({width:400,elements:[$u.element("fio").Label("ФИО").Require(),$u.element("email").Label("E-mail").Require(),$u.element("phone").Label("Телефон с кодом +7").Require(),$u.element("mobPhone").Label("Мобильный тел.  +7").Tooltip("Для уточнения данных по заказу"),$u.element("tarifName").Label("Тариф").Readonly().Css("it-warning"),$u.element("price").Label("Цена в мес").Readonly(),$u.element("count").Label("Кол-во месяцев").AsCounter(1,24).Value(1).OnChange(function(){return n.recalc()}).Error("Кол-во мес от 1 до 24"),$u.element("comm").Label("Комиссия начисл.").Readonly(),$u.element("total").Label("Сумма к оплате").Css("it-warning").Readonly().Require().Error("Введите кол-во месяцев для расчета оплаты"),$u.element("agree").Label("Согласен с условиями "+"лицензии".link("./docs/license.html",{target:"_blank"})).AsCheckbox(!0).Error("Требуется согласие с условиями лицензии"),$u.element("offerta").Label("Согласен с условиями "+" договора-оферты".link("./docs/offerta.html",{target:"_blank"})).AsCheckbox(!0).Error("Требуется согласие с условиями оферты"),$u.element("direct").Label("Прямая оплата").AsCheckbox().Visible(system.context.allow(auth.oper.domainsEdit)).Tooltip("Оплатить напрямую минуя платежный сервис (для администраторов)"),t.prototype.$config.call(this,"Оплатить "),],rules:{total:function(n){return n>0},count:function(n){return n>0&&n<=24},agree:function(n){return n==!0},offerta:function(n){return n==!0},email:webix.rules.isEmail}})},i.prototype.load=function(n){this.id&&this.id===n.id||(n.count=1,this.form.setValuesEx(n),this.recalc())},i.prototype.recalc=function(){var n=this.form.values();n.total=n.count*parseInt(n.price)+parseInt(0+n.comm);this.form.setValuesEx({total:n.total})},i.prototype.invokeAction=function(){var i=this.form.values(),r;i.text="Оплата по тарифу ".concat(i.tarifName,": фикс.цена ").concat(i.price," р./мес за ").concat(i.count," мес. + начисленная моб.комиссия ").concat(i.comm," р., на общую сумму ").concat(i.total);r=i.direct?n.testdb.payment(i):n.paymentdb.payment(i);t.prototype.invokeAction.call(this,i);this.$clear();this.hide();r?r.error?It.UI.w.error("Ошибка платежа: "+r.error):r.url&&r.status==307&&It.Web.openUrl(r.url,undefined,!0):alert("Платеж успешно проведен")},i.prototype.$clear=function(){this.form.setValuesEx({total:"",count:""})},i}($u.PopupView);n.CreatePayView=t}(paydocs||(paydocs={})),function(n){var t=function(){function t(){this.list=new $u.RefList}return t.prototype.config=function(n){var t=this.list.config().extend({template:"http->"+It.Web.WebSource.base+"/html/invoice-list.html",type:{href:"#!",height1:"auto",height:160},select:!1}).Size();return n&&(t=t.extend(n)),t},t.prototype.reload=function(t){var i=n.db.getInvoices({domain:t});this.list.refresh(i)},t}();n.InvoicesList=t}(paydocs||(paydocs={})),function(n){var t=function(){function t(){this.grid=new $u.RefGrid}return t.prototype.config=function(){return this.grid.config().extend({columns:[$u.column("isCompleted").Header("Опл").AsCheckboxReadly(),$u.column("date").Header("Дата").AsDate(),$u.column("mobComm").Header("Комиссия").AsInt(),$u.column("total").Header("Сумма").AsInt(),$u.column("fio").Header("ФИО",200),$u.column("text").Header("Описание",-1),],scheme:{name:"без имени"}})},t.prototype.reload=function(t){var i=n.db.getItems({domain:t});this.grid.refresh(i)},t}();n.PayDocsGrid=t}(paydocs||(paydocs={})),function(n){var i=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.getItems=function(n){return this.load("list",n)},t.prototype.getInvoices=function(n){return this.load("invoices",n)},t.prototype.recalc=function(n){return this.post("recalc",{domain:n})},t}(app.AppDataSource),t;n.db=new i("paydocs");t=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.payment=function(n){return this.post("payment",n)},t}(app.AppDataSource);n.paymentdb0=new t("payonline");n.paymentdb=new t("tinkoff");n.testdb=new t("paytest")}(paydocs||(paydocs={})),function(n){var t,i;n.create={grid:function(){return new n.GridView},form:function(){return new n.FormView}},function(n){n[n.Cash=1]="Cash";n[n.Instruction=2]="Instruction";n[n.Tinkoff=3]="Tinkoff"}(t=n.PayChannelKind||(n.PayChannelKind={}));n.kinds=[{id:t.Cash,value:"Наличными"},{id:t.Instruction,value:"По инструкции"},{id:t.Tinkoff,value:"Тинькофф"},];i=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.itemsUrl=t.url("list"),t.names=function(){return t.load("names")},t}return __extends(t,n),t}(app.AppDataSource);n.db=new i("paychannels")}(paychannels||(paychannels={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.form=new $u.RefForm,n}return __extends(i,t),i.prototype.$config=function(){t.prototype.$config.call(this);return this.form.config().extend({width:400,elements:[$u.element("name").Label("Имя").Require(),$u.element("prepayUrl").Label("Ссылка на предоплату","top"),$u.element("kind").Label("Тип").AsSelect(n.kinds),$u.element("forfeit1").Label("Штраф мин").AsInt(),$u.element("forfeit2").Label("Штраф макс").AsInt(),$u.element("total1").Label("Итог мин").AsInt(),$u.element("total2").Label("Итог макс").AsInt(),$u.element("sources").Label("Источник").AsMultiSelect(orders.sourceTypes),$u.element("partPc").Label("% от итога").AsInt(),$u.element("isForfeits").Label("Для штрафа").AsCheckbox(),$u.element("description").Label("Описание").AsTextArea(100),$u.element("isArchive").Label("Архив").AsCheckbox(),{},]})},i.prototype.prepay=function(n){this.form.enable(n,"prepayUrl")},i}($u.View);n.FormView=t}(paychannels||(paychannels={})),function(n){var t=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i.grid=new $u.RefGrid,i.formview=n.create.form().owner(i),i}return __extends(i,t),i.prototype.$config=function(){var i=this,r,u;return t.prototype.$config.call(this),r=this.grid.config().extend({columns:[$u.column("name").Header("Название",200).Sort().Sort(),$u.column("kind").Header("Тип").AsSelect(n.kinds),$u.column("description").Header("Описание",-1),$u.column("isArchive").Header("Арх").AsCheckboxReadly().Sort(),],scheme:{id:-1,name:"без имени"},save:n.db.getSaveCfg(!0)}).Editable(),u=$u.rows($u.toolbar(this.grid.btnAdd(),this.grid.btnDel(),this.grid.btnRefresh(function(){return i.$reload()}),{},$u.icon("save").Click(function(){return i.formview.form.updateBindings()})),$u.cols(r,$u.splitter(),this.formview.$config().Size(300))),u},i.prototype.$init=function(){t.prototype.$init.call(this);this.formview.form.bind(this.grid)},i.prototype.$reload=function(i){t.prototype.$reload.call(this,i);var r=n.db.list();this.grid.refresh(r)},i}($u.View);n.GridView=t}(paychannels||(paychannels={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n.filterForm=new $u.RefForm,n}return __extends(i,t),i.prototype.$config=function(){var u=this,e;t.prototype.$config.call(this);var r=system.context.allowCrmEdit(),i=160,o=n.db.groups(1),s=n.db.groups(2),h=n.db.groups(3),f=this.grid.config().extend({scrollAlignY:!0,scrollX:!0,leftSplit:2,columns:[$u.column("date").Header("Дата").AsDate(webix.i18n.fullDateFormatStr).Sort().Edit(),$u.column("total").AsInt().Header("Стоимость",70).AsInt().Sort().Footer({content:"summColumn"}).Edit(),$u.column("register").Header("Регистр",i).AsSelect(o).Sort().Filter().Edit(),$u.column("operation").Header("Операция",i).AsSelect(s).Sort().Filter().Edit(),$u.column("details").Header("Детали",i).AsSelect(h).Sort().Filter().Edit(),$u.column("sphere").Header("Сфера",i).Sort().Filter(),$u.column("domain").Header("Партнер",i).Sort().Filter(),$u.column("base").Header("База",i).Sort().Filter(),$u.column("room").Header("Комната",i).Sort().Filter(),$u.column("orderId").Header("Бронь",50).Template($u.getViewLink("orders","(...)","#orderId#")),$u.column("text").Header("Комментарий",i*3).Edit(),],save:n.db.getSaveCfg(!0),scheme:{}}).Footer();return r&&f.Editable(),e=this.filterForm.config().extend({cols:[r?this.grid.btnAdd():$u.label(""),r?this.grid.btnDel():$u.label(""),$u.label("Фильтр"),$u.element("dfrom").Label("Дата с:",null,60).AsDate().Size(180),$u.element("dto").Label("По:",null,40).AsDate().Size(160),this.grid.btnRefresh(function(){return u.reload(u.filter)}),{}]}),$u.rows(e,f).Min(-1,400)},i.prototype.$init=function(){t.prototype.$init.call(this);var n=new Date;!this.filterForm.ref||this.filterForm.setValuesEx({dfrom:n.addDays(-7),dto:n})},i.prototype.reload=function(t){this.filter=t;var i=this.filterForm.values(),r={client:t.clientId,order:t.orderId,dfrom:i.dfrom,dto:i.dto},u=n.db.search(r);this.grid.refresh(u);this.grid.scheme(t)},i}($u.View);n.PartGridView=t}(trans||(trans={})),function(n){var t=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i.grid=new $u.RefGrid,i.form=n.create.form(),i}return __extends(i,t),i.prototype.$config=function(){var i=this,r,u;return t.prototype.$config.call(this),r=this.grid.config().extend({columns:[$u.column("hasTarifs").Header("Подтариф").AsCheckboxReadly().Sort(),$u.column("name").Header("Тариф",-1).Sort(),$u.column("description").Header("Описание",-2).Sort(),$u.column("price").Header("Фикс.цена").AsInt().Sort().Tooltip("Фиксированная цена"),$u.column("destKind").Header("Назначение",100).AsSelect(equipments.destKinds),$u.column("isPayment").Header("Опл").AsCheckboxReadly().Sort(),$u.column("isArchive").Header("Арх").AsCheckboxReadly().Sort(),],scheme:{name:"новый тариф",price:0,commission:0,months:0},data:n.db.list(),save:n.db.getSaveCfg(!0)}).Editable(),u=$u.rows($u.panelbar(this.grid.btnAdd(),this.grid.btnDel(),this.grid.btnRefresh(function(){return i.refresh()}),{},$u.icon("save").Click(function(){return i.form.form.updateBindings()}).Tooltip($u.loc.Tooltips.Save)),$u.cols(r,$u.splitter(),this.form.$config().Size(300))),u},i.prototype.$init=function(){t.prototype.$init.call(this);this.form.form.bind(this.grid)},i.prototype.refresh=function(){var t=n.db.list();this.grid.refresh(t)},i}($u.View);n.GridView=t}(tarifs||(tarifs={})),function(n){n.create={grid:function(){return new n.GridView},form:function(){return new n.FormView}};var t=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.itemsUrl=t.url("list"),t.names=function(){return t.load("names")},t}return __extends(t,n),t}(app.AppDataSource);n.db=new t("tarifs")}(tarifs||(tarifs={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.form=new $u.RefForm,n}return __extends(i,t),i.prototype.$config=function(){return this.form.config().Labels(120).extend({elements:[$u.header("Редактор тарифа"),$u.element("name").Label("Название","top").Require(),$u.element("description").Label("Описание").AsTextArea(100),$u.element("price").Label("Фикс.цена").AsInt().Tooltip("Фиксированная цена"),$u.element("price1").Label("Цена 1 бронь").AsInt().Tooltip("Цена за 1 бронирование"),$u.element("commission").Label("% ком").AsInt().Tooltip("% комиссии за резервирование"),$u.element("payCommission").Label("% ком опл.").AsInt().Tooltip("% комиссии за оплаченный"),$u.element("tarifIds").Label("Подтарифы","top").AsMultiSelect(n.db.names()).Tooltip("Вложенные тарифы"),$u.element("sphereIds").Label("Сферы","top").AsMultiSelect(spheres.db.names()).Tooltip("Вложенные тарифы"),$u.element("destKind").Label("Назначение").AsSelect(equipments.destKinds),$u.element("isArchive").Label("Архив (скрыть)").AsCheckbox(!0),{},]})},i}($u.View);n.FormView=t}(tarifs||(tarifs={})),function(n){function u(n){if(n.limitDate){var t=It.dateDiff.inDays(n.limitDate);t>7?n.$css="it-error":t>0&&(n.$css="it-warning")}}var r,i,t;n.create={grid:function(){return new n.GridView},reg:function(){return new n.RegView},edit:function(){return new n.EditView},service:function(){return new n.EditView}};r=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.itemsUrl=t.url("list"),t.job=function(){return t.load("job")},t.names=function(){return t.load("names")},t.namesUrl=t.url("names"),t}return __extends(t,n),t.prototype.init=function(n,t){var i=auth.opers,r,u;return t||(i=i.filter(function(n){return n.super!==!0})),r=i.map(function(n){return n.id}),u=this.post("init",{id:n,operations:r,role:auth.roles.super}),u},t.prototype.reset=function(n){return this.post("reset",{id:n})},t.prototype.registry=function(n){return this.post("registry",n)},t}(app.AppDataSource);n.db=new r("domains"),function(n){n[n.ByCreateDate=1]="ByCreateDate";n[n.ByServiceDate=2]="ByServiceDate"}(i=n.PeriodKind||(n.PeriodKind={}));n.periods=[{id:i.ByCreateDate,value:"По дате создания"},{id:i.ByServiceDate,value:"По дате брони"},],function(n){n[n.Unknown=0]="Unknown";n[n.Payment=1]="Payment";n[n.Warning=10]="Warning";n[n.PredLock=20]="PredLock";n[n.Locked=30]="Locked";n[n.Mamual=100]="Mamual";n[n.New=101]="New"}(t=n.DomainStatus||(n.DomainStatus={}));n.statuses=[{id:t.Payment,value:"Оплачено"},{id:t.Warning,value:"Предупреждение"},{id:t.PredLock,value:"Предблок"},{id:t.Locked,value:"Блок"},{id:t.Mamual,value:"Ручной"},{id:t.New,value:"Новый"},];n.domain_css=u}(domains||(domains={})),function(n){var t=function(){function t(){this.form=new $u.RefForm}return t.prototype.config=function(){return this.form.config().extend({elements:[$u.element("name").Label("Зона доступа"),$u.element("cityId").Label("Город").AsSelect(groups.db.names(groups.GroupType.City)),$u.element("email").Label("E-mail партнера").AsTextArea(70).Tooltip("Список почтовых адресов, разделенных ;"),$u.element("phone").Label("Телефоны партнера").AsTextArea(70).Tooltip("Список телефонов, разделенных ;"),$u.element("isArchive").Label("Архивная").AsSwitch(),$u.element("createDate").Label("Создано").AsDate().Readonly(),$u.element("initDate").Label("Инициализирована").AsDate().Readonly(),$u.element("tarifId").Label("Текущий тариф","top").AsSelect(tarifs.db.names()),$u.element("period").Label("Граница даты","top").AsSelect(n.periods).Require(),$u.element("isPayment").Label("Только для оплат").AsSwitch(),$u.element("terminal").Label("ИД Терминала"),$u.element("inn").Label("ИНН"),$u.element("status").Label("Статус").AsSelect(n.statuses),$u.element("limitDate").Label("Срок").AsDate(),$u.element("tarifIds").Label("Доступные тарифы","top").AsMultiSelect(tarifs.db.names()),$u.element("spheres").Label("Сферы","top").AsTextArea(80).Disable(),$u.element("paysTotal").Label("Оплаты").Readonly(),$u.element("owners").Label("Ответственные").AsTextArea(80).Disable(),$u.element("description").Label("Описание").AsTextArea(80),{},]})},t}();n.EditForm=t}(domains||(domains={})),function(n){var t=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i.headers=new $u.RefTemplate,i.template=new $u.RefTemplate,i.docsGrid=new paydocs.PayDocsGrid,i.roomsGrid=new n.RoomsView,i.payview=new paydocs.CreatePayView(i).onAction(function(){return i.doPayment()}),i.autoRenewalButton=new $u.RefUI,i.invoicesList=new paydocs.InvoicesList,i.form=new $u.RefForm,i}return __extends(i,t),i.prototype.$config=function(){var i=this;t.prototype.$config.call(this);var r=this.form.config().Labels(110).extend({padding:0,elements:[$u.cols($u.element("period").Label("Граница даты").AsSelect(n.periods).Require().Size(270),$u.element("isPayment").Label("Тариф оплат").AsCheckbox(!0).Size(270).Tooltip("Использовать тариф для оплаченных броней"),$u.button("Пересчитать").Click(function(){return i.recalc()}),{}),]}),u=this.headers.config("<h2>Партнер: #name#<\/h2>"),f=this.template.config("http->"+It.Web.WebSource.base+"/html/domain-details.html",{tarif:{}}).extend({activeContent:{cancelAutoRenewalButton:$u.button("Отменить автопролонгацию").Click(function(){return i.cancelAutoReneval()}).Ref(this.autoRenewalButton)}}).Min(0,150),e={activeContent:{payButton:$u.button("Продлить!").Click($u.callActiveContent(function(n){return i.openPayment(n)}))}},o=$u.rows($u.header("Информация о текущем тарифе"),r,this.invoicesList.config(e),f),s=$u.rows($u.toolbar($u.label("Список платежных документов").Size(-1)),this.docsGrid.config().Autoheight()),h=$u.tabview().Tab("Тариф",o).Tab("Документы",s).Tab("Площадки",this.roomsGrid.$config());return $u.rows(u.Size(0,90),h.Autoheight(),{})},i.prototype.$init=function(){t.prototype.$init.call(this);var n=this.payview.win=new $u.RefWin("Оплата");n.resize=!1;n.position="center";n.config(this.payview.$config());this.loadForm(undefined)},i.prototype.$reload=function(n){n||(n=system.context.domainId);t.prototype.$reload.call(this,n);this.loadForm(n);this.docsGrid.reload(n);this.roomsGrid.reload(n);this.invoicesList.reload(n)},i.prototype.openPayment=function(n){var i=this.invoicesList.list.getItem(n),t;if(!i)return It.UI.w.error("Не выбран тариф");this.payview.openWindow();t=this.template.values();t.tarifId=i.id;t.tarifName=i.name;t.price=i.price;t.comm=i.mobComSum;this.payview.load(t)},i.prototype.loadForm=function(t){var i=t?n.db.get(t):{tarif:{}};i.limit=webix.i18n.dateFormatStr(i.limitDate);this.headers.setValues(i);this.template.setValuesEx(i);this.form.setValues(i)},i.prototype.cancelAutoReneval=function(){confirm("Отменить автопролонгацию?")&&(this.template.setValuesEx({autoRenewal:!1}),alert("Автопролонгация тарифа прекращена. Для пролонгации тарифа используйте кнопку 'Продлить'"),this.autoRenewalButton.enable(!1),this.$reload(this.objectId))},i.prototype.doPayment=function(){this.payview.win.hide();this.$reload(this.objectId)},i.prototype.recalc=function(){var t,i;this.form.validate()&&confirm("Пересчитать текущую доменную зону?")&&(t=this.form.values(),n.db.save({id:this.objectId,period:t.period,isPayment:t.isPayment}),i=paydocs.db.recalc(this.objectId),this.loadForm(this.objectId),webix.alert("Доменная зона пересчитана"))},i}($u.View);n.EditView=t}(domains||(domains={})),function(n){var t=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i.grid=new $u.RefGrid,i.edform=new n.EditForm,i.fform=new $u.RefForm,i.popupForm=(new n.PopupForm).onAction(function(n){return i.setProps(n)}),i}return __extends(i,t),i.prototype.setProps=function(t){var r=this.grid.getSelectedIds(),i,u,f;if(r.length==0)return alert("Не выделены записи");if(confirm("Изменить параметры для ".concat(r.length," записей?"))){for(i=0,u=r;i<u.length;i++)f=u[i],t.id=f,n.db.save(t);this.reload();alert("Выделенный список обновлен")}},i.prototype.$config=function(){var i=this;t.prototype.$config.call(this);var r=this.grid.config().extend({scrollAlignY:!0,scrollX:!0,leftSplit:1,columns:[$u.column("name").Header("Партнер",140).Template($u.getViewLink("domains","#name#")).Sort().Filter().Footer({content:"countColumn"}),$u.column("status").Header("Статус").AsSelect(n.statuses).Sort().Filter().Edit(),$u.column("isArchive").Header("Арх").AsCheckboxReadly().Sort(),$u.column("tarifId").Header("Тариф",130).AsSelect(tarifs.db.names()).Sort().Filter(),$u.column("cityId").Header("Город").AsSelect(groups.db.names(groups.GroupType.City)).Sort().Filter(),$u.column("debtComm").Header("Долг",60).AsInt().Footer({content:"summColumn"}).Sort(),$u.column("lastComm").Header("Прошл.ком",60).AsInt().Footer({content:"summColumn"}).Sort(),$u.column("currComm").Header("Тек.ком",60).AsInt().Footer({content:"summColumn"}).Sort(),$u.column("createDate").Header("Создано.").AsDate().Sort(),$u.column("initDate").Header("Иниц.").AsDate().Sort(),$u.column("limitDate").Header("Срок").AsDate().Sort(),$u.column("terminal").Header("Терминал",140).Sort().Filter(),$u.column("owners").Header("Ответственные",240).Sort().Filter(),$u.column("spheres").Header("Сферы",440).Sort().Filter(),],scheme:{$change:n.domain_css},save:n.db.getSaveCfg(!0)}).Editable().Footer(),u=$u.panelbar(this.grid.btnAdd(),this.grid.btnDel(),$u.button("Фильтр").Popup(this.$config_filter()),$u.button("Изменить").Popup(this.popupForm.$config().Size(500)),$u.button("Обновить").Click(function(){return i.reload()}),$u.button("Иниц.").Tooltip("Создать права и админа").Click(function(){return i.initDomains()}),$u.button("Пароль").Tooltip("Сбросить пароль админа").Click(function(){return i.resetPassword()}),$u.button("Тест").Tooltip("Тестирование сервиса смены статусов").Click(function(){return i.testJob()}),{},$u.button("Сохранить").Click(function(){return i.save()}));return $u.rows(u,$u.cols(r,this.edform.config().Size(350)))},i.prototype.$config_filter=function(){var t=this;return this.fform.config().Labels(0,"top").extend({elements:[$u.element("spheres").Label("Сферы").AsMultiSelect(spheres.db.names()),$u.element("name").Label("Ответственный (ФИO,mails,login)"),$u.element("sources").Label("Источники").AsMultiSelect(orders.sourceUserTypes),$u.element("statuses").Label("Статус").AsMultiSelect(n.statuses),$u.element("archive").Label("Показать с флагом Архив =").AsSelect(app.booleans),$u.cols($u.button("Найти").Click(function(){return t.reload()}),$u.button("Очистить").Click(function(){return t.fform.clear()}),{}),]})},i.prototype.$init=function(){t.prototype.$init.call(this);this.edform.form.bind(this.grid)},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.first&&this.reload()},i.prototype.initDomains=function(){var t=this.grid.getSelectedItems();t.forEach(function(t){return n.db.init(t.id,!1)});webix.alert("Инициализированы выделенные партнерские зоны и созданы права по умолчанию");this.reload()},i.prototype.resetPassword=function(){var i=this.grid.getSelectedItem(),t;if(!i)return webix.message("Выделите запись");if(!confirm("Создать новый пароль для администратора зоны?"))return webix.message("Отмена действия");t=n.db.reset(i.id);webix.alert("Администратор зоны, Login: ".concat(t.login,", Password: ").concat(t.password))},i.prototype.testJob=function(){n.db.job();this.reload();webix.message("Обработка статусов успешно выполнена")},i.prototype.reload=function(){var t=this.fform.ref?this.fform.values():{},i=n.db.list(t);this.grid.refresh(i)},i.prototype.save=function(){this.edform.form.updateBindings()},i}($u.View);n.GridView=t}(domains||(domains={})),function(n){var t=function(t){function i(){return t!==null&&t.apply(this,arguments)||this}return __extends(i,t),i.prototype.$config=function(){var n=this,t=this.form.config().Labels(100).extend({elements:[$u.header("Регистрация нового партнера".tag("b")),$u.element("name").Label("Название").Require(),$u.element("email").Label("E-mail").Require(),$u.element("city").Label("Город").AsSelect(groups.db.names(groups.GroupType.City)).Require(),$u.element("spheres").Label("Сферы деятельности","top").AsMultiSelect(spheres.db.names()).Require(),$u.cols({},$u.button("Зарегистрироваться").Click(function(){return n.register()}).Size(200,60),{}),{},]});return $u.cols({},t.Min(400),{})},i.prototype.$action=function(){return t.prototype.$action.call(this)?(this.hide(),this.$clear(),!0):!1},i.prototype.register=function(){if(this.form.validate()){var t=this.form.values();t.opers=i.OPERATIONS;n.db.registry(t);webix.alert("Партнерская зона успешно зарегистрирована. Проверьте пожалуйста почту")}},i.OPERATIONS=[auth.oper.lists,auth.oper.listBases,auth.oper.basesAll,auth.oper.equipments,auth.oper.promo,auth.oper.clients,auth.oper.orders,auth.oper.orderCancel,auth.oper.orderCancelAny,auth.oper.orderDelete,auth.oper.orderEdit,auth.oper.orderEditGroup,auth.oper.orderEditHold,auth.oper.orderForfeit,auth.oper.orderNew,auth.oper.orderViewFull,auth.oper.orderViewQuick,auth.oper.users,],i}($u.PopupView);n.RegView=t}(domains||(domains={})),function(n){n.create={grid:function(){return new n.GridView}};var t=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.itemsUrl=t.url("list"),t}return __extends(t,n),t}(app.AppDataSource);n.db=new t("discounts")}(discounts||(discounts={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n}return __extends(i,t),i.prototype.$config=function(){var u=this,i,r;return t.prototype.$config.call(this),i=this.grid.config().extend({columns:[$u.column("isArchive").Header("Арх").AsCheckbox().Sort().Edit(),$u.column("orders").Header("Заказов").AsInt().Sort().Edit(),$u.column("discount").Header("% скидки").AsInt().Sort().Edit(),],scheme:{},save:n.db.getSaveCfg(!0)}).Editable(),r={rows:[$u.panelbar(this.grid.btnAdd(),this.grid.btnDel(),this.grid.btnRefresh(function(){return u.refresh()}),{},$u.label("Список скидок, которые автоматически назначаются клиентам после оплаты")),i,]},r},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.refresh()},i.prototype.refresh=function(){var t=n.db.list();this.grid.refresh(t)},i}($u.View);n.GridView=t}(discounts||(discounts={})),function(n){function s(t){var r=t.dateFrom.getHours(),u=t.dateFrom.getMinutes(),i=t.dateTo.getHours(),f=t.dateTo.getMinutes();i==0&&(i=24);var e=n.statuses.findById(t.status,{}).value||"без статуса",o=n.cancelReasons.findById(t.reason,{}).value||"";return"".concat(e," ").concat(o,": ").concat(t.baseName,", ").concat(t.roomName," на ").concat(webix.i18n.dateFormatStr(t.dateFrom),", ").concat(r,":").concat(u,"-").concat(i,":").concat(f)}var e,u,o,f,i,t,r;n.create={"ask-grid":function(){return new n.AskGridView},forfeits:function(){return new n.ForfeitsGridView},edit:function(){return new n.EditView},"filter-grid":function(){return new n.FilterGridView},"filter-grid-full":function(){return new n.FilterGridFullView},totals:function(){return new n.TotalsView},requests:function(){return new n.RequestsGridView},request:function(){return new n.RequestView},totalscom:function(){return new n.TotalsComView},calendar:function(){return new n.CalendarView},search:function(){return new n.SearchView},"search-s":function(){return new n.SearchSuperView},"search-all":function(){return new n.SearchAllView}};e=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.getAbonementItems=function(n){return t.load("abonement",{abonement:n})},t.calendarUpdates=new app.UpdatesSource("updates"),t.forfeitUpdates=new app.UpdatesSource("updates"),t.calcUrl=t.url("calc"),t}return __extends(t,n),t.prototype.clearCalendar=function(n,t,i){return this.post("clear-calendar",{base:n,d1:t,d2:i})},t.prototype.list=function(n){return this.load("list",n)},t.prototype.admlist=function(n){return this.load("admlist",n)},t.prototype.requests=function(n){return this.load("requests",n)},t.prototype.search=function(n){return this.load("search",n)},t.prototype.commissionUrl=function(){return this.url("commission")},t.prototype.calc=function(n){return this.post("calc",n)},t.prototype.calendar=function(n,t,i){return this.load("calendar",{base:n,dateFrom:t,dateTo:i})},t.prototype.totals=function(n,t){return this.load("totals",{dfrom:n,dto:t},!1)},t.prototype.totalscom=function(n){return this.load("totalscom",n,!1)},t.prototype.setStatus=function(n,t){return this.post("status",{id:n,act:t})},t}(app.AppDataSource);n.db=new e("orders"),function(n){n[n.Request=-1]="Request";n[n.Unknow=0]="Unknow";n[n.Reserv=1]="Reserv";n[n.Closed=10]="Closed";n[n.Cancel=11]="Cancel"}(u=n.OrderStatus||(n.OrderStatus={}));n.statuses=[{id:u.Request,value:"Заявка"},{id:u.Reserv,value:"Резерв"},{id:u.Closed,value:"Закрыто"},{id:u.Cancel,value:"Отменено"},],function(n){n[n.New=0]="New";n[n.Reserv=1]="Reserv";n[n.Paid=10]="Paid";n[n.CancelNormal=11]="CancelNormal";n[n.CancelForfeitAsk=21]="CancelForfeitAsk";n[n.CancelForfeitConfirm=22]="CancelForfeitConfirm";n[n.Close=100]="Close"}(o=n.OrderAction||(n.OrderAction={})),function(n){n[n.Unknown=0]="Unknown";n[n.Normal=1]="Normal";n[n.ForfeitsAsk=3]="ForfeitsAsk";n[n.ForfeitsConfirmed=4]="ForfeitsConfirmed"}(f=n.CancelReason||(n.CancelReason={}));n.cancelReasons=[{id:f.Normal,value:"Без штрафа"},{id:f.ForfeitsAsk,value:"Запрос"},{id:f.ForfeitsConfirmed,value:"Подтверждение"},],function(n){n[n.Abonements=1]="Abonements";n[n.Mobile=2]="Mobile";n[n.Site=3]="Site";n[n.Widget=4]="Widget";n[n.Bot=5]="Bot"}(i=n.SourceKind||(n.SourceKind={}));n.sourceKinds=[{id:i.Abonements,value:"Абонементы"},{id:i.Mobile,value:"Мобильные"},{id:i.Site,value:"Сайт"},{id:i.Widget,value:"Виджет"},{id:i.Bot,value:"Бот"},];n.payStatuses=[{id:1,value:"Нет"},{id:2,value:"Частично"},{id:3,value:"Полностью"},],function(n){n[n.Web=0]="Web";n[n.Mobile=1]="Mobile";n[n.Imported=2]="Imported";n[n.Widget=3]="Widget";n[n.Bot=4]="Bot";n[n.Catalog=5]="Catalog";n[n.Sync=6]="Sync"}(t=n.SourceType||(n.SourceType={}));n.sourceTypes=[{id:""+t.Web,value:"Сайт"},{id:t.Mobile,value:"Мобильные"},{id:t.Widget,value:"Виджет"},{id:t.Catalog,value:"Каталог"},{id:t.Bot,value:"Бот"},{id:t.Imported,value:"Импорт"},{id:t.Sync,value:"Синхронизация"},];n.sourceUserTypes=[{id:t.Mobile,value:"Мобильные"},{id:t.Widget,value:"Виджет"},],function(n){n[n.Unknown=0]="Unknown";n[n.New=1]="New";n[n.Processing=2]="Processing";n[n.Confirmed=10]="Confirmed";n[n.Canceled=11]="Canceled";n[n.Unprocessed=12]="Unprocessed"}(r=n.RequestStatus||(n.RequestStatus={}));n.requestStatuses=[{id:r.New,value:"Новая"},{id:r.Processing,value:"В работе"},{id:r.Confirmed,value:"Подтвержденная"},{id:r.Canceled,value:"Отлонена"},{id:r.Unprocessed,value:"Не обработана"},];n.getOrderText=s}(orders||(orders={})),function(n){var t=864e5,i=function(n){function i(){var t=n!==null&&n.apply(this,arguments)||this;return t.form=new $u.RefForm,t}return __extends(i,n),i.prototype.$config=function(){var t=this,n=70,i=[$u.element("d1").Label("ПН").Size(n).AsCheckbox(!0),$u.element("d2").Label("ВТ").Size(n).AsCheckbox(!0),$u.element("d3").Label("СР").Size(n).AsCheckbox(!0),$u.element("d4").Label("ЧТ").Size(n).AsCheckbox(!0),$u.element("d5").Label("ПТ").Size(n).AsCheckbox(!0),$u.element("d6").Label("СБ").Size(n).AsCheckbox(!0),$u.element("d7").Label("ВС").Size(n).AsCheckbox(!0),];return this.form.config().Labels(20).extend({elements:[{cols:i},$u.cols($u.element("t1").Label("Начало",null,70).AsDate().Type("time").Size(180).Require(),$u.element("t2").Label("Окончание",null,85).AsDate().Type("time").Size(200).Require(),{}),$u.cols($u.button("Создать").Click(function(){return t.onCreate()}),$u.button("Очистить").Click(function(){return t.form.clear()}))]})},i.prototype.create=function(n,i){var f;if(!this.form.validate())return null;var e=[],r=this.form.values(),c=[r.d7,r.d1,r.d2,r.d3,r.d4,r.d5,r.d6,],o=r.t1,s=r.t2,l=(i-n)/t;for(f=0;f<=l;f++){var u=n.addDays(f),h=u.getDay(),a=c[h];a&&e.push({date:u,dateFrom:new Date(u.getFullYear(),u.getMonth(),u.getDate(),o.getHours(),o.getMinutes()),dateTo:new Date(u.getFullYear(),u.getMonth(),u.getDate(),s.getHours(),s.getMinutes()),wday:h})}return e},i.prototype.clickCreate=function(){this.onCreate&&this.onCreate()},i}($u.View);n.CreateWizard=i}(abonements||(abonements={})),function(n){var t=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i.form=new $u.RefForm,i.ordersGrid=new $u.RefGrid,i.ordersForm=new $u.RefForm,i.wizard=new n.CreateWizard,i.editor=new orders.OrderEditor(function(){return i.refreshGrid()}),i.messagesView=new messages.ListView(i),i.buttons={create:new $u.RefUI,createWizard:new $u.RefUI,recalc:new $u.RefUI,reserv:new $u.RefUI,paid:new $u.RefUI,close:new $u.RefUI,save:new $u.RefUI},i._Loading=!1,i}return __extends(i,t),i.prototype.$config=function(){var i=this,r;t.prototype.$config.call(this);r=this;this.wizard.onCreate=function(){return i.create()};var u=$u.cols($u.button("Сохранить").Click(function(){return i.save(!0)}),$u.button("Удалить").Click(function(){return i.delete()}).Hidden(!n.logic.allowDelete()),{}),f=this.form.config().Labels(120).extend({elements:[clients.getSearchColumn().OnChange(function(n){return i.clientUpdate(n)}),$u.cols($u.rows($u.cols($u.element("dateFrom").Label("Начало").AsDate().Size(250),$u.element("baseId").Label("База",null,70).AsSelect(bases.db.names(!0)).OnChange(function(n){return r.updateBase(n)}).Require(),$u.element("baseType").Visible(!1)),$u.cols($u.element("dateTo").Label("Окончание").AsDate().Size(250),$u.element("roomId").Label("Комната",null,70).AsSelect2([]).Require().OnChange(function(){return r.updateUI()})).Size(-1),$u.element("options").Label("Опции","top").AsMultiSelect(groups.db.options()).OnChange(function(){return r.updateUI()}),$u.element("equipments").Label("Позиции").AsMultiSelect([]).OnChange(function(){return r.updateUI()}),$u.element("promoId").Label("Промоакция").AsSelect(promo.db.names(!0,promo.PromoKind.Action)),{}).Size(-1),$u.rows($u.element("clientDiscount").Label("Скидка клиента").AsNumber().Disable(),$u.element("discount").Label("Скидка абонем.").AsNumber().Disable().Tooltip("Временно заблокировано"),$u.element("totalReserv").Label("Резерв").AsNumber().Disable(),$u.element("totalPaid").Label("Оплата").AsNumber().Disable(),$u.element("forfeit").Label("Штраф тек.").AsNumber().Css("it-mark").Disable(),$u.element("totals").Label("Общая стоим.").Css("it-warning").AsNumber().Disable()).Size(300)),$u.element("description").Label("Комментарий").AsTextArea(100),]}),e=$u.toolbar($u.button("Создание").Popup(this.wizard.$config()).Tooltip("Открытие мастера создания брони").Ref(this.buttons.createWizard),this.ordersGrid.btnAdd().Ref(this.buttons.create),$u.icon("minus-circle").Click(function(){return i.deleteOrders()}).Tooltip("Удалить выделенные брони"),this.ordersGrid.btnRefresh(function(){return i.refreshGrid()}),$u.button("Пересчет").Click(function(){return i.recalc(!1)}).Tooltip("Пересчет выделенных броней").Ref(this.buttons.recalc),$u.button("Открыть").Click(function(){return i.openEditor()}).Tooltip("Открыть выделенную бронь"),$u.button("Зарезервировать").Click(function(){return i.doAction(orders.OrderAction.Reserv,"Зарезервировать выделенные брони?")}).Tooltip("Резервирование выделенных броней").Ref(this.buttons.reserv),$u.button("Оплатить").Click(function(){return i.doAction(orders.OrderAction.Paid,"Оплатить выделенные брони?")}).Tooltip("Оплата выделенных броней").Ref(this.buttons.paid),$u.button("Закрыть").Click(function(){return i.doAction(orders.OrderAction.Close,"Закрыть выделенные брони?")}).Tooltip("Завершение выделенных броней").Ref(this.buttons.close),{},$u.button("Сохранить").Click(function(){return i.updateOrder()}).Tooltip("Сохранение данных по брони").Ref(this.buttons.save)),o=this.ordersGrid.config().extend({height:200,columns:[$u.column("dateFrom").Header("Дата").AsDate().Sort(),$u.column("roomId").AsSelect(rooms.db.namesUrl).Header("Комната",-1).Sort(),$u.column("payForfeit").Header("Опл-Штр",40).AsCheckbox(),$u.column("payDate").Header("Дата оплаты").AsDate().Sort(),$u.column("paidForfeit").AsInt().Header("Опл.Штраф",80).Sort(),$u.column("totalOrder").AsInt().Header("Стоимость",80).Sort(),$u.column("status").AsSelect(orders.statuses).Header("Статус").Sort(),$u.column("errors").Header("Ошибки",-1),$u.column("idd").Header("*",30).Template(Symbols.calendar.link("{common.href}/orders/calendar/?base=#baseId#&date=#dateFrom#")),$u.column("dateTo").Header("",1).Size(1),],scheme:{abonementId:"",totalOrder:0,dateFrom:(new Date).addDays(1),dateTo:(new Date).addDays(1),$change:function(n){return i.setCSS(n)}}}).Editable(orders.db.getSaveCfg(!0)).Tooltip(),s=this.ordersForm.config().Labels(120).extend({gravity:.5,elements:[$u.element("dateFrom").Label("Начало").AsDate(!0).Require(),$u.element("dateTo").Label("Окончание").AsDate(!0).Require(),$u.element("roomId").Label("Комната").AsSelect(rooms.db.namesUrl).Require(),$u.element("promoId").AsSelect(promo.db.names(!0,promo.PromoKind.Action)).Label("Промоакция"),$u.element("totalOrder").Label("Сумма").Disable(),$u.element("payDate").Label("Дата опл.").AsDate().Disable(),$u.element("text").Label("Расчеты").AsHtmlLabel(100).Readonly(),$u.element("errors").Label("Ошибки").AsHtmlLabel(100).Css("it-error").Readonly(),{},]}),h=$u.rows(e,$u.cols(o,s).Scrollable());return $u.rows(u,f,$u.tabview().Tab("Брони",h).Tab("История",this.messagesView.$config()))},i.prototype.$init=function(){return this.ordersForm.bind(this.ordersGrid),{header:"Карточка абонемента"}},i.prototype.$reload=function(i){try{this._Loading=!0;t.prototype.$reload.call(this,i);var r=n.db.getUrl(i),f=this.form.load(r);this.refreshGrid()}catch(u){throw u;}finally{this._Loading=!1;this.updateUI()}this.ordersForm.clear();this.calcTotals();this.messagesView.filter.abonement=i;this.messagesView.setDefaults({abonementId:i});this.messagesView.refresh()},i.prototype.openEditor=function(){var n=this.ordersGrid.getSelectedItem();n&&this.editor.edit(n.id)},i.prototype.setCSS=function(n){n&&(orders.logic.getStateCss(n),n.errors&&(n.$css="it-error"))},i.prototype.updateBase=function(n){var i=null,u,t;if(n){var f=this.form.elements.baseId,e=f.getList(),r=e.getItem(n);r&&(i=r.type)}u=n?equipments.db.names(n):[];this.form.elements.equipments.define({suggest:u});t=n?rooms.db.names(n):[];this.form.elements.roomId.define({suggest:t});this.ordersForm.elements.roomId.define({suggest:t});this.form.setValuesEx({baseType:i});this.updateUI()},i.prototype.updateUI=function(){if(!this._Loading){var t=this.form.values(),i=n.logic.allowEdit(t),r=i&&n.logic.allowEditClient(t);this.form.enable(i,"dateFrom");this.form.enable(i,"dateTo");this.form.enable(i,"baseId");this.form.enable(i,"roomId");this.form.enable(r,"clientId");this.ordersForm.enable(n.logic.allowOrderEdit(t));this.buttons.save.visible(n.logic.allowOrderEdit(t));this.buttons.create.visible(n.logic.allowOrderCreate(t));this.buttons.createWizard.visible(n.logic.allowOrderCreate(t));this.buttons.recalc.visible(n.logic.allowOrderRecalc(t));this.buttons.reserv.visible(n.logic.allowOrderReserv(t));this.buttons.paid.visible(n.logic.allowOrderPay(t));this.ordersGrid.scheme({abonementId:t.id,roomId:t.roomId,baseId:t.baseId,clientId:t.clientId,discount:t.clientDiscount,options:t.options,dateFrom:"",dateTo:""})}},i.prototype.create=function(){var t=this,n,r,i,u;this.form.validate()&&(n=this.form.values(),r=this.wizard.create(n.dateFrom,n.dateTo),r)&&(i=[],u=this.ordersGrid,r.forEach(function(r){var f={dateFrom:r.dateFrom,dateTo:r.dateTo,baseId:n.baseId,roomId:n.roomId,clientId:n.clientId,payForfeit:!0,itemsJson:t.eq2items(n.equipments),discount:n.clientDiscount,options:n.options,promoId:n.promoId};u.add(f);i.push(f)}),setTimeout(function(){t.calc(i);t.calcTotals();t.save(!1);webix.message("Создано: ".concat(i.length," броней"))},2e3))},i.prototype.delete=function(){return confirm("Удалить текущий абонемент и все связанные брони?")?n.db.archive(this.objectId)?(It.Web.historyBack(),webix.message("Бронь успешно удалена")):void 0:webix.message("Отменено удаление")},i.prototype.clientUpdate=function(n){if(n&&!n.id){var t=clients.db.get(n);if(t.isBanned)return this.form.setValuesEx({clientId:null}),It.UI.w.error("Клиент заблокирован!");console.log("client update:",t);this.form.setValuesEx({clientDiscount:t.discount,promo:t.promoCode,forfeit:t.forfeit});this.calcTotals()}},i.prototype.updateOrder=function(){var n,t;if(this.ordersForm.validate()&&(n=this.ordersForm.values(),n.roomId)){if(t=this.calc([n]),t)return It.UI.error(t);this.ordersForm.updateBindings();this.ordersGrid.save()}},i.prototype.deleteOrders=function(){var t=this,i=this.ordersGrid.getSelectedItems();if(i.length==0)return webix.message("Выделите брони для удаления");if(!confirm("Удалить безвозвратно выделенные брони?"))return webix.message("Удаление отменено");i.forEach(function(i){n.logic.allowOrderDel(i)?t.ordersGrid.removeRow(i.id):It.UI.w.error("Нельзя удалить бронь в статусе или нет прав на операцию")});this.calc([]);this.save(!0);setTimeout(function(){return t.refreshGrid()},200)},i.prototype.eq2items=function(n){if(!n)return undefined;var t=n.split(","),i=t.map(function(n){return{eq:n,n:1}});return JSON.stringify(i)},i.prototype.calc=function(n){var i=this,r=this,t="";return n.forEach(function(n){var r=i.calc_item(n);n.errors=r;t+=r}),r.calcTotals(),t},i.prototype.calc_item=function(t,i){var e,r;i===void 0&&(i=!0);var o=this,u=t.id,f="";return n.logic.allowOrderRecalc(t)?(typeof t.id!="string"&&(u=null),e={id:u,roomId:t.roomId,dateFrom:t.dateFrom,dateTo:t.dateTo,itemsJson:t.itemsJson,options:t.options,clientId:t.clientId,promoId:t.promoId,check:!0},r=orders.db.calc(e),r.errors?(t.$css="it-error",t.errors=r.errors,f+=r.errors+"\n"):r.isHold||(t=webix.extend(t,r,!0),t.totalSum=t.totalOrder,i&&o.ordersGrid.updateRow(t.id,t)),this.setCSS(r),f):It.UI.w.error("Недоступен пересчет для брони "+webix.i18n.dateFormatStr(t.dateFrom))},i.prototype.recalc=function(n){n===void 0&&(n=!0);var t=this.ordersGrid.getSelectedItems();this.calc(t);this.save(n)},i.prototype.calcTotals=function(){var n={},t=0,e=0,i,r,u,f;this.ordersGrid.forEach(function(i){if(i.totalSum&&i.status!=orders.OrderStatus.Cancel){var r=parseInt(i.totalSum);n[i.status]?n[i.status]+=r:n[i.status]=r;t+=r;e++}});i=this.form.elements.discount.getValue();r=this.form.elements.forfeit.getValue();t+=r;u=Math.round((0+n[orders.OrderStatus.Reserv])*(100-i)/100);f=Math.round((0+n[orders.OrderStatus.Closed])*(100-i)/100);this.form.setValuesEx({totalReserv:u,totalPaid:f,totals:t})},i.prototype.action2status=function(n){switch(n){case orders.OrderAction.New:return orders.OrderStatus.Unknow;case orders.OrderAction.Reserv:return orders.OrderStatus.Reserv;case orders.OrderAction.Paid:return orders.OrderStatus.Reserv;case orders.OrderAction.CancelNormal:return orders.OrderStatus.Cancel;case orders.OrderAction.CancelForfeitAsk:return orders.OrderStatus.Cancel;case orders.OrderAction.CancelForfeitConfirm:return orders.OrderStatus.Cancel;default:return orders.OrderStatus.Reserv}},i.prototype.doAction=function(n,t){var i,r,u;if(this.form.validate()){if(i=this.ordersGrid.getSelectedItems(),i.length==0)return webix.message("Не выделено ни одной брони");if(r=!1,i.forEach(function(n){n.id&&typeof n.id=="string"||(r=!0)}),r)return It.UI.w.error("Сначала сохраните данные");confirm(t)&&(u=this.action2status(n),i.forEach(function(t){if(n!=orders.OrderAction.Paid||t.status!=orders.OrderStatus.Cancel)var i=orders.db.setStatus(t.id,n)}),this.save(!0),this.calcTotals())}},i.prototype.save=function(t){this.form.validate()&&(this.form.save(n.db.saveUrl(this.objectId),!1),t?(this.refreshGrid(),this.calcTotals()):this.ordersGrid.refresh(),webix.message("Данные сохранены на сервере"))},i.prototype.refreshGrid=function(){var t=this,n=orders.db.getAbonementItems(this.objectId);n.forEach(function(n){return t.setCSS(n)});this.ordersGrid.refresh(n)},i}($u.View);n.EditView=t}(abonements||(abonements={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n.filterForm=new $u.RefForm,n}return __extends(i,t),i.prototype.$config=function(){var i=this;t.prototype.$config.call(this);var r=this.grid.config().extend({columns:[$u.column("idd").Header("*",30).Template($u.getViewLink("abonements")),$u.column("client").Header("Клиент",200).Sort().Filter().Template(clients.getClientColumnTemplate()),$u.column("dateFrom").Header("Начало").AsDate(),$u.column("dateTo").Header("Окончание").AsDate(),$u.column("baseId").Header("База").AsSelect(bases.db.names(!0)).Filter(),$u.column("totalSum").Header("Стоимость",70).AsInt().Footer({content:"summColumn"}),$u.column("reserv").Header("Резерв",70).AsInt().Footer({content:"summColumn"}),$u.column("payments").Header("Оплачено",70).AsInt().Footer({content:"summColumn"}),$u.column("description").Header("Комментарии",-1).Filter(),],scheme:{client:"",dateFrom:(new Date).addDays(1),dateTo:(new Date).addDays(31)}}).Editable(n.db.getSaveCfg(!0)).Footer(),u=this.filterForm.config().extend({cols:[$u.element("dateFrom").Label("С",null,30).Size(140).AsDate(),$u.element("dateTo").Label("По",null,40).Size(150).AsDate(),$u.element("pays").Label("Оплата",null,60).AsSelect(orders.payStatuses).Size(200),]});return $u.rows($u.panelbar(this.grid.btnAdd().Hidden(!n.logic.allowOrderCreate(null)),u,this.grid.btnRefresh(function(){return i.refresh()}),{}),r)},i.prototype.$init=function(){t.prototype.$init.call(this);var n=new Date,r=1-n.getDate(),i=n.addDays(r);this.filterForm.setValuesEx({dateFrom:i,dateTo:i.addMonth(1).addDays(-1)})},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.refresh()},i.prototype.refresh=function(){if(this.filterForm.validate("Ошибки в параметрах")){var t=this.filterForm.values(),i=n.db.list(t);this.grid.refresh(i)}},i}($u.View);n.GridView=t}(abonements||(abonements={})),function(n){var t=auth.oper,r=orders.OrderStatus,i=function(){return system.context.allow(t.orderFullAccess)},u=function(){function n(){this.allowEdit=function(){return i()||system.context.allow(t.abonementEdit)};this.allowDelete=function(){return i()||system.context.allow(t.abonementDel)};this.allowGroup=function(){return!0};this.allowEditClient=function(n){return i()||!n.clientId};this.allowForfeit=function(n){return n.forfeit&&n.forfeit!="0"};this.allowOrderCreate=function(){return i()||system.context.allow(t.abonementOrderCreate)};this.allowOrderEdit=function(){return i()||system.context.allow(t.abonementOrderEdit)};this.allowOrderRecalc=function(n){return i()||system.context.allow(t.abonementOrderCalc)&&(!n.status||!n.isHold)};this.allowOrderReserv=function(n){return i()||system.context.allow(t.orderFullAccess)||system.context.allow(t.orderReserv)&&(!n.status||n.status==r.Unknow||n.status==r.Cancel)};this.allowOrderPay=function(){return i()||system.context.allow(t.abonementOrderPay)};this.allowOrderDel=function(n){return i()||n.status==r.Unknow}}return n}();n.logic=new u}(abonements||(abonements={})),function(n){n.create={grid:function(){return new n.GridView},edit:function(){return new n.EditView}};var t=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.itemsUrl=t.url("list"),t}return __extends(t,n),t}(app.AppDataSource);n.db=new t("abonements")}(abonements||(abonements={})),function(n){var t=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i.list=new $u.RefList,i.form=new n.EditForm,i}return __extends(i,t),i.prototype.$config=function(){var i=this,r,u;return t.prototype.$config.call(this),r=this.list.config().extend({template:"http->"+It.Web.WebSource.base+"/html/group-spheres.html",type:{href:"#!",height:"auto"},scheme:{id:-1,name:""}}).Editable(n.db.getSaveCfg(!0)),u=$u.rows($u.toolbar(this.list.btnAdd(undefined,0),this.list.btnDel(),this.list.btnRefresh(function(){return i.refresh()}),{},$u.button("Сохранить").Click(function(){return i.form.form.updateBindings()})),$u.cols(r,this.form.config().Size(350))),u},i.prototype.$init=function(){t.prototype.$init.call(this);this.form.form.bind(this.list)},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.first&&this.refresh()},i.prototype.refresh=function(){var t=n.db.list();this.list.refresh(t)},i}($u.View);n.ListView=t}(spheres||(spheres={})),function(n){var t=function(){function t(){this.form=new $u.RefForm}return t.prototype.config=function(){var t=this;return this.form.config().extend({elements:[$u.element("name").Label("Сфера деятельности"),$u.element("isArchive").Label("Скрыть (архив)").AsCheckbox(),$u.element("index").Label("Индекс").AsInt(),$u.element("description").Label("Описание").AsTextArea(100,"top"),$u.uploader("api/core/upload",function(n,i){return t.setImage(i)}).extend({value:"Загрузить иконку",formData:{prefix:"spheres"}}),$u.element("icon").AsTemplate(function(n){return("res/"+n).img({height:"50px",width:"50px"})}),$u.element("limitM").Label("Срок, мес").AsInt(),$u.element("limitD").Label("Срок, дн").AsInt(),$u.element("values").Label("Опции","top").AsMultiSelect(groups.db.names(groups.GroupType.OrderOption)),$u.element("default").Label("Опция по умолч","top").AsSelect(groups.db.names(groups.GroupType.OrderOption)),$u.element("features").Label("Параметры сферы","top").AsMultiSelect(groups.db.features()).Tooltip("Выберите параметры, соответствующие всем комнатам сферы"),$u.element("kind").Label("Тип сферы").AsSelect(n.kinds),{},]})},t.prototype.setImage=function(n){this.form.elements.icon.setValues(n.path)},t}();n.EditForm=t}(spheres||(spheres={})),function(n){var i,t;n.create={list:function(){return new n.ListView},edit:function(){return new n.EditForm}};i=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.reindex=function(n,i){return t.post("reindex",{start:n,ids:i})},t}return __extends(t,n),t}(lists.DataSource);n.db=new i("spheres"),function(n){n[n.Usual=1]="Usual";n[n.Teachers=2]="Teachers"}(t=n.SphereKind||(n.SphereKind={}));n.kinds=[{id:t.Usual,value:"Обычная"},{id:t.Teachers,value:"Преподаватели"},]}(spheres||(spheres={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.form=new $u.RefForm,n.camerasGrid=new $u.RefGrid,n}return __extends(i,t),i.prototype.$config=function(){var n=this;t.prototype.$config.call(this);var r=this.camerasGrid.config().extend({height:200,columns:[$u.column("name").Header("Название",200).Edit(),$u.column("value").Header("Ссылка",-1).Edit(),],scheme:{name:"без имени"}}).Editable(resources.db.getSaveCfg()),i="Укажите часы работы базы по будням и выходным дням в формате 0-24. Например: «0-6,12-24» (означает что с 0 до 6 проходят ночные репетиции, с 6 до 12 объект не работает, далее объект работает с 12 утра до 12 вечера)";return this.form.config().extend({elementsConfig:{labelWidth:150},elements:[$u.cols($u.button("Сохранить").Click(function(){return n.save()}),{}),$u.element("sphereId").Label("Сфера").AsSelect(spheres.db.names()).Require().Tooltip("Выберите сферу оказания услуг вашего объекта"),$u.element("name").Label("Название").Require().Tooltip("Введите название объекта оказания услуг для потенциальных клиентов"),$u.element("description").Label("Описание").AsTextArea(100).Require().Tooltip("Введите описание объекта оказания услуг. Описание транслируется в приложение и отображается в каждой комнате. Отразите в этом поле все особенности и сильные стороны вашего объекта, чтобы клиент выбрав одну из ваших комнат решил забронировать именно ее."),$u.element("rules").Label("Правила").AsTextArea(100).Tooltip("Введите правила объекта оказания услуг"),$u.element("cityId").Label("Город").AsSelect(groups.db.names(groups.GroupType.City)).Require().Tooltip("Введите или выберите ближайший населенный пункт, в котором расположен объект оказания услуг"),$u.element("address").Label("Адрес").AsTextArea(100).Require().Tooltip(" Введите точный адрес объекта без указания города"),$u.cols($u.rows($u.element("phones").Label("Телефоны").Require().Tooltip("Укажите телефон, который будет использоваться для связи с объектом по вопросам бронирования"),$u.element("email").Label("e-mail").Require().Tooltip("Введите e-mail, который будет использоваться для уведомлений о новых бронированиях"),$u.element("direction").Label("Как пройти").AsTextArea(100).Require().Tooltip("Введите текстовое описание маршрута до вашего объекта от ближайшей станции метро или остановки общественного транспорта")),$u.rows($u.uploader("api/core/upload-image",function(t,i){return n.form.elements.logo.setValues(i.path)}).extend({value:"Загрузить логотип",formData:{folder:"bases"}}),$u.element("logo").AsTemplate(function(n){return("res/"+n).img({height:"150px",width:"150px"})})).Size(170)),$u.cols($u.element("gpsLat").Label("GPS Latitude").Require().Tooltip("Укажите координаты входа на базу. Удобней всего скопировать их из Яндекс карт"),$u.element("workTime").Label("Часы (раб.дни)").Tooltip("Часы работы, пример: 09-18").Require().Tooltip(i)),$u.cols($u.element("gpsLong").Label("GPS longitude").extend({rule:webix.rules.isNumber}).Require().Tooltip("Укажите координаты входа на базу. Удобней всего скопировать их из Яндекс карт"),$u.element("weekendTime").Label("Часы (вых.дни)").Tooltip("Часы работы, пример: 08-24").Require().Tooltip(i)),$u.element("metro").Label("Метро").Require().Tooltip("Укажите ближайшую или ближайшие станции метро через запятую. Если в городе нет метро, можно использовать ближайшую остановку общественного транспорта"),$u.element("videoUrl").Label("Ссылка на маршрут").Require().Tooltip("Вставьте ссылку на ролик, изображение или описание как пройти. Если отсутствует можно использовать ссылку на раздел 'Контакты' вашего сайта, страницы в соц. сети или контрагента"),$u.element("channelIds").Label("Способы оплаты").AsMultiSelect(paychannels.db.names()),$u.cols($u.element("isRequest").Label("По заявке",null,70).AsCheckbox().Size(120),$u.element("request").Label("Описание заявки").AsTextArea(100)),$u.element("maxPointsPcPay").Label("Макс.% оплаты баллами ").AsInt(),$u.element("isArchive").Label("Архив").AsCheckbox().Tooltip("Используется для архивации базы"),$u.cols($u.button("Сохранить").Click(function(){return n.save()}),{}),$u.toolbar($u.label("Список камер на базе").Size(-1),this.camerasGrid.btnAdd(),this.camerasGrid.btnDel()),r,],rules:{}})},i.prototype.$reload=function(i){t.prototype.$reload.call(this,i);var u=this.form.load(n.db.getUrl(i)),r=resources.db.getItems(resources.ResourceKind.BaseCamera,i);this.camerasGrid.refresh(r);this.camerasGrid.scheme({name:"камера",kind:resources.ResourceKind.BaseCamera,objectId:i})},i.prototype.save=function(){this.form.validate()&&(this.form.save(n.db.saveUrl(this.objectId),!1),this.camerasGrid.save(),webix.message("Данные сохранены на сервере"))},i}($u.View);n.EditView=t}(bases||(bases={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n}return __extends(i,t),i.prototype.$config=function(){var u=this,i,r;return t.prototype.$config.call(this),i=this.grid.config().extend({columns:[$u.column("sphereId").Header("Сфера").AsSelect(spheres.db.names()).Filter().Edit(),$u.column("name").Header("Название",200).Sort().Filter().Template($u.getViewLink("bases","#name#")),$u.column("description").Header("Описание",-1).Filter(),$u.column("workTime").Header("Раб.Часы",50),$u.column("weekendTime").Header("Вых.Часы",50),$u.column("isArchive").Header("Арх").AsCheckboxReadly().Sort(),],scheme:{name:"без имени"}}).Editable(n.db.getSaveCfg(!0)),r={rows:[$u.panelbar(this.grid.btnAdd(),this.grid.btnDel(),this.grid.btnRefresh(function(){return u.refresh()}),{}),i,]},r},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.refresh()},i.prototype.refresh=function(){var t=n.db.list();this.grid.refresh(t)},i}($u.View);n.GridView=t}(bases||(bases={})),function(n){n.create={grid:function(){return new n.GridView},edit:function(){return new n.EditView}};var t=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.namesUrl=t.url("names"),t.names=function(n){return t.loadList("names",{check:n})},t.getFull=function(n,i,r,u){return t.load("full",{base:u,type:n,from:i,hours:r})},t}return __extends(t,n),t}(app.AppDataSource);n.db=new t("bases")}(bases||(bases={})),function(n){var t=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.grid=new $u.RefGrid,t}return __extends(t,n),t.prototype.$config=function(){var r=this,t,i;return n.prototype.$config.call(this),t=35,i=this.grid.config().extend({columns:[$u.column("n").Header("Кол").Sort().AsNumber().Edit(),$u.column("name").Header("Название",-1).Sort(),$u.column("price").Header("Цена",45).AsInt().Sort(),$u.column("count").Header("Всего",t).AsInt().Sort(),$u.column("used").Header("Исп",t).AsInt().Sort(),$u.column("balance").Header("Ост",t).AsInt().Sort(),]}).Editable().OnEdit(function(n,t){return r.changed(n,t)}),i},t.prototype.refresh=function(n){this.grid.refresh(n)},t.prototype.enable=function(n){n===void 0&&(n=!0);this.grid.enable(n)},t.prototype.changed=function(n,t){var i=this.grid.getItem(t.row);i.n>i.balance&&(webix.message("Превышен лимит позиции"),i.n=i.balance);this.onChange(n,t)},t}($u.View);n.BalanceView=t}(equipments||(equipments={})),function(n){var t=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i.grid=new $u.RefGrid,i.form=new n.EditForm,i}return __extends(i,t),i.prototype.$config=function(){var i=this,r,u;return t.prototype.$config.call(this),r=this.grid.config().extend({tooltip:!0,columns:[$u.column("groupId").AsSelect(groups.db.names(groups.GroupType.Equipment)).Header("Тип",90).Sort().Filter().Tooltip("Выберите тип позиции, для дополнительных услуг используйте тип «Другое»"),$u.column("name").Header("Название",-1).Sort().Filter().Tooltip("Введите название позиции в формате «Электрогитара Gibson SG»"),$u.column("Kind").Header("Тип",100).AsSelect(n.eqKinds).Filter().Edit(),$u.column("price").Header("Цена").AsInt().Sort().Filter().Tooltip("Укажите цену за позицию.<br> Если оборудование предоставляется бесплатно введите «0»"),$u.column("count").Header("Кол").AsInt().Sort().Filter().Tooltip("Укажите фактическое количество для позиции одного наименования на объекте.<br>Это поможет избежать бронирования одного и того же наименования несколькими клиентами"),$u.column("baseId").AsSelect(bases.db.names(!0)).Header("База",150).Sort().Filter().Tooltip(" Выберите объект на котором предоставляется выбранное наименование позиции"),$u.column("destKind").Header("Назначение",100).AsSelect(n.destKinds).Filter().Edit(),$u.column("allowMobile").Header("Моб").AsCheckboxReadly().Sort().Tooltip("Используйте галочку «моб» для публикации или удаления выбранной позиции в мобильном приложении"),$u.column("isArchive").Header("Арх").AsCheckboxReadly().Sort(),],scheme:{id:-1,name:"без имени"},save:n.db.getSaveCfg(!0)}),u=$u.rows($u.panelbar(this.grid.btnAdd(),this.grid.btnDel(),this.grid.btnRefresh(function(){return i.refresh()}),{},$u.button("Сохранить").Click(function(){return i.form.form.updateBindings()})),$u.cols(r,this.form.config().Size(350))),u},i.prototype.$init=function(){t.prototype.$init.call(this);this.form.form.bind(this.grid)},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.first&&this.refresh()},i.prototype.refresh=function(){var t=n.db.list();this.grid.refresh(t)},i}($u.View);n.GridView=t}(equipments||(equipments={})),function(n){var t=function(){function t(){this.form=new $u.RefForm}return t.prototype.config=function(){var t=this;return this.form.config().extend({elements:[$u.element("groupId").Label("Тип").AsSelect(groups.db.names(groups.GroupType.Equipment)).Tooltip("Выберите тип позиции, для дополнительных услуг используйте тип «Другое»"),$u.element("name").Label("Название").Tooltip("Введите название позиции в формате «Электрогитара Gibson SG»"),$u.element("kind").Label("Тип").AsSelect(n.eqKinds),$u.element("description").Label("Описание").AsTextArea(100,"top").Tooltip("Введите описание позиции или его особенности. Клиентам в приложении эта информация не отображается.<br> Описание используется для вашего удобства, например, когда меняли струны на гитаре, или привезли новую тарелку"),$u.uploader("api/core/upload-image",function(n,i){return t.setImage(i)}).extend({value:"Загрузить фото",accept:"image/*",datatype:"json",formData:{folder:"equipments"}}).Css("it-crop"),$u.element("photoUrl").AsTemplate(function(n){return("res/"+n).img({height:"150px",width:"350px"})}),$u.element("price").Label("Цена").AsInt().Tooltip("Укажите цену за позицию.<br> Если оборудование предоставляется бесплатно введите «0»"),$u.element("count").Label("Кол").AsInt().Tooltip("Укажите фактическое количество для позиции одного наименования на объекте.<br>Это поможет избежать бронирования одного и того же наименования несколькими клиентами"),$u.element("baseId").Label("База").AsSelect(bases.db.names(!0)).Tooltip(" Выберите объект на котором предоставляется выбранное наименование позиции"),$u.element("roomIds").Label("Комнаты").AsMultiSelect(rooms.db.names(null,!0)).Tooltip(" Выберите объект на котором предоставляется выбранное наименование позиции"),$u.element("destKind").Label("Назначение").AsSelect(n.destKinds),$u.element("kf").Label("Кф проп.").AsInt().Tooltip("Кф. пропорции. Если 0, то стоимость оборуд. фиксирована, иначе = Цена * Кол-во часов / Кф"),$u.element("allowMobile").Label("Моб").AsCheckbox().Tooltip("Используйте галочку «моб» для публикации или удаления выбранной позиции в мобильном приложении"),$u.element("isArchive").Label("Скрыть (архив)").AsCheckbox(),{},]})},t.prototype.setImage=function(n){this.form.elements.photoUrl.setValues(n.path)},t}();n.EditForm=t}(equipments||(equipments={})),function(n){var r,t,i;n.create={grid:function(){return new n.GridView}};r=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.reindex=function(n,i){return t.post("reindex",{start:n,ids:i})},t}return __extends(t,n),t.prototype.canCancelBase=function(n,t,i){return this.load("can-cancel-base",{base:n,dateCreate:t,dateFrom:i})},t}(lists.DataSource);n.db=new r("orderrules"),function(n){n[n.SameDate=1]="SameDate";n[n.More=2]="More";n[n.Less=3]="Less"}(t=n.OrderRuleIfKind||(n.OrderRuleIfKind={})),function(n){n[n.Always=1]="Always";n[n.More=2]="More";n[n.Less=3]="Less"}(i=n.OrderRuleThenKind||(n.OrderRuleThenKind={}));n.ifkinds=[{id:t.SameDate,value:"День в день"},{id:t.Less,value:"Менее чем за"},{id:t.More,value:"Более чем за"},];n.thenkinds=[{id:i.Always,value:"Всегда"},{id:i.Less,value:"В течение"},{id:i.More,value:"Не позднее чем за"},]}(order_rules||(order_rules={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.form=new $u.RefForm,n.grid=new $u.RefGrid,n}return __extends(i,t),i.prototype.$config=function(){var n=this;t.prototype.$config.call(this);var i={view:"form",id:this.form.id,borderless:!0,cols:[$u.element("base").Label("База",null,50).Size(400).AsSelect(bases.db.names(!0)),$u.icon("refresh").Click(function(){return n.refresh()}).Tooltip("Пересчитать данные и обновить отчет"),{},]},r=this.grid.config().extend({columns:[$u.column("groupId").AsSelect(groups.db.names(groups.GroupType.Equipment)).Header("Тип",150).Sort(),$u.column("name").Header("Название",-1).Sort(),$u.column("price").Header("Цена").AsInt().Sort(),$u.column("count").Header("Всего").AsInt().Sort(),$u.column("used").Header("Использ").AsInt().Sort(),$u.column("balance").Header("Остаток").AsInt().Sort(),]});return{rows:[i,r,]}},i.prototype.refresh=function(){var t=this.form.values(),i=n.db.totals(t.base);this.grid.refresh(i);webix.message("Отчет обновлен")},i}($u.View);n.TotalsView=t}(equipments||(equipments={})),function(n){var i,t,r;n.create={grid:function(){return new n.GridView},totals:function(){return new n.TotalsView}},function(n){n[n.Addition=1]="Addition";n[n.Package=2]="Package"}(i=n.DestKind||(n.DestKind={}));n.destKinds=[{id:i.Addition,value:"Дополнительно к заказу"},{id:i.Package,value:"Пакетное предложение"},],function(n){n[n.None=0]="None";n[n.Other=1]="Other";n[n.Equipment=2]="Equipment";n[n.Service=3]="Service"}(t=n.EqKind||(n.EqKind={}));n.eqKinds=[{id:t.Equipment,value:"Оборудование"},{id:t.Service,value:"Услуга"},{id:t.Other,value:"Другое"},];r=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.namesUrl=t.url("names"),t.names=function(n){return t.loadList("names",{base:n})},t.typesUrl=t.url("types"),t.listUrl=t.url("list"),t}return __extends(t,n),t.prototype.balance=function(n,t,i,r){return this.load("balance",{base:n,order:t,dfrom:i,dto:r,all:!0,empty:!1},!1)},t.prototype.totals=function(n){return this.load("totals",{base:n})},t}(app.AppDataSource);n.db=new r("equipments")}(equipments||(equipments={})),function(n){function r(){var n=It.Web.WebSource.base+"/";It.Web.loadCSS("lib/scheduler/dhtmlxscheduler.css");It.Web.loadJS(n+"lib/scheduler/dhtmlxscheduler.js");It.Web.loadJS(n+"lib/scheduler/dhtmlxscheduler_units.js");It.Web.loadJS(n+"lib/scheduler/dhtmlxscheduler_limit.js");It.Web.loadJS(n+"lib/scheduler/dhtmlxscheduler_collision.js");It.Web.loadJS(n+"lib/webix/scheduler.js");It.Web.loadJS(n+"lib/scheduler/locale_ru.js")}var t={Day:"rooms",Week:"weekrooms",Month:"month"},i=webix,u=function(u){function f(){var i=u!==null&&u.apply(this,arguments)||this;return i.scheduler=new $u.RefUI,i.date=new $u.RefUI,i.sections=rooms.db.units(),i.timerid=setInterval(function(){return i.checkUpdates()},6e4),i.baseList=new $u.RefCombo,i.currentMode=t.Day,i.itemView=new n.ItemView(i),i.loaded=!1,i}return __extends(f,u),f.prototype.$config=function(){var e=this;u.prototype.$config.call(this);i.require.disabled=!0;r();var f=this,s=bases.db.names(!0).filter(function(n){return n.sphere}).sort(function(n,t){return n.sphere.localeCompare(t.sphere)}).map(function(n){return{id:n.id,value:"".concat(n.sphere,": ").concat(n.value),sphereId:n.sphereId,weekendHours:n.weekendHours,workHours:n.workHours}}),o=new n.OrderEditor(function(){return f.refresh()}),h={view:"dhx-scheduler",id:this.scheduler.id,mode:t.Day,tooltip:{template:"TTTTTTTT <span class='webix_strong'>Rating: <\/span> #rating#<br/>< span class='webix_strong' > Votes: <\/span> #votes#"},init:function(){function l(t){t.text="";var i=n.db.save({id:0,dateFrom:t.start_date,dateTo:t.end_date,clientComment:t.text,roomId:t.roomId,payForfeit:!0});return i.id}function r(n){return typeof n!="string"}var i=this._scheduler,h,c,s,e,u;f.dhtmlScheduler=i;i.config.xml_date="%c";i.config.load_date="%c";i.config.first_hour=0;i.config.last_hour=24.2;i.config.multi_day=!1;i.config.details_on_create=!1;i.config.edit_on_create=!1;i.config.time_step=60;i.config.drag_move=!0;i.config.drag_resize=!0;i.config.dblclick_create=!1;i.config.details_on_dblclick=!0;i.config.readonly=!n.logic.allowEditCalendar();i.xy.scale_height=40;i.locale.labels.confirm_deleting="";i.config.start_on_monday=!0;i.config.collision_limit=1;h=i.createUnitsView({name:t.Week,property:"roomId",list:i.serverList("units1",[]),days:7});c=i.createUnitsView({name:t.Day,property:"roomId",list:i.serverList("units2",[]),days:1});i.config.icons_select=["icon_details","icon_delete"];s=webix.Date.dateToStr("%d %M, %l",!1);e=function(n){return s(n)};i.templates.day_date=e;i.templates.weekrooms_second_scale_date=e;i.templates.event_class=n.logic.getEventCss;i.templates.event_header=function(n,t){return i.templates.event_date(n)+"-"+i.templates.event_date(t)};i.templates.event_text=n.logic.getEventTemplate;i.templates.month_scale_date=webix.Date.dateToStr("%l",!1);i.templates.event_bar_date=function(){return"aaaaaaa"};i.templates.month_text=function(){return"bbbbb"};i.templates.event_day=function(){return"cccc"};i.templates.event_bar_day=function(){return"ddddd"};i.attachEvent("onBeforeViewChange",function(n,t,i,r){if(r!=t)return f.currentDate=r,f.refresh(),!0});i.attachEvent("onBeforeEventCreated",function(){return n.logic.allowCreate()});i.attachEvent("onEventAdded",function(t,r){var u=f.baseList.getItem(),e=n.logic.allowCreate();e&&rooms.db.allowTime(r.start_date,r.end_date,r.roomId,u.id,u.domainId)?i.showLightbox(r.id):i.deleteEvent(t)});i.attachEvent("onBeforeEventChanged",function(n,t,i){return i||n.status===0?!0:(It.UI.w.error("Нельзя передвигать бронь со статусом"),!1)});i.attachEvent("onEventChanged",function(t,i){return r(i.id)?i:(n.db.save({id:i.id,dateFrom:i.start_date,dateTo:i.end_date,clientComment:i.text,roomId:i.roomId}),i)});i.attachEvent("onBeforeEventDelete",function(t,i){if(r(t))return!0;if(!n.logic.allowDelete(i))return alert("Нельзя удалять бронь"),!1;return confirm("Удалить бронь?")});i.attachEvent("onEventDeleted",function(t){r(t)||n.db.archive(t)});u=webix.ui({view:"popup",top:10,left:300,body:f.itemView.$config()});i.attachEvent("onClick",function(n,t){return u.show({x:t.clientX+10,y:t.clientY}),f.itemView.$reload(n),!1});f.itemView.OnEdit.on(function(n){return o.edit(n)});f.itemView.OnDelete.on(function(n){return i.deleteEvent(n)});i.showLightbox=function(t){var i=this.getEvent(t);if(!n.logic.allowLightboxEdit(i))return It.UI.w.error("Данную бронь запрещено редактировать");r(t)&&(t=l(i));u.isVisible()&&u.hide();o.edit(t)}},ready:function(){f.refresh();var n=document.getElementsByClassName("dhx_cal_today_button"),t=n.item(0);t.innerHTML=scheduler.locale.labels.dhx_cal_today_button}};return $u.rows($u.panelbar($u.tabs({id:t.Day,value:"День",width:60},{id:t.Week,value:"Неделя",width:60},{id:t.Month,value:"Месяц",width:70}).Size(300).OnChange(function(n){return e.setMode(n)}),$u.element("date").Label("На дату",null,80).AsDate().Ref(this.date).OnChange(function(n){return e.dateChange(n)}).Value(new Date).Size(200),$u.element("base").Label("База",null,50).AsSelect(s,"richselect").Ref(this.baseList).OnChange(function(){return e.refresh()}),$u.icon("arrow-left").Tooltip("Предыдущая база").Click(function(){return e.baseList.skipSelection(-1)}),$u.icon("arrow-right").Tooltip("Следующая база").Click(function(){return e.baseList.skipSelection(1)}),$u.icon("refresh").Tooltip("Перезачитать данные с сервера").Click(function(){return e.refresh()}),$u.icon("trash").Tooltip("Удалить брони без статуса").Click(function(){return e.clearOrders()})),h)},f.prototype.$init=function(){this.baseList.selectFirst();this.loaded=!0;setTimeout(function(){return i.require.disabled=!1},1e3)},f.prototype.$activate=function(n){u.prototype.$activate.call(this,n);n.base&&(this.dhtmlScheduler&&resizeBrowser(),this.baseList.setValue(n.base));n.date&&(this.currentMode=t.Day,this.date.setValue(parseDate(n.date)))},f.prototype.refresh=function(){var i=this.baseList.getItem(),o,r,f,s,h,c;if(i&&(n.db.calendarUpdates.reset("base-"+i.id),this.loaded&&this.dhtmlScheduler)){if(this.dhtmlScheduler.config.time_step=n.logic.getTimeStep(i),this.dhtmlScheduler.config.hour_size_px=n.logic.getHourSize(i),o=this.sections.filter(function(n){return n.base==i.id}).sort(function(n,t){return n.order-t.order}),this.dhtmlScheduler.updateCollection("units1",o),this.dhtmlScheduler.updateCollection("units2",o),this.dhtmlScheduler.deleteMarkedTimespan(),r=[0],f=0,this.currentMode==t.Day){var e=60,l=days.db.isWeekend(this.currentDate),u=l?i.weekendHours:i.workHours;u.forEach(function(n){n.from==f?(r.pop(),r.push(n.to*e)):(r.push(n.from*e),r.push(n.to*e));f=n.to});f==24?r.pop():r.push(24*e);s={days:"fullweek",zones:r};u&&u.length>0&&(this.dhtmlScheduler.config.first_hour=u[0].from,this.dhtmlScheduler.config.last_hour=u[u.length-1].to+.1);this.dhtmlScheduler.blockTime(s)}h=this.getLastDate();c=n.db.calendar(i.id,this.currentDate,h);this.dhtmlScheduler.clearAll();this.dhtmlScheduler.parse(c,"json");this.dhtmlScheduler._date&&this.dhtmlScheduler.updateView()}},f.prototype.getLastDate=function(){var n=this.currentDate;return this.currentMode==t.Week?n=n.addDays(6):this.currentMode==t.Month&&(n=n.addMonth(1)),n},f.prototype.checkUpdates=function(){var t=n.db.calendarUpdates.has();console.log("update",t);t&&(this.refresh(),webix.message("Календарь обновлен"))},f.prototype.dateChange=function(n){var t=this;this.currentDate=n;this.checkDate();this.dhtmlScheduler?this.dhtmlScheduler.setCurrentView(this.currentDate,this.currentMode):setTimeout(function(){return t.dateChange(n)},1e3)},f.prototype.clearOrders=function(){if(confirm("Удалить брони без статуса в календаре?")){var t=this.getLastDate(),i=this.baseList.getItem(),r=n.db.clearCalendar(i.id,this.currentDate,t);this.refresh()}},f.prototype.setMode=function(n){this.currentMode=n;this.checkDate();this.dhtmlScheduler.setCurrentView(this.currentDate.addDays(1/100),n);this.refresh()},f.prototype.checkDate=function(){this.currentMode==t.Week&&(this.currentDate=this.currentDate.addDays(1-this.currentDate.getDay()))},f}($u.View);n.CalendarView=u}(orders||(orders={})),function(n){var t=n.OrderAction,i=function(i){function r(){var n=i!==null&&i.apply(this,arguments)||this;return n.form=new $u.RefForm,n.createClientView=new clients.CreateView(n).onAction(function(t){return n.createClient(t)}),n.equipmentsView=new equipments.BalanceView(n),n.messagesView=new messages.ListView(n),n.label=new $u.RefUI,n.msgid="msg"+webix.uid(),n.alertBans=new $u.RefUI,n.alertForfeits=new $u.RefUI,n.transView=new trans.PartGridView(n),n.transid="trans"+webix.uid(),n.loaded=!1,n.buttons={client:new $u.RefUI,save:new $u.RefUI,reserv:new $u.RefUI,paid:new $u.RefUI,close:new $u.RefUI,cancel:new $u.RefUI,forfeitAsk:new $u.RefUI,forfeitConfirm:new $u.RefUI},n._options=groups.db.options(),n}return __extends(r,i),r.prototype.$config=function(){var n=this,u,r;i.prototype.$config.call(this);this.equipmentsView.onChange=function(){return n.calc()};u=system.context.allow(auth.oper.orderHistory);r=[{value:"Бронь",id:this.form.id},{value:"Транзакции",id:this.transid},];u&&r.push({value:"История",id:this.msgid});var f=$u.tabs.apply($u,r).Value(this.form.id).Size(130),e=[$u.button("Сохранить").Click(function(){return n.save(!0)}).Ref(this.buttons.save),$u.button("Резерв").Click(function(){return n.status(t.Reserv,"Потвердить резервирование?",!1,!1)}).Ref(this.buttons.reserv),$u.button("Оплатить").Click(function(){return n.status(t.Paid,"Подтвердить оплату?",!0,!0)}).Ref(this.buttons.paid).Type("green"),$u.button("Закрыть").Click(function(){return n.status(t.Close,"Закрыть бронь?",!0,!0)}).Ref(this.buttons.close).Type("green"),$u.button("Отмена").Click(function(){return n.status(t.CancelNormal,"Потвердить отмену без штрафа?",!1,!1)}).Ref(this.buttons.cancel).Type("danger"),$u.button("Неявка").Click(function(){return n.status(t.CancelForfeitAsk,"Отменить со штрафом (с запросом на подтверждение у диспетчера)?",!1,!1)}).Ref(this.buttons.forfeitAsk).Type("danger"),$u.button("Сбор/П").Click(function(){return n.status(t.CancelForfeitConfirm,"Подтвердить отмену со штрафом?",!1,!1)}).Ref(this.buttons.forfeitConfirm).Type("danger"),{},f,],o=[$u.cols(clients.getSearchColumn().OnChange(function(t){return n.clientUpdate(t)}),$u.icon("user-plus").Popup(this.createClientView.$config()).Ref(this.buttons.client).Tooltip("Создать клиента")),$u.element("comment").Label("Комментарий").AsTextArea(100),$u.element("clientComment").Label("Комментарий клиента").AsTextArea(100).Css("it-mark"),$u.label("Опции").Size(-1),$u.element("options").AsMultiSelect([]).OnChange(function(){return n.calc()}),$u.element("range").Label("Значение").AsInt().OnChange(function(){return n.calc()}),$u.element("equipments").Label("Позиции").AsMultiSelect([]).Visible(!1),$u.element("itemsJson").Visible(!1).Disable(),$u.label("Выберите позиции (укажите количество)",!1),this.equipmentsView.$config().extend({height:200}),$u.element("promoId").AsSelect(promo.db.names(!0,promo.PromoKind.Action)).Label("Промоакция","top").OnChange(function(){return n.calc()}),],s=[$u.element("payDate").Label("Дата оплаты").AsDate().Size(280),$u.element("date").Label("Дата брони").AsDate(!0).Disable(),$u.element("roomPrice").Label("Сум. репетиции").AsNumber().Disable(),$u.element("eqPrice").Label("Сум. позиции").AsNumber().Disable(),$u.element("discount").Label("Скидка, %").AsNumber().Disable(),$u.element("hotPromo").Label("Горящая репет.").Disable(),$u.element("promo").Label("Промокод").Disable(),$u.element("forfeit").Label("Штраф").AsNumber().Disable().Css("it-mark").Tooltip("Начисленный ранее штраф клиента"),$u.element("paidForfeit").Label("Штраф Опл.").AsNumber().Disable().Css("it-mark").Tooltip("Начисленный ранее штраф клиента"),$u.element("payForfeit").Label("Оплачивать штраф",null,150).AsCheckbox(!1).OnChange(function(){return n.calc()}),$u.element("balance").Label("Баланс").AsInt().Disable(),$u.element("isPointsPay").Label("Списать баллы",null,150).AsCheckbox(!1).OnChange(function(){return n.calc()}),$u.element("totals").Label("Общая стоим.").Css("it-warning").AsNumber().Disable(),$u.element("text").Label("Расчет").AsHtmlLabel(300).Css("it-scroll-y"),],h=this.form.config().extend({cols:[{rows:o,gravity:2},{width:20},{rows:s},]});return $u.rows({cols:e},$u.label("???").Ref(this.label),$u.template("  Клиент заблокирован у партнеров сервиса").Css("it-error").Ref(this.alertBans),$u.template("  Клиент имеет штраф у партнеров сервиса").Css("it-error").Ref(this.alertForfeits),$u.cells(h,this.messagesView.$config().Id(this.msgid),this.transView.$config().Id(this.transid)).Size(730,700),{gravity1111:.01}).Scrollable()},r.prototype.$reload=function(t){var u,r,f,e,o,s;return i.prototype.$reload.call(this,t),this.loaded=!1,u=this.form.elements.clientId.getPopup().getList(),u.clearAll(),r=this.form.load(n.db.getUrl(t)),this.loaded=!0,f=n.getOrderText(r),this.label.setValue("   "+f),this.alertBans.visible(r.hasBans),this.alertForfeits.visible(r.hasForfeits),e=equipments.db.balance(r.baseId,t,r.dateFrom,r.dateTo),this.equipments=e.sort(function(n,t){return t.n-n.n}),this.setEquipmentsFromItemsJson(r.itemsJson),this.equipmentsView.refresh(this.equipments),o={body:{yCount:50,data:this.equipments}},this.form.elements.equipments.define({suggest:o}),this.form.elements.equipments.refresh(),s=this._options.filter(function(n){return n.bases.indexOf(r.baseId)>-1}),this.form.setElement("options",{suggest:s,readonly:!1}),this.calc(),this.applyUI(r),this.messagesView.filter.order=t,this.messagesView.setDefaults({orderId:t}),this.messagesView.refresh(),this.transView.reload({orderId:t}),r},r.prototype.applyUI=function(t){var i=n.logic,e=t.isHold,r=!e&&i.allowEditOrder(t),u=r,f=r&&i.allowEditClient(t);this.form.enable(r);this.buttons.forfeitAsk.enable(r);this.buttons.forfeitConfirm.enable(r);this.buttons.paid.enable(r);this.buttons.reserv.enable(r);this.buttons.save.enable(r||i.allowFullAccess());this.form.enable(i.allowGroup(t),"options");this.form.enable(f,"clientId");this.buttons.client.enable(f);this.form.enable(u,"equipments");this.equipmentsView.enable(u);this.form.enable(u&&i.allowEditPaidForfeit(t),"payForfeit");this.form.visible(i.allowViewPromo(t),"promoId");this.form.enable(i.allowEditPromo(t),"promoId");this.form.enable(i.allowPoints(t),"isPointsPay");this.form.enable(i.allowEditPayDate(t),"payDate");this.buttons.reserv.visible(i.allowDoReserv(t));this.buttons.cancel.visible(i.allowDoCancel(t));this.buttons.forfeitAsk.visible(i.allowDoForfeit(t));this.buttons.forfeitConfirm.visible(i.allowDoForfeitConfirm(t));this.buttons.close.visible(i.allowDoClose(t));this.buttons.paid.visible(i.allowDoPaid(t))},r.prototype.status=function(i,r,u,f){var s,e,o;if(this.form.validate()&&confirm(r)){if(!this.save(!1))return webix.message("Ошибка валидации данных");if(s=this.form.values(),e={},u){if(e=n.db.setStatus(this.objectId,t.Reserv),f&&e.paidForfeit!=e.forfeit&&(o=confirm("Сумма сборов изменилась и составила ".concat(e.forfeit," руб. Продолжить операцию? ")),!o))return;if(f&&e.totalSum!=e.originTotalSum&&(o=confirm("Итоговая стоимость изменилась и составила ".concat(e.totalSum," руб. Продолжить операцию? ")),!o))return}if(e=n.db.setStatus(this.objectId,i),e.errors){It.UI.error(e.errors);return}this.form.setValuesEx(e);n.db.save({id:this.objectId,originTotalSum:e.totalSum});this.close()}},r.prototype.save=function(t){if(!this.calc())return!1;var i=this.form.values(),r={id:i.id,clientId:i.clientId,comment:i.comment,clientComment:i.clientComment,options:i.options,promoId:i.promoId,roomId:i.roomId,baseId:i.baseId,status:i.status,reason:i.reason,equipments:i.equipments,itemsJson:i.itemsJson,discount:i.discount,eqPrice:i.eqPrice,roomPrice:i.roomPrice,payForfeit:i.payForfeit,isPointsPay:i.isPointsPay,payDate:i.payDate,isHold:i.isHold,range:i.range,save:!0,retrans:t};return t&&(r.originTotalSum=i.totalSum),n.db.save(r),webix.message("Данные сохранены на сервере"),t&&this.close(),!0},r.prototype.calc=function(){var t,r,i,u,f;if(!this.loaded)return!1;try{if(this.loaded=!1,t=this.form.values(),r=n.logic.allowEditOrder(t),r)u=this.getItemsJson(),this.form.elements.itemsJson.setValue(u),t=this.form.save(n.db.calcUrl,!0),this.form.elements.totals.setValue(t.totalSum);else{i="Пересчет заблокирован, бронь без статуса или давно оплачена";webix.message(i);this.form.elements.text.setValue(i);return}if(this.applyUI(t),t.errors)return f=t.errors,It.UI.w.info(f.replace("\r\n","<hr/>")),!1}finally{this.loaded=!0}return!0},r.prototype.close=function(){this.onclose&&this.onclose()},r.prototype.createClient=function(){var n={id:this.createClientView.clientObject.id,value:this.createClientView.values.firstName};this.form.setValuesEx({clientId:n.id});this.form.elements.clientId.setValue(n)},r.prototype.clientUpdate=function(n){if(n&&n!="00000000-0000-0000-0000-000000000000"&&!n.id){var t=clients.db.get(n);if(t.isBanned)return this.form.setValuesEx({clientId:null}),It.UI.w.error("Клиент заблокирован!");this.form.setValuesEx({discount:t.discount,promo:t.promoCode,forfeit:t.forfeit,payForfeit222:!!t.forfeit,balance:t.balance});this.calc()}},r.prototype.getItemsJson=function(){var t=this.equipments,n=t.filter(function(n){return n.n>0}).map(function(n){return{eq:n.id,n:Math.min(n.count,n.n)}});return n.length==0?"":JSON.stringify(n)},r.prototype.setEquipmentsFromItemsJson=function(n){if(n){var t=this.equipments,i=JSON.parse(n);i.forEach(function(n){if(n.eq){var i=t.find(function(t){return t.id==n.eq});i&&(i.n=n.n)}})}},r}($u.View);n.EditView=i}(orders||(orders={})),function(n){var t=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i.grid=new $u.RefGrid,i.filterForm=new $u.RefForm,i.editor=new n.OrderEditor,i}return __extends(i,t),i.prototype.$config=function(){var i=this;t.prototype.$config.call(this);It.Web.loadJS("lib/webix-ext/xlsx.core.min.js");var u=n.logic,f=this.grid.config().extend({scrollAlignY:!0,scrollX:!0,leftSplit:1,columns:[$u.column("idd").Header("*",30).Template("&#128197;".link("{common.href}/orders/calendar/?base=#baseId#&date=#dateFrom#")),$u.column("client").Header("Клиент",150).Sort().Template(clients.getClientColumnTemplate()).Filter(),$u.column("sourceType").AsSelect(n.sourceTypes).Header("Источник").Sort().Filter(),$u.column("isPrepay").Header("Пред").AsCheckboxReadly(),$u.column("dateFrom").Header("Дата").AsDate().Sort(),$u.column("baseId").AsSelect(bases.db.names(!0)).Header("База",140).Sort().Filter(),$u.column("roomId").AsSelect(rooms.db.namesUrl).Header("Комната",140).Sort().Filter(),$u.column("promo").Header("Промокод",50).Sort().Filter(),$u.column("hours").Header("Часов",50).AsInt().Sort().Footer({content:"summColumn"}),$u.column("totalSum").AsInt().Header("Стоимость",70).AsNumber().Sort().Footer({content:"summColumn"}),$u.column("discounts").AsInt().Header("Скидка",70).AsInt().Sort().Footer({content:"summColumn"}),$u.column("eqSum").AsInt().Header("Доп.",70).AsInt().Sort().Footer({content:"summColumn"}),$u.column("comment").Header("Комментарий",100).Filter(),$u.column("clientComment").Header("Комм.клиента",100).Filter(),$u.column("status").AsSelect(n.statuses).Header("Статус",100).Sort().Filter(),$u.column("options").Header("Опции",180).Sort().Filter(),$u.column("reason").AsSelect(n.cancelReasons).Header("Отмена",100).Sort().Filter(),],scheme:{$init:function(n){n.date=parseDate(n.date);u.getStateCss(n)}}}).Tooltip("<h3>#client#<\/h3><hr/><blockquote>#comment# #clientComment#<br/>#options#<\/blockquote>").Footer(),r=new Date,e=this.filterForm.config().extend({width:400,elements:[$u.element("search").Label("Названия"),$u.element("dfrom").Label("Дата с").AsDate().Value(r.addDays(-7)),$u.element("dto").Label("По").AsDate().Value(r),$u.element("base").Label("База").AsSelect(bases.db.names(!0)),$u.element("promo").Label("Промокод","top").AsSelect(promo.db.names(!0,promo.PromoKind.Action)),$u.element("status").Label("Статус документа").AsSelect(n.statuses),$u.element("option").Label("Опция").AsSelect(groups.db.options()),$u.element("sources").Label("Источники").AsMultiSelect(n.sourceKinds),$u.element("eqtypes").Label("Тип позиции").AsMultiSelect(groups.db.names(groups.GroupType.Equipment)),$u.element("eqs").Label("Позиции").AsMultiSelect(equipments.db.names()),$u.element("sourceTypes").Label("Типы источн.").AsMultiSelect(n.sourceTypes),$u.element("prepay").Label("Только предоплата").AsCheckbox(),$u.cols($u.button("Найти").Click(function(){return i.refresh()}).Tooltip("Пересчитать данные и обновить отчет"),$u.button("Очистить").Click(function(){return i.filterForm.clear()})),]});return $u.rows($u.cols($u.button("Поиск").Popup(e),$u.button("Открыть").Click(function(){return i.open()}),$u.icon("file-excel-o").Click(function(){return i.exportxlsx()}).Tooltip("Экспортировать в Ексел"),{}),f)},i.prototype.refresh=function(){var t=this.filterForm.values(),i=n.db.search(t);this.grid.refresh(i);webix.message("Отчет обновлен")},i.prototype.open=function(){var n=this.grid.getSelectedItem();n&&this.editor.edit(n.id)},i.prototype.exportxlsx=function(){this.grid.toExcel({filename:"orders-"+(new Date).toLocaleDateString("ru"),name:"orders",filterHTML:!0,columns:[{id:"client",header1:"ККК"},{id:"sourceType"},{id:"dateFrom"},{id:"baseId"},{id:"roomId"},{id:"promo"},{id:"houurs"},{id:"totalSum",exportType:"number"},{id:"discounts",exportType:"number"},{id:"eqSum",exportType:"number",exportFormat1:"#-##0.00"},{id:"status"},]});console.log("export xlsx")},i}($u.View);n.FilterGridView=t}(orders||(orders={})),function(n){var t=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i.grid=new $u.RefGrid,i.editor=new n.OrderEditor(function(){return i.refresh()}),i.timerid=setInterval(function(){return i.checkUpdates()},6e4),i}return __extends(i,t),i.prototype.checkUpdates=function(){var t=n.db.forfeitUpdates.has();t&&(n.db.forfeitUpdates.reset(),It.UI.w.info("Получен новый штраф для подтверждения"))},i.prototype.$config=function(){var i=this,r,u;return t.prototype.$config.call(this),n.db.forfeitUpdates.reset("forfeit-"+system.context.domainId),r=this.grid.config().extend({columns:[$u.column("date").Header("Дата").AsDate().Sort().Filter(),$u.column("baseId").AsSelect(bases.db.names(!0)).Header("База",-1).Sort().Filter(),$u.column("roomId").AsSelect(rooms.db.namesUrl).Header("Комната",-1).Sort().Filter(),$u.column("fullForfeit").AsInt().Header("Штраф").Sort(),$u.column("totalSum").AsInt().Header("Стоимость").Sort(),$u.column("types").Header("Позиции",-1).Sort().Filter(),$u.column("client").Header("Клиент",-1).Sort().Filter().Template(clients.getClientColumnTemplate()),$u.column("text").Header("Описание",-1).Filter(),],scheme:{$init:function(n){n.date=parseDate(n.date)}}}),u=$u.rows($u.panelbar(this.grid.btnRefresh(function(){return i.refresh()}),$u.button("Открыть").Click(function(){return i.open()}),{}),r),u},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.refresh()},i.prototype.refresh=function(){var t=n.db.list({status1:n.OrderStatus.Reserv,reason:n.CancelReason.ForfeitsAsk});this.grid.refresh(t);webix.message("Данные обновлены")},i.prototype.open=function(){var n=this.grid.getSelectedItem();n&&this.editor.edit(n.id)},i}($u.View);n.AskGridView=t}(orders||(orders={})),function(n){var t=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i.grid=new $u.RefGrid,i.editor=new n.OrderEditor(function(){return i.refresh()}),i}return __extends(i,t),i.prototype.$config=function(){var n=this,i,r;return t.prototype.$config.call(this),i=this.grid.config().extend({columns:[$u.column("date").Header("Дата").AsDate().Sort(),$u.column("time").Header("Время"),$u.column("baseId").AsSelect(bases.db.names(!0)).Header("База",-1).Sort().Filter(),$u.column("roomId").AsSelect(rooms.db.namesUrl).Header("Комната",-1).Sort().Filter(),$u.column("forfeit").AsInt().Header("Штраф").Sort().Footer({content:"summColumn"}),$u.column("totalSum").AsInt().Header("Стоимость").Sort().Footer({content:"summColumn"}),$u.column("types").Header("Позиция",-1).Sort().Filter(),$u.column("client").Header("Клиент",-1).Sort().Filter().Template(clients.getClientColumnTemplate()),$u.column("text").Header("Описание",-1).Filter(),],scheme:{$init:function(n){n.date=parseDate(n.date)}}}).Footer(),r=$u.rows($u.panelbar(this.grid.btnRefresh(function(){return n.refresh()}),$u.button("Открыть").Click(function(){return n.open()}),{}),i),r},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.refresh()},i.prototype.refresh=function(){var t=n.db.list({forfeits:!0,reason1111:n.CancelReason.ForfeitsConfirmed});this.grid.refresh(t);webix.message("Данные обновлены")},i.prototype.open=function(){var n=this.grid.getSelectedItem();n&&this.editor.edit(n.id)},i}($u.View);n.ForfeitsGridView=t}(orders||(orders={})),function(n){function e(n){var t=It.dateDiff.inHoursAbs(n);return t<=24}function u(n){var t=order_rules.db.canCancelBase(n.baseId,n.date,n.dateFrom);return t.allow}var i=auth.oper,r=n.OrderStatus,t=function(){return system.context.isSuper||system.context.allow(i.orderFullAccess)},f=function(){function f(){this.allowFullAccess=function(){return t()};this.allowAnyReportDay=function(){return t()||system.context.allow(i.anyReportDate)};this.allowEditCalendar=function(){return t()||system.context.allow(i.orderEdit)};this.allowCreate=function(){return t()||system.context.allow(i.orderNew)};this.allowLightboxEdit=function(n){return t()||!n.abonementId};this.allowDelete=function(n){return t()||n.status==r.Unknow||n.status!=r.Closed&&system.context.allow(i.orderDelete)};this.allowEditOrder=function(n){return t()||!n.isHold||system.context.allow(i.orderCancelAny)};this.allowEditPaidForfeit=function(n){return n.fullForfeit&&n.fullForfeit!="0"&&(t()||n.status!=r.Closed)};this.allowEditClient=function(n){return!n.clientId};this.allowGroup=function(){return t()||system.context.allow(i.orderEditGroup)};this.allowRemoveEquipments=function(n){return t()||n.status!=r.Closed};this.allowFullForfeit=function(t){return t.fullForfeit&&t.status==r.Cancel&&t.reason==n.CancelReason.ForfeitsAsk};this.allowViewPromo=function(){return t()||system.context.allow(i.orderPromo)};this.allowEditPromo=function(n){return t()||n.status!=r.Closed};this.allowEditPayDate=function(){return t()};this.allowHold=function(n){return n.status==r.Unknow};this.allowPoints=function(){return t()||system.context.allow(i.orderPoints)};this.allowDoReserv=function(n){return t()||system.context.allow(i.orderReserv)&&(n.status==r.Unknow||n.status==r.Cancel)};this.allowDoCancel=function(n){return t()||system.context.allow(i.orderCancelAny)||system.context.allow(i.orderCancel)&&u(n)};this.allowDoCancel_test=function(n){return t()||u(n)};this.allowDoForfeit=function(n){return t()||n.status==r.Reserv&&e(n.dateFrom)};this.allowDoForfeitConfirm=function(r){return t()||r.reason==n.CancelReason.ForfeitsAsk&&system.context.allow(i.orderForfeit)};this.allowDoPaid=function(n){return t()||n.status==r.Reserv&&system.context&&system.context.allow(i.orderPay)&&n.totalPays!=n.totalSum};this.allowDoClose=function(n){return t()||n.status==r.Reserv&&system.context&&system.context.allow(i.orderPay)&&n.totalPays==n.totalSum}}return f.prototype.getHourSize=function(){return 44},f.prototype.getTimeStep=function(n){return!n,60},f.prototype.getEventTemplate=function(t,i,r){var u="",s=(r.text+"").trim(),o,e;s!=""&&(u+="<span class='fa fa-comment'/> ");switch(r.sourceType){case n.SourceType.Mobile:case n.SourceType.Catalog:u+="<span class='fa fa-mobile' />";break;case n.SourceType.Widget:u+="<span class='fa fa-table' />";break;case n.SourceType.Bot:u+="<span class='fa fa-comments' />"}return r.abonementId&&(u+="<span class='fa fa-calendar' />".link("#!/abonements/edit/?oid=".concat(r.abonementId))),o="<span class='fa ".concat(f.GROUPS[r.group],"' ><\/span>"),u+=r.clientId&&system.context.allow(auth.oper.clients)?"<a href='#!/clients/edit?oid=".concat(r.clientId,"'>").concat(r.name,"<\/a>"):"".concat(r.name),u+=",".concat(o," ").concat(r.totalSum," руб. (опл ").concat(r.totalPays,", в тч ").concat(r.paidForfeit," штраф) ").concat(r.types),e=(r.text+"").trim(),e&&(u+=" [<i>".concat(e,"<\/i>]")),u},f.prototype.getEventCss=function(n,t,i){var r="it-event it-status-"+i.status;return i.payDate&&(r+=" it-status-p"),r},f.prototype.getStateCss=function(n){n&&n.status&&(n.$css="it-status-"+n.status);n&&n.payDate&&(n.$css+=" it-status-p")},f.prototype.getRequstStateCss=function(n){n&&n.requestStatus&&(n.$css="it-reqstatus-"+n.requestStatus)},f.GROUPS=["question","fa-user","fa-user-plus","fa-users"],f}();n.logic=new f}(orders||(orders={})),function(n){var t=function(){function t(t){var i=this;this.onclose=t;this.detailsView=new n.EditView;this.win=new $u.RefWin("Редактирование брони");this.win.resize=!1;this.detailsView.onclose=function(){return i.closeEditor()};this.win.config(this.detailsView.$config())}return t.prototype.edit=function(n){if(!n||typeof n!="string")return It.UI.w.error("Не выделен или не сохранен текущий заказ!");this.win.show();var t=this.detailsView.$reload(n);this.win.setHead("Карточка брони")},t.prototype.closeEditor=function(){this.win.hide();this.onclose&&this.onclose()},t}();n.OrderEditor=t}(orders||(orders={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n}return __extends(i,t),i.prototype.$config=function(){var i=this,r,u;return t.prototype.$config.call(this),r=this.grid.config().extend({columns:[$u.column("idd").Header("*",30).Template($u.getViewLink("orders")),$u.column("client").Header("Клиент",-2).Sort().Template(clients.getClientColumnTemplate()).Filter(),$u.column("dateFrom").Header("Дата").AsDate().Sort(),$u.column("domain").Header("Партнер",-1).Sort().Filter(),$u.column("base").Header("База",-1).Sort().Filter(),$u.column("room").Header("Комната",-1).Sort().Filter(),$u.column("hours").Header("Часов",50).AsInt().Sort().Footer({content:"summColumn"}),$u.column("totalSum").AsInt().Header("Стоимость",80).AsInt().Sort().Footer({content:"summColumn"}),$u.column("discounts").AsInt().Header("Скидка",80).AsInt().Sort().Footer({content:"summColumn"}),$u.column("mobComm").AsInt().Header("Комиссия",80).AsInt().Sort().Footer({content:"summColumn"}),$u.column("ignoreMobComm").Header("0-Ком").AsCheckbox().Sort().Visible(system.context.isSuper),$u.column("text").Header("Описание",-1),$u.column("status").AsSelect(n.statuses).Header("Статус",80).Sort().Filter(),$u.column("reason").AsSelect(n.cancelReasons).Header("Отмена",80).Sort().Filter(),$u.column("sourceType").AsSelect(n.sourceTypes).Header("Источник",80).Sort().Filter(),$u.column("idd").Header("*",30).Template("&#128197;".link("{common.href}/orders/calendar/?base=#baseId#&date=#dateFrom#")),],scheme:{$init:function(t){t.date=parseDate(t.date);n.logic.getStateCss(t)}},save:n.db.commissionUrl()}).Tooltip("#client#<div/>Скидка: #discount#%<p/>#text#").Footer(),u=$u.rows($u.panelbar($u.button("Обновить").Click(function(){return i.$reload(i.objectId)}),{},$u.label("Статистика по связанным заказам для Суперадмина  ")),r),u},i.prototype.$reload=function(i){var r,u;t.prototype.$reload.call(this,i);r=webix.copy(this.args);delete r.view;delete r.oid;delete r.module;r.archive=!0;u=n.db.search(r);this.grid.refresh(u);webix.message("Данные обновлены")},i}($u.View);n.SearchSuperView=t}(orders||(orders={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n}return __extends(i,t),i.prototype.$config=function(){var i=this,r,u;return t.prototype.$config.call(this),r=this.grid.config().extend({columns:[$u.column("idd").Header("*",30).Template($u.getViewLink("orders")),$u.column("client").Header("Клиент",-2).Sort().Template(clients.getClientColumnTemplate()).Filter(),$u.column("dateFrom").Header("Дата").AsDate().Sort(),$u.column("base").Header("База",-1).Sort().Filter(),$u.column("room").Header("Комната",-1).Sort().Filter(),$u.column("hours").Header("Часов",50).AsInt().Sort().Footer({content:"summColumn"}),$u.column("totalSum").AsInt().Header("Стоимость",80).AsInt().Sort().Footer({content:"summColumn"}),$u.column("discounts").AsInt().Header("Скидка",80).AsInt().Sort().Footer({content:"summColumn"}),$u.column("mobComm").AsInt().Header("Комиссия",80).AsInt().Sort().Footer({content:"summColumn"}),$u.column("ignoreMobComm").Header("0-Ком").AsCheckbox().Sort().Visible(system.context.isSuper),$u.column("text").Header("Описание",-1),$u.column("status").AsSelect(n.statuses).Header("Статус",80).Sort().Filter(),$u.column("reason").AsSelect(n.cancelReasons).Header("Отмена",80).Sort().Filter(),$u.column("sourceType").AsSelect(n.sourceTypes).Header("Источник",80).Sort().Filter(),$u.column("idd").Header("*",30).Template("&#128197;".link("{common.href}/orders/calendar/?base=#baseId#&date=#dateFrom#")),],scheme:{$init:function(t){t.date=parseDate(t.date);n.logic.getStateCss(t)}},save:n.db.commissionUrl()}).Tooltip("#client#<div/>Скидка: #discount#%<p/>#text#").Footer(),u=$u.rows($u.panelbar($u.button("Обновить").Click(function(){return i.$reload(i.objectId)}),{},$u.label("Статистика по связанным заказам    ")),r),u},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.first||this.$reload(this.objectId)},i.prototype.$reload=function(i){var r,u;t.prototype.$reload.call(this,i);r=webix.copy(this.args);delete r.view;delete r.oid;delete r.module;r.archive=!0;u=n.db.search(r);this.grid.refresh(u);webix.message("Данные обновлены")},i}($u.View);n.SearchView=t}(orders||(orders={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n.filterForm=new $u.RefForm,n}return __extends(i,t),i.prototype.$config=function(){var i=this;t.prototype.$config.call(this);var r=this.grid.config().extend({columns:[$u.column("idd").Header("*",30).Template($u.getViewLink("orders")),$u.column("client").Header("Клиент",200).Sort().Template(clients.getClientColumnTemplate()).Filter(),$u.column("date").Header("Дата").AsDate().Sort(),$u.column("dateFrom").Header("Дата бр").AsDate().Sort(),$u.column("payDate").Header("Дата опл").AsDate().Sort(),$u.column("baseId").AsSelect(bases.db.names(!0)).Header("База",100).Sort().Filter(),$u.column("roomId").AsSelect(rooms.db.namesUrl).Header("Комната",100).Sort().Filter(),$u.column("hours").Header("Часов",50).AsInt().Sort().Footer({content:"summColumn"}),$u.column("totalSum").AsInt().Header("Стоимость",80).AsInt().Sort().Footer({content:"summColumn"}),$u.column("discounts").AsInt().Header("Скидка",80).AsInt().Sort().Footer({content:"summColumn"}),$u.column("mobComm").AsInt().Header("Комиссия",80).AsInt().Sort().Footer({content:"summColumn"}),$u.column("ignoreMobComm").Header("0-Ком").AsCheckbox().Sort().Visible(system.context.isSuper),$u.column("status").AsSelect(n.statuses).Header("Статус",80).Sort().Filter(),$u.column("reason").AsSelect(n.cancelReasons).Header("Отмена",80).Sort().Filter(),$u.column("sourceType").AsSelect(n.sourceTypes).Header("Источник",80).Sort().Filter(),$u.column("idd").Header("*",30).Template("&#128197;".link("{common.href}/orders/calendar/?base=#baseId#&date=#date#")),$u.column("text").Header("Описание",500),],scrollAlignY:!0,scrollX:!0,leftSplit:3,scheme:{$init:function(t){t.date=parseDate(t.date);n.logic.getStateCss(t)}},save:n.db.commissionUrl()}).Tooltip("#client#<div/>Скидка: #discount#%<p/>#text#").Footer(),u=this.filterForm.config().extend({cols:[$u.element("dFrom").Label("С",null,20).AsDate().Size(130),$u.element("dTo").Label("По",null,30).AsDate().Size(137),]});return $u.rows($u.panelbar($u.button("Обновить").Click(function(){return i.$reload(i.objectId)}),u,{},$u.label("Связанные брони")),r)},i.prototype.$init=function(){t.prototype.$init.call(this);var n=new Date,r=1-n.getDate(),i=n.addDays(r);this.filterForm.setValuesEx({dFrom:i,dTo1:i.addMonth(1).addDays(-1)})},i.prototype.$reload=function(i){var r,u,f;t.prototype.$reload.call(this,i);r=webix.copy(this.args);delete r.view;delete r.oid;delete r.module;u=this.filterForm.values();webix.extend(r,u,!0);r.archive=!0;f=n.db.search(r);this.grid.refresh(f)},i}($u.View);n.SearchAllView=t}(orders||(orders={})),function(n){var i=function(i){function r(){var n=i!==null&&i.apply(this,arguments)||this;return n.header=new $u.RefTemplate,n.logic=new t,n.alert=new $u.RefUI,n.OnEdit=new It.Event,n.OnDelete=new It.Event,n}return __extends(r,i),r.prototype.$config=function(){var n=this,t=$u.header("Просмотр брони",$u.button("Редактировать").Click(function(){return n.edit()}),$u.button("Удалить").Click(function(){return n.delete()}).Ref(this.logic.ref(this.logic.states.delete)),$u.icon("close").Click(function(){return n.hide()})),i=this.form.config().Labels(120).extend({elements:[t,this.header.config("AAA").Size(-1,40).Css("it-header"),$u.cols($u.rows($u.element("equipments").Label("Позиции","top").AsTextArea(400),$u.element("options").Label("Опции","top").AsMultiSelect(groups.db.options())),$u.rows($u.element("comment").Label("Комментарий").AsTextArea(100),$u.element("discount").Label("Скидка, %").AsInt(),$u.element("clientForfeit").Label("Прошлый штраф").AsNumber(),$u.element("totalSum").Label("Cтоимость общ").Css("it-warning").AsNumber())),$u.template("  Клиент заблокирован или имеет штраф у партнеров сервиса").Css("it-error").Ref(this.alert),]}).Readonly(!0);return i.Size(600)},r.prototype.$reload=function(t){var r,u,f,e;i.prototype.$reload.call(this,t);r=n.db.get(t);r.comment+=" "+r.clientComment;r.itemsJson?(u=JSON.parse(r.itemsJson),f=equipments.db.names(),r.equipments=u.map(function(n){return"- ".concat(f.findById(n.eq,{}).value," x").concat(n.n)}).join("\n")):r.equipments="";this.form.setValues(r);e=n.getOrderText(r);this.header.set({template:e});this.logic.check(r);this.alert.visible(r.hasBans||r.hasForfeits)},r.prototype.edit=function(){this.hide();this.OnEdit.call(this.objectId)},r.prototype.delete=function(){this.hide();this.OnDelete.call(this.objectId)},r}($u.PopupView),t;n.ItemView=i;t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.states={"delete":1},n}return __extends(i,t),i.prototype.check=function(t){this.enable(this.states.delete,t.status==n.OrderStatus.Unknow)},i}($u.UIManager)}(orders||(orders={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.filterForm=new $u.RefForm,n.pivot=new $u.RefPivot,n}return __extends(i,t),i.prototype.$config=function(){var i=this;t.prototype.$config.call(this);var r=n.logic.allowAnyReportDay(),u=this.filterForm.config().extend({cols:[$u.button("Сбросить").Click(function(){return i.pivot.clearConfig(!0)}).Tooltip("Сбросить настройки"),$u.element("dfrom").Label("Дата с",null,50).Size(170).AsDate().Disable(!r),$u.element("dto").Label("По",null,40).Size(170).AsDate().Disable(!r),$u.icon("refresh").Click(function(){return i.refresh()}).Tooltip("Пересчитать данные и обновить отчет"),$u.icon("file-excel-o").Click(function(){return i.export()}).Tooltip("Экспортировать в Ексел").Hidden(!r),{},]}),f=this.pivot.config().extend({columnWidth:80,fieldMap:{baseSphere:"Сфера",group:"Статья",base:"База",room:"Комната",totals:"Сумма",totalsOnline:"ОплБанк",totalsCache:"ОплНал/з",totalsBack:"Возвр.Нал",totalsBackPred:"Возвр.Пред",fullTotals:"Полн сумма",discounts:"Скидки",user:"Автор",source:"Источник",dayStr:"День",channel:"Канал"},scheme:{},structure:{filters:[{name:"baseSphere",type:"select"},{name:"group",type:"select"},{name:"source",type:"select"},],columns:[{id:"dayStr",header:"День",sort:"string"},],values:[{name:"totals",operation:"sum"},],rows:["baseSphere","base","room","group"]}});return $u.rows(u,f)},i.prototype.$init=function(){var n,i;t.prototype.$init.call(this);n=new Date(Date.now());n=webix.Date.weekStart(n);i={dfrom:n,dto:n.addDays(6)};this.filterForm.setValuesEx(i);this.pivot.setConfig("pivot.orders.totals")},i.prototype.refresh=function(){var t=this.filterForm.values(),i=n.db.totals(t.dfrom,t.dto);this.pivot.refresh(i);webix.message("Отчет обновлен")},i.prototype.export=function(){var n={filename:"totals "+(new Date).toLocaleDateString("ru"),name:"totals",filterHTML:!0};this.pivot.toExcel(n)},i}($u.View);n.TotalsView=t}(orders||(orders={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.filterForm=new $u.RefForm,n.pivot=new $u.RefPivot,n}return __extends(i,t),i.prototype.$config=function(){var r=this;t.prototype.$config.call(this);var i=n.logic.allowAnyReportDay(),u=this.filterForm.config().extend({cols:[$u.button("Сбросить").Click(function(){return r.pivot.clearConfig(!0)}).Tooltip("Сбросить настройки"),$u.element("dfrom").Label("Дата с",null,50).Size(170).AsDate().Disable(!i),$u.element("dto").Label("По",null,40).Size(170).AsDate().Disable(!i),$u.element("pfrom").Label("Оплата с",null,60).Size(170).AsDate().Disable(!i),$u.element("pto").Label("По",null,40).Size(170).AsDate().Disable(!i),$u.icon("refresh").Click(function(){return r.refresh()}).Tooltip("Пересчитать данные и обновить отчет"),$u.icon("file-excel-o").Click(function(){return r.export()}).Tooltip("Экспортировать в Ексел").Hidden(!i),{},]}),f=this.pivot.config().extend({columnWidth:80,fieldMap:{domain:"Партнер",sphere:"Сфера",users:"Ответственные",type:"Тип",total:"Сумма"},scheme:{},structure:{filters:[],rows:["domain","sphere","users",],values:[{name:"total",operation:"sum"},],columns:["type",]}});return $u.rows(u,f)},i.prototype.$init=function(){var n,i;t.prototype.$init.call(this);n=new Date(Date.now());n=webix.Date.weekStart(n);i={dfrom:n,dto:n.addDays(6),pfrom:n,pto:n.addDays(6)};this.filterForm.setValuesEx(i);this.pivot.setConfig("pivot.orders.totalscom")},i.prototype.refresh=function(){var t=this.filterForm.values(),i=n.db.totalscom(t);this.pivot.refresh(i);webix.message("Отчет обновлен")},i.prototype.export=function(){var n={filename:"totals "+(new Date).toLocaleDateString("ru"),name:"totals",filterHTML:!0};this.pivot.toExcel(n)},i}($u.View);n.TotalsComView=t}(orders||(orders={})),function(n){var t=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i.full=!1,i.grid=new $u.RefGrid,i.editForm=new n.EditForm,i}return __extends(i,t),i.prototype.$config=function(){var i=this,e,r,u,f;return t.prototype.$config.call(this),e=this,r=promo.db.names(!0,promo.PromoKind.Rules),this.editForm.full=this.full,u=this.grid.config().extend({columns:[$u.column("isArchive").Header("Арх").AsCheckbox().Sort().Edit(),$u.column("baseId").Header("База",130).AsSelect(bases.db.namesUrl).Sort().Filter().Visible(this.full),$u.column("roomId").Header("Комната",100).AsSelect(rooms.db.namesUrl).Sort().Filter().Visible(this.full),$u.column("timeFrom").AsInt().Header("С",40).Sort(),$u.column("timeTo").AsInt().Header("По",40).Sort(),$u.column("workingFPrice").AsInt().Header("Перв.Раб",50).Sort(),$u.column("workingPrice").AsInt().Header("Рабочие",50).Sort(),$u.column("workingLPrice").AsInt().Header("Посл.Раб",50).Sort(),$u.column("weekend1Price").AsInt().Header("СБ",50).Sort(),$u.column("weekend2Price").AsInt().Header("ВС",50).Sort(),$u.column("promoId").Header("Условие").AsSelect(r).Sort().Filter().Edit(),$u.column("description").Header("Описание",-1).Filter(),],scheme:{timeFrom:0,timeTo:24,workingLPrice:0,workingPrice:0,workingFPrice:0,weekend1Price:0,weekend2Price:0},save:n.db.getSaveCfg(!0)}).Editable(),f=$u.rows($u.toolbar($u.label("Список цен"),this.grid.btnAdd(),this.grid.btnDel(),this.grid.btnRefresh(function(){return i.reload2(null,null)}),{},$u.icon("save").Click(function(){return i.save()})),$u.cols(u,$u.splitter(),this.editForm.config())),f},i.prototype.$init=function(){this.editForm.form.bind(this.grid)},i.prototype.reload2=function(i,r){var u,f;return t.prototype.$reload.call(this,i),u={timeFrom:0,timeTo:24,workingLPrice:0,workingPrice:0,workingFPrice:0,weekend1Price:0,weekend2Price:0,roomId:i,baseId:r},this.grid.scheme(u),f=n.db.list_items(i,r),this.grid.refresh(f),this},i.prototype.save=function(){this.editForm.form.updateBindings()},i}($u.View);n.GridView=t}(prices||(prices={})),function(n){n.create={grid:function(){var t=new n.GridView;return t.onactivate=function(){return t.reload2(null,null)},t.full=!0,t}};var t=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.list_items=function(n,i){return t.list({room:n,base:i})},t.baseItems=function(n){return t.load("baseItems",{base:n})},t}return __extends(t,n),t}(app.AppDataSource);n.db=new t("prices")}(prices||(prices={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.filter={},n.grid=new $u.RefGrid,n.filterView=new $u.RefForm,n}return __extends(i,t),i.prototype.$config=function(){var t=this,i=system.context.allowCrmEdit(),r=this.grid.config().extend({columns:[$u.column("idd").Header("",30).Template($u.getViewLink("orders")).Visible(i),$u.column("date").Header("Дата").AsDate(webix.i18n.dateFormatStr).Sort().Filter(),$u.column("domainId").AsSelect(domains.db.names()).Header("Партнер",100).Sort().Filter(),$u.column("baseId").AsSelect(bases.db.names()).Header("База",100).Sort().Filter(),$u.column("roomId").AsSelect(rooms.db.names(null,!0)).Header("Комната",100).Sort().Filter(),$u.column("metro").Header("Метро").Sort().Filter(),$u.column("total").Header("Сумма").AsInt().Sort().Filter().Footer(),$u.column("forfeit").Header("Штрафы").AsInt().Sort().Filter().Footer(),$u.column("text").Header("Описание",-1).Filter(),$u.column("clientComment").Header("Комментарий",-1).Filter(),$u.column("status").AsSelect(n.statuses).Header("Статус",100).Sort().Filter(),],scheme:{name:"без имени",$init:function(t){n.logic.getStateCss(t)}}}).Tooltip("<b>Описание и комментарий:<\/b><br/><blockquote>#text#<hr/>#clientComment#<\/blockquote>").Footer().Autoheight(),u=this.filterView.config().extend({cols:[$u.label("Список броней"),$u.element("dfrom").Label("Дата с:",null,60).AsDate().Size(180),$u.element("dto").Label("По:",null,40).AsDate().Size(160),$u.icon("refresh").Click(function(){return t.reload()}),{}]});return $u.rows(u,r)},i.prototype.$init=function(){t.prototype.$init.call(this);var n=new Date;this.filterView.setValuesEx({dfrom:n.addDays(-7),dto:n})},i.prototype.reload=function(t){t&&(this.filter=t);var i=webix.extend(this.filter,this.filterView.values(),!0),r=n.db.admlist(i);this.grid.refresh(r)},i}($u.View);n.AdminGridView=t}(orders||(orders={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.form=new $u.RefForm,n.uploader=new $u.RefUI,n.files=new $u.RefDataView,n.urlView=(new resources.UrlView).owner(n),n}return __extends(i,t),i.prototype.$config=function(){t.prototype.$config.call(this);var i=this,f={view:"uploader",id:this.uploader.id,value:"Загрузите фото или перетащите файл",upload:"api/resources/upload/",accept:"image/png, image/gif, image/jpg",datatype:"json",multiple:!0,on:{onFileUpload:function(n){var t=n[0],r;i.files.callNoEvents(function(){return i.files.add(t)});r=i.form.values();r.files.insert(t.sort,{id:t.id,name:t.name,value:t.value,sort:t.sort});i.form.setValues(r)}}},r="Укажите на каких условиях возможны почасовые занятия по будням и выходным дням заранее в формате 0,6,15,24. Например: «0,6,12,13,14,15,16,17,18,21,24» - что означает с 0 до 6 комнату можно забронировать только на 6 часов, с 12 до 18 можно забронировать комнату на 1 час, а с 18 до 24 только на 3",u="Укажите на каких условиях возможны почасовые занятия по будням и выходным дням день в день в формате 0,6,15,24. Например: «0,15,16,17,18,19,20,21,22,23,24» - что означает, что комнату можно забронировать только с 3 часов дня, и до окончания работы объекта комната доступна для бронирования по часу. (Понятие «сегодня» определяется датой, это значит, что условия бронирования указанное в этих полях вступает в силу в 00:01 сегодняшнего дня)";return this.form.config().Labels(150).extend({borderless:!0,elements:[$u.cols($u.button("Сохранить").Click(function(){return i.save()}),{}),$u.cols($u.rows($u.element("baseId").Label("База").AsSelect(bases.db.names(!0)).Require().Tooltip("Выберите созданный в разделе «Базы» объект, в котором расположена комната"),$u.element("name").Label("Название").Require().Tooltip("Введите название комнаты для потенциальных клиентов"),$u.element("color").Label("Цвет").AsColor().Tooltip("Цвет в календаре"),$u.element("shareId").Label("Общая комната").AsSelect(n.db.names(null,!0)).Tooltip("Выберите общую комнату если это помещение используется в других сферах оказания услуг. Например, если эта комната используется на студии звукозаписи в качестве тон-зала, укажите ее в этом поле и в поле «общая комната» самого тон зала (Указывать нужно одну и ту же комнату)"),$u.element("isArchive").Label("Архив").AsCheckbox().Tooltip("Используется для удаления комнаты из раздела «Календарь» и других, если в этой комнате были бронирования"),$u.element("allowMobile").Label("Мобильный доступ").AsCheckbox().Tooltip("Используется для публикации и скрытия комнаты в приложении. Не выставляйте эту галочку пока не убедитесь в полном заполнении информации в разделах «Базы», «Комнаты», «Позиции» и «Цены»"),$u.element("defaultHours").Label("Часы бронирования").Tooltip(r),$u.element("weekendHours").Label("Часы в выходные").Tooltip(r),$u.element("todayHours").Label("Часы сегодня").Tooltip(u),$u.element("todayWkHours").Label("Часы вых. сегодня").Tooltip(u),$u.element("hoursBefore").Label("Часы до начала").AsNumber().Tooltip("Минимальное кол-во часов до бронирования"),$u.element("minHours").Label("Мин.длительность - заранее, заранее вых, сег, сег вых. Пример: 2,3,1","top").Tooltip("Минимальная длительность бронирования - можно задавать частично, по умолчанию берется левая цифра, например: 2,0,3"),$u.element("square").Label("Площадь").AsInt().Require().Tooltip("Укажите фактическую площадь комнаты в виде цифры. Например: 35"),$u.element("features").Label("Доп.параметры комнаты","top").AsMultiSelect([]).Tooltip("Выберите параметры, соответствующие комнате"),$u.element("raider").Label("Райдер").AsTextArea().Autoheight().Min(0,150).Require().Tooltip("Введите список оснащения комнаты. Аппарат, приспособления, цветовая гамма и оформление"),$u.element("channelIds").Label("Способы оплаты").AsMultiSelect(paychannels.db.names())),$u.rows($u.element("videoUrl").Label("Ссылка на видео").Tooltip("Вставьте ссылку на видео презентацию комнаты"),this.urlView.$config().Size(0,150),$u.cols(f,this.files.btnDel().extend({on:{onItemClick:function(){var r=i.files.data().config.store.order,n=i.form.values(),t=[];n.files.forEach(function(n){var i=r.find(n.id);i==-1&&(resources.db.delete(n.id),t.insert(0,n))});t.forEach(function(t){n.files.remove(t)});i.form.setValues(n)}}})),this.files.config().extend({drag:"move",select:!0,on:{onAfterDrop:function(){var n=i.form.values(),r=i.files.data().config.store.order,t=0;n.files.length!=0&&(r.each(function(i){n.files.findById(i).sort=t;t++}),i.form.setValues(n))}}}).Template("<img src='files/res/#value#' width1='150' height='250' />").ItemSize("auto",250))),{},],scheme:{$change:function(n){return alert(n)}},rules:{$obj:function(){var n=i.files.get().count();return n>2||It.UI.w.error("Вставьте минимум 3 фото")}}})},i.prototype.$init=function(){t.prototype.$init.call(this);this.uploader.ref.addDropZone(this.files.ref.$view)},i.prototype.$reload=function(i){t.prototype.$reload.call(this,i);this.uploader.set({formData:{id:i,kind:resources.ResourceKind.RoomPhoto}});var r=this.form.load(n.db.getUrl(i));this.files.refresh(r.files);this.urlView.$reload(i);this.form.setElement("features",{suggest:groups.db.features({sphere:r.sphereId})})},i.prototype.save=function(){this.form.validate()&&(this.form.values().files.forEach(function(n){resources.db.save(n)}),this.form.save(n.db.saveUrl(this.objectId),!1),webix.message("Данные сохранены на сервере"))},i.prototype.setSync=function(){It.Web.openUrl("#!/services/sync",{oid:this.objectId})},i}($u.View);n.EditView=t}(rooms||(rooms={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n}return __extends(i,t),i.prototype.$config=function(){var u=this,i,r;return t.prototype.$config.call(this),i=this.grid.config().extend({columns:[$u.column("order").Header("⟠",35).Sort().Edit().Tooltip("Сортировка в календаре"),$u.column("name").Header("Название",200).Sort().Filter().Template($u.getViewLink("rooms","#name#")),$u.column("baseId").AsSelect(bases.db.names(!0)).Header("База",150).Sort().Filter(),$u.column("raider").Header("Райдер",-1).Filter(),$u.column("square").Header("Площадь").AsInt().Sort(),$u.column("isArchive").Header("Арх").AsCheckboxReadly().Sort(),$u.column("color").Header("Цвет").AsColor().Edit().Size(30).Sort(),$u.column("allowMobile").Header("Моб").AsCheckboxReadly().Sort(),$u.column("shareId").AsSelect(n.db.names()).Header("Общая комната",150).Sort().Filter(),],scheme:{id:-1,name:"без имени",color:"#f89623"},type:{href:"#!"},save:n.db.getSaveCfg(!0)}).Editable(),r={rows:[$u.panelbar(this.grid.btnAdd(),this.grid.btnDel(),this.grid.btnRefresh(function(){return u.refresh()}),{}),i,]},r},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.refresh()},i.prototype.refresh=function(){var t=n.db.list();this.grid.refresh(t)},i}($u.View);n.GridView=t}(rooms||(rooms={})),function(n){n.create={grid:function(){return new n.GridView},edit:function(){return new n.EditView}};var t=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.itemsUrl=t.url("list"),t.namesUrl=t.url("names"),t.names=function(n,i){return t.load("names",{base:n,full:i})},t.units=function(){return t.load("names").map(function(n){return{id:n.id,key:n.id,label:n.value,base:n.baseId,order:n.order}})},t}return __extends(t,n),t.prototype.allowTime=function(n,t,i,r,u){return this.load("allowTime",{datefrom:n,dateto:t,room:i,base:r,domain:u})},t.prototype.allowHours=function(n,t){return this.loadStr("allowHours",{rooms:n,hours:t})},t}(app.AppDataSource);n.db=new t("rooms")}(rooms||(rooms={})),function(n){var t=function(){function n(){this.full=!1;this.form=new $u.RefForm}return n.prototype.config=function(){var n="Укажите цену за час по Будням и по Выходным (С помощью полей «Перв. Раб. И Посл. Раб. Можно настроить отдельную цену по понедельникам и по пятницам). Если цена за 3 часа не делится на ровное число, указывайте ближайшее число до «,», платформа округлит это число при формировании цены. Например, если три часа в выбранной комнате стоят 1100, то в полях необходимо указать цифру 367 (366,6)",t="Выберете календарный период действия параметров условия",i=promo.db.names(!0,promo.PromoKind.Rules);return this.form.config().Labels(100).extend({gravity:.5,elements:[$u.element("baseId").Label("База","top").AsSelect(bases.db.namesUrl).Visible(this.full).Tooltip("Выберите объект на котором будет действовать созданная цена"),$u.element("roomId").Label("Комната","top").AsSelect(rooms.db.names(undefined,!0)).Visible(this.full).Tooltip("Выберите комнату в которой будет действовать созданная цена"),$u.element("timeFrom").Label("С, час").AsCounter(0,24).Require().Tooltip("Укажите промежуток действия выбранной цены"),$u.element("timeTo").Label("По, час").AsCounter(0,24).Require().Tooltip("Укажите промежуток действия выбранной цены"),$u.element("workingFPrice").Label("Раб.Перв").Tooltip(n),$u.element("workingPrice").Label("Рабочие").Require().Tooltip(n),$u.element("workingLPrice").Label("Раб.Посл").Tooltip(n),$u.element("weekend1Price").Label("СБ").Require().Tooltip(n),$u.element("weekend2Price").Label("ВС").Require().Tooltip(n),$u.element("promoId").Label("Условие","top").AsSelect(i).Tooltip("Выберите условие при котором будет действовать созданная цена, например, условие для сольных репетиций. Условия создаются в разделе «Ценообразование»"),$u.element("dateFrom").Label("Начало").AsDate().Tooltip(t),$u.element("dateTo").Label("Окончание").AsDate().Tooltip(t),$u.element("isArchive").Label("Архив").AsCheckbox(),$u.element("description").Label("Описание").AsTextArea(100),{},]})},n}();n.EditForm=t}(prices||(prices={})),function(n){function t(){var n=webix;webix.env.mobile?webix.skin.set("touch"):It.UI.Configs.defaults.padding=5;n.require.disabled=!0;It.Web.auth.tokens.check();access.checkLogin();system.loadContext();help.load();It.Web.bindSocket("changes",(system.context||{login:"guest"}).login,function(n){return console.log("socket changes:",n)})}function i(){new $u.HtmlView("http->html/intro.html","Краткое описание").show()}console.log("booking-ap-lib: v2022-06-09 (1)");webix.i18n.setLocale("ru-RU");It.UI.coreLocale.Err.AccessError="Нет прав или истек срок действия для Вашего аккаунта. <p/>Для возобновления работы необходимо выполнить вход повторно"+"Выполнить вход".link("access#!/access/login").tag("h3",{style:"background-color: orange; margin: 10px;"})+"Или перейти в Начало работы".link("/").tag("h6");(location.hostname==""||location.hostname=="localhost")&&(It.Web.WebSource.base=location.protocol+"//"+location.host);webix.require.disabled=!0;n.init=t;n.run=i;n.create={"default":function(){return new $u.HtmlView("http->"+It.Web.WebSource.base+"/html/start.html","Начало работы")},default1:function(){return new $u.HtmlView("http->"+It.Web.WebSource.base+"/cms/hello.html","Начало работы")},html:function(){return new $u.HtmlView}}}(app||(app={})),function(n){function i(){var n=r();t(n)}function t(n){function c(){It.Web.openUrl(help.config.current().url,null,!0)}var t=new $u.Navigator,i=new $u.RefUI,r=$u.sidebarMenu(n),o=new $u.RefUI,s,h;r.OnItemSelect(function(n){n.url&&It.Web.openUrl(n.url);i.set({data:{value:n.value||"",description:n.description||""}});document.title=n.value});t.view.onOpen.on(function(n){var t=help.config.current(location.hash||"./"),r,u;(o.visible(!!t),t&&o.set({tooltip:t.text}),n.init&&n.init.title)&&(r=n.init.title,u={value:r,description:""},i.set({data:u}))});s={padding:10,id:"app-root1",rows:[f(),u(),$u.panelbar($u.sidebarButton(r),$u.icon("question").Click(function(){return c()}).Ref(o),$u.template("<b>#value#<\/b><span/>  #description#",{value:"",description:""}).Css("it-header-nav").Ref(i).Size(-1,33),$u.icon("close").Click(function(){return t.close()})),{responsive:"app-root1",cols:[r.Min(10,100).extend({collapsed:webix.env.mobile}),$u.splitter().Visible(!webix.env.mobile),t.view.$config().Min(450),]},e(),]};h={view:"scrollview",body:s};$u.showView(h);t.routers("app");webix.ui.fullScreen()}function r(){var t=system.context;if(!t)return[{value:"Регистрация",url:"#!/domains/reg",description:"Регистрация нового партнера",visible:!0},];var i=auth.oper,n=t.isSuper,e=n&&t.allow(i.crmView),s=!!t.login,u=t.allow(i.lists),c=t.allow(i.clients),a=t.allow(i.domainsEdit),r=t.allow(i.users),o=t.allow(i.orders),f=t.allow(i.promo),l=t.allow(i.domainsAll),h=o;return[{value:"Справочники",url:"#!/app/lists",icon:"table",description:"Общие справочники системы",visible:u&&n,data:[{value:"Сферы деятельности",url:"#!/spheres/list",description:"Сферы деятельности",visible:u},{value:"Типы фильтрации",url:"#!/groups/ftypes",description:"Типы фильтрации",visible:u},{value:"Параметры комнат",url:"#!/groups/features",description:"Ввод параметров (особенностей) комнаты",visible:u},{value:"Типы позиций",url:"#!/groups/equipments",description:"Ввод типов позиций",visible:u},{value:"Опции брони",url:"#!/groups/options",description:"Опции бронирования",visible:u},{value:"Даты",url:"#!/days/grid",description:"Праздники и выходные",visible:u},]},{value:"Справочники",url:"#!/app/lists",icon:"table",description:"Общие справочники системы",visible:u&&!n,data:[{value:"Базы",url:"#!/bases/grid",description:"Редактирование баз",visible:t.allow(i.listBases)},{value:"Комнаты",url:"#!/rooms/grid",description:"Редактирование комнат",visible:t.allow(i.listBases)},{value:"Позиции",url:"#!/equipments/grid",description:"Ввод позиций",visible:t.allow(i.equipments)},{value:"Камеры",url:"#!/resources/cameras",description:"Просмотр камер",visible:t.allow(i.cameras)},{value:"Статьи расходов",url:"#!/groups/expenses",description:"Ввод статей расходов",visible:t.allow(i.expGroups)},{value:"Способы оплаты",url:"#!/paychannels/grid",description:"Каналы оплат",visible:r},]},{value:"CRM",url:"#!/app/lists",icon:"users",description:"Управление клиентами",visible:s&&!n,data:[{value:"Клиенты",url:"#!/clients/list",description:"Поиск клиентов",visible:c},{value:"Группы клиентов",url:"#!/groups/clients",description:"Справочник групп клиентов",visible:u},]},{value:"CRM",url:"#!/app/lists",icon:"users",description:"Управление клиентами",visible:s&&n,data:[{value:"Клиенты",url:"#!/clients/list",description:"Поиск клиентов",visible:c},{value:"Анализ клиентов",url:"#!/clients/totals",description:"Анализ клиентской базы",visible:e},{value:"Группы клиентов (все)",url:"#!/groups/allclients",description:"Справочник всех групп клиентов",visible:e},{value:"Виды деятельности",url:"#!/groups/client-types",description:"Справочник видов деятельности",visible:e},{value:"Города",url:"#!/groups/cities",description:"Справочник городов",visible:e},{value:"Стили танцев",url:"#!/groups/styles",description:"Справочник стилей танцев",visible:e},{value:"Инструменты",url:"#!/groups/tools",description:"Справочник музыкальных инструментов",visible:e},{value:"Жанры",url:"#!/groups/genres",description:"Справочник жанров",visible:e},{value:"Уровень навыков",url:"#!/groups/sources",description:"Справочник уровней навыков",visible:e},]},{value:"Цены и промоакции",url:"#!/app/lists",icon:"dollar",description:"Прайсы, цены, и промоакции",visible:f,data:[{value:"Промоакции (коды)",url:"#!/promo/codegrid",description:"Ввод числовых промоакций для мобильных",visible:n&&f},{value:"Правила отмены (общ) ",url:"#!/order_rules/grid",description:"Правила отмены брони (общие)",visible:n&&f},{value:"Цены",url:"#!/prices/grid",description:"Все базовые цены общим списком",visible:f&&!n},{value:"Условия",url:"#!/promo/rulesgrid",description:"Ввод условий ценообразования",visible:f&&!n},{value:"Правила отмены",url:"#!/order_rules/grid",description:"Правила отмены брони",visible:f&&!n},{value:"Промоакции (кампании)",url:"#!/promo/actgrid",description:"Ввод списков промоакций",visible:f&&!n},{value:"Горящие репетиции",url:"#!/promo/hotgrid",description:"Ввод горящих репетиций",visible:f&&!n},{value:"Автоскидки",url:"#!/discounts/grid",description:"Автоматические скидки на клиентов",visible:f&&!n},]},{value:"Бронирование",url:"#!/app/lists",icon:"calendar",description:"Операции с бронью",visible:o&&n,data:[{value:"Отзывы (модерация)",url:"#!/reviews/grid-all",description:"Модерация рейтингов и отзывов",visible:o&&n},]},{value:"Бронирование",url:"#!/app/lists",icon:"calendar",description:"Операции с бронью",visible:o&&!n,data:[{value:"Календарь",url:"#!/orders/calendar",description:"Бронирование заказов",visible:o&&!n},{value:"Заявки",url:"#!/orders/requests",description:"Управление заявками",visible:o&&!n},{value:"Абонементы",url:"#!/abonements/grid",description:"Управление абонементами",visible:t.allow(i.abonements)&&!n},{value:"Штрафы (подтв)",url:"#!/orders/ask-grid",description:"Запросы на подтверждение штрафов у диспетчеров",visible:t.allow(i.orderForfeit)&&!n},{value:"Штрафы (брони)",url:"#!/orders/forfeits",description:"Список броней со штрафами",visible:t.allow(i.orderForfeit)&&!n},{value:"Штрафники",url:"#!/clients/forfeits",description:"Список клиентов со штрафами",visible:t.allow(i.orderForfeit)&&!n},{value:"Рейтинги и Отзывы",url:"#!/reviews/grid",description:"Рейтинги и отзывы",visible:t.allow(i.reviews)&&!n},]},{value:"Учет и отчеты",url:"#!/app/lists",icon:"cubes",description:"Различные отчеты",visible:h,data:[{value:"Статистика брони",url:"#!/orders/filter-grid",description:"Статистика по бронированиям",visible:t.allow(i.statisticPromo)&&!n},{value:"Стат.брони (адм)",url:"#!/orders/filter-grid-full",description:"Полная статистика по бронированиям (админ)",visible:n&&h},{value:"Движение",url:"#!/orders/totals",description:"Отчет по движению денег по базам",visible:t.allow(i.accounts)&&!n},{value:"Транзакции",url:"#!/trans/grid",description:"Список транзакций",visible:n&&h},{value:"Транзакции-Куб",url:"#!/trans/totals",description:"Анализ транзакций",visible:n&&h},{value:"Остатки",url:"#!/equipments/totals",description:"Отчет по остаткам доп.оборудования",visible:t.allow(i.eqRest)&&!n},{value:"Расходные документы",url:"#!/expenses/grid",description:"Ввод расходных документов",visible:(t.allow(i.expDocs)||t.allow(i.expDocsAdmin))&&!n},]},{value:"Администрирование",url:"#!/app/lists",icon:"user",description:"Администрирование системы",visible:r||a,data:[{value:"Роли",url:"#!/roles/grid",description:"Роли",visible:r},{value:"Доступ",url:"#!/permissions/grid",description:"Права на операции",visible:r},{value:"Сотрудники",url:"#!/users/grid",description:"Ввод сотрудников",visible:r},{value:"Настройки",url:"#!/settings_ui/edit",description:"Настройки системы",visible:n&&r},{value:"Партнеры",url:"#!/domains/grid",description:"Партнерские зоны доступа",visible:n&&l},{value:"Статистика партнеры",url:"#!/orders/totalscom",description:"Отчет по партнерской комиссии",visible:n&&l},{value:"Тарифы",url:"#!/tarifs/grid",description:"Управление тарифами",visible:n&&r},{value:"Версии (ред)",url:"#!/groups/edversions",description:"Редактирование версий",visible:n&&r},{value:"Шаблоны",url:"#!/templates/grid",description:"Настройки шаблонов e-mail",visible:n&&r},{value:"Параметры",url:"#!/configs/grid",description:"Ввод настроечных параметров",visible:n&&r},{value:"Календари",url:"#!/calendars/grid",description:"Настройка синхронизации с календарями",visible:r&&!n},{value:"Кабинет",url:"#!/domains/service",description:"Управление партнерской зоной доступа",visible:r&&!n},{value:"IP доступ",url:"#!/rules/grid",description:"Правила доступа (IP фильтры)",visible:t.allow(i.editIP)&&!n},{value:"Рассылки",url:"#!/mailings/grid",description:"Управление почтовыми рассылками",visible:n&&r},]},{value:"Общее",icon:"question-circle",description:"Общие операции",visible:s,data:[{value:"Версии (20.6.16)",url:"#!/groups/versions",description:"Просмотр версий",visible:s},]},]}function u(){var n,t;if(system.context){if(n=system.context,n.isLimit)return $u.label("Доступ к системе заблокирован").Css("it-error").Size(-1);if(n.isLimit0)return t="До окончания срока действия системы осталось ".concat(n.remains," дн. <br/>\n").concat(webix.i18n.dateFormatStr(n.limitDate),' (7 дней с выставленного срока в разделе партнеры) платформа будет заблокирована. \nПродление доступа к платформе производится в разделе "Кабинет" '),$u.template(t).Css("it-error").Size(-1)}return{height:1}}function f(){var n=new $u.RefUI;return $u.cols($u.template("img/logo-2018.png".img({"class":"it-header-img-top"}).link("./")),{},auth_logins.btLoginName(system.context.login+(system.context.isSuper?" (super)":"")).Size(90),auth_logins.btLoginOut("access").Size(60)).Type("clean").Size(0,40)}function e(){var n,t;return((n=system.context)===null||n===void 0?void 0:n.browser)?(t=system.context.browser.copyright,$u.template(t).Size()):{}}n.run=i;n.create={"default":function(){return new $u.HtmlView("cms/hello.html")}};n.root=t}(booking||(booking={})),function(n){var t=function(t){function i(){return t!==null&&t.apply(this,arguments)||this}return __extends(i,t),i.prototype.$config=function(){return this.form.config().extend({width:400,elements:[$u.label("Создание нового клиента").Css("it-header"),$u.element("lastName").Label("Фамилия").Require(),$u.element("firstName").Label("Имя").Require(),$u.element("surName").Label("Отчество"),$u.element("email").Label("Почта"),$u.element("phone").Label("Телефон                  +7").Require(),$u.element("dateBirthday").Label("Дата рождения").AsDate(),$u.element("music").Label("О себе"),$u.element("typeInfo").Label("Тип").Tooltip("Операционная система. Модель устройства"),$u.element("gender").Label("Пол").AsSelect(n.genders),$u.element("types").Label("Виды деятельности").AsMultiSelect(groups.db.names(groups.GroupType.ActivityType)),$u.element("cityId").Label("Город").AsSelect(groups.db.names(groups.GroupType.City)),$u.element("tools").Label("Муз.инструмент").AsMultiSelect(groups.db.names(groups.GroupType.Tool)),$u.element("styles").Label("Стиль танца").AsMultiSelect(groups.db.names(groups.GroupType.MusicStyle)),$u.element("spheres").Label("Сферы деят.").AsMultiSelect(spheres.db.names()),$u.element("genres").Label("Муз. жанр").AsMultiSelect(groups.db.names(groups.GroupType.Genre)),$u.element("sourceId").Label("Уровень навыков").AsSelect(groups.db.names(groups.GroupType.Skill)),$u.element("vkUrl").Label("Страница в ВК"),$u.element("sourceUrl").Label("Instagram"),t.prototype.$config.call(this,"Создать"),]})},i.prototype.invokeAction=function(i){this.clientObject=n.db.save(i);t.prototype.invokeAction.call(this,i);this.$clear();this.hide();webix.message("Клиент успешно создан")},i}($u.PopupView);n.CreateView=t}(clients||(clients={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.form=new $u.RefForm,n.messagesView=new messages.ListView(n),n.phonesView=new resources.PhonesView(resources.ResourceKind.ClientPhone,"Телефоны").owner(n),n.transView=new trans.PartGridView(n),n.save_btn=new $u.RefUI,n}return __extends(i,t),i.prototype.$config=function(){var u=this;t.prototype.$config.call(this);var f=n.logic.allowSuper(),i=system.context.allowCrmEdit(),e=$u.panelbar($u.button("Сохранить").Click(function(){return u.save()}).Ref(this.save_btn),{}),o=this.form.config().Labels(150).extend({labelWidth:300,cols:[$u.rows($u.cols($u.rows($u.element("lastName").Label("Фамилия").Require().Readonly(!i),$u.element("firstName").Label("Имя").Require().Css("it-warning").Readonly(!i),$u.element("surName").Label("Отчество").Readonly(!i),$u.element("email").Label("Почтовый адрес").Require().Readonly(!i),$u.element("dateBirthday").Label("Дата рождения").AsDate().Readonly(!i)).Size(-3),$u.rows($u.uploader("api/core/upload-image",function(n,t){return u.setImage(t)}).extend({name:"uploader",value:"Фотография",accept:"image/*",datatype:"json",formData:{folder:"users/"+system.context.id}}).Visible(i),$u.element("photoUrl").AsTemplate(function(n){return("res/"+n).img({height:"110px",width:"100%"})})).Size(-1)),$u.element("groups").Label("Группы клиента").AsMultiSelect(groups.db.names(groups.GroupType.ContactType,!0)).Readonly(!i),$u.element("discount").Label("Скидка клиента, %").Tooltip("Постоянная скидка клиенту от партнера").Readonly(!i),$u.element("forfeit").Label("Штрафы").Disable().Tooltip("Ранее начисленные штрафы").Readonly(!i),$u.element("isBanned").Label("Заблокирован").AsCheckbox().Readonly(!i),$u.element("payKind").Label("Способ оплаты").AsSelect(n.payKinds).Readonly(!i),$u.element("notifications").Label("Уведомления").AsMultiSelect(app.notifications).Readonly(!i),this.phonesView.$config(i).Size(0,150).Disable(!i)),$u.rows($u.element("music").Label("О себе").Readonly(!i),$u.element("typeInfo").Label("Данные об устройстве").Tooltip("Операционная система. Модель устройства").Readonly(!i),$u.element("gender").Label("Пол").AsSelect(n.genders).Readonly(!i),$u.element("types").Label("Виды деятельности").AsMultiSelect(groups.db.names(groups.GroupType.ActivityType)).Readonly(!i),$u.element("cityId").Label("Город").AsSelect(groups.db.names(groups.GroupType.City)).Readonly(!i),$u.element("tools").Label("Муз.инструмент").AsMultiSelect(groups.db.names(groups.GroupType.Tool)).Readonly(!i),$u.element("styles").Label("Стиль танца").AsMultiSelect(groups.db.names(groups.GroupType.MusicStyle)).Readonly(!i),$u.element("spheres").Label("Сферы деятельности").AsMultiSelect(spheres.db.names()).Readonly(!i),$u.element("genres").Label("Муз/жанр").AsMultiSelect(groups.db.names(groups.GroupType.Genre)).Readonly(!i),$u.element("sourceId").Label("Уровень навыков").AsSelect(groups.db.names(groups.GroupType.Skill)).Readonly(!i),$u.element("vkUrl").Label("Страница в ВК").Readonly(!i),$u.element("sourceUrl").Label("Instagram").Readonly(!i),$u.element("creator").Label("Кем создано").Disable().Visible(f).Readonly(!i)),]}),r=$u.tabview().Autoheight();return f?(this.admOrdersView=new orders.AdminGridView(this),this.users=new users.GridView,this.faview=new favorites.GridView(this),r.Tab("Транзакции",this.transView.$config()).Tab("Брони (адм)",this.admOrdersView.$config()).Tab("История",this.messagesView.$config()).Tab("Избранное",this.faview.$config()).Tab("Логины",this.users.$config())):(this.docsView=new docs.GridView(this),this.htmlView=(new n.HtmlView).owner(this),r.Tab("Документы",this.docsView.$config()).Tab("История",this.messagesView.$config()).Tab("Справка",this.htmlView.$config())),$u.rows(e,o,r)},i.prototype.setImage=function(n){this.form.elements.photoUrl.setValues((n||{}).path)},i.prototype.$reload=function(i){var u,e;t.prototype.$reload.call(this,i);u=this.form.load(n.db.getUrl(i));e=n.logic.allowSuper();e?(this.faview.$reload(i),this.admOrdersView.reload({client:i}),this.transView.reload({clientId:i}),this.users.refresh(users.db.search(i))):(this.docsView.filter.client=i,this.docsView.refresh(),this.htmlView.$reload(i));this.phonesView.$reload(i);this.messagesView.filter.client=i;this.messagesView.refresh();this.messagesView.setDefaults({clientId:i});var r=n.logic.allowEdit(u),o=n.logic.allowFin(u),f=n.logic.allowDiscBan(u);this.form.enable(r,"lastName");this.form.enable(r,"firstName");this.form.enable(r,"surName");this.form.enable(r,"email");this.form.enable(r,"dateBirthday");this.form.enable(r,"uploader");this.form.enable(o,"forfeit");this.form.enable(f,"discount");this.form.enable(f,"isBanned");this.form.enable(f,"payKind");this.form.enable(r,"music");this.form.enable(r,"typeInfo");this.form.enable(r,"gender");this.form.enable(r,"groups");this.form.enable(r,"types");this.form.enable(r,"cityId");this.form.enable(r,"tools");this.form.enable(r,"styles");this.form.enable(r,"spheres");this.form.enable(r,"genres");this.form.enable(r,"sourceId");this.form.enable(r,"vkUrl");this.form.enable(r,"sourceUrl");this.phonesView.enable(r)},i.prototype.save=function(){var t,i,r;this.form.validate()&&(t=this.form.save(n.db.saveUrl(this.objectId),!1),i=!n.logic.allowSuper(),i&&(r={id:t.partId,isBanned:t.isBanned,payKind:t.payKind,discount:t.discount,forfeit:t.forfeit,assignedName:t.assignedName,editorName:t.editorName},n.partsdb.save(r),this.htmlView.$reload(this.objectId)),webix.message("Данные о клиенте сохранены"))},i}($u.View);n.EditView=t}(clients||(clients={})),function(n){var t=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.$config=function(){return this.form.config().extend({width:400,elements:[$u.element("text").Label("ФИО, тел, email"),$u.element("dfrom").Label("Дата с").AsDate(),$u.element("dto").Label("По").AsDate(),$u.element("domain").Label("Партнер").AsSelect(domains.db.namesUrl),n.prototype.$config.call(this),]})},t}($u.PopupView);n.FilterView=t}(clients||(clients={})),function(n){var t=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i.createView=(new n.CreateView).onAction(function(n){return i.add(n)}),i.form=new $u.RefForm,i.grid=new $u.RefGrid,i}return __extends(i,t),i.prototype.$config=function(){var n=this;t.prototype.$config.call(this);It.Web.loadJS("lib/webix-ext/xlsx.core.min.js");var i=this.form.config().extend({cols:[$u.button("Создать").Popup(this.createView.$config()),$u.icon("file-excel-o").Click(function(){return n.exportxlsx()}).Tooltip("Экспортировать в Ексел"),$u.icon("database").Click(function(){return n.exportocsv()}).Tooltip("Экспортировать в csv"),{},$u.element("group").Label("Группа",null,60).AsSelect(groups.db.names(groups.GroupType.ContactType,!0)),$u.element("text").Label("Поиск",null,60).Tooltip("Поиск по ФИО, тел, email").AsSearch(function(){return n.search()}),]}),r=$u.getViewLink("clients","(...)"),u=this.grid.config().extend({columns:[$u.column("link").Header("",40).Template(r),$u.column("fio").Header("ФИО",-1),$u.column("email").Header("e-mail",150),$u.column("phones").Header("Телефоны",150)]});return $u.rows(i,u)},i.prototype.$init=function(){t.prototype.$init.call(this)},i.prototype.add=function(n){var i=this,t=this.grid;t.callNoEvents(function(){return t.add({id:i.createView.clientObject.id,fio:n.firstName+" "+n.lastName,email:n.email,phones:n.phones})})},i.prototype.clear=function(){this.form.clear();this.search(!1)},i.prototype.search=function(t){t===void 0&&(t=!0);var i=this.form.values(),r=n.db.items({filter:i.text,group:i.group});this.grid.refresh(r);t&&webix.message("Показано не более 10 записей")},i.prototype.exportxlsx=function(){this.grid.toExcel({filename:"clients "+(new Date).toLocaleDateString("ru"),name:"clients",filterHTML:!0,columns:[{id:"fio",name:"ФИО"},{id:"email",name:"e-mail"},{id:"phones",name:"Телефоны"}]});console.log("export xlsx")},i.prototype.exportocsv=function(){webix.csv.delimiter.cols=";";this.grid.exportToFileCSV({filename:"clients "+(new Date).toLocaleDateString("ru"),name:"clients",filterHTML:!0,columns:[{id:"fio",name:"fio"},{id:"email",name:"email"},{id:"phones",name:"phones"}]});console.log("export csv")},i.prototype.importfromcsv=function(){webix.message("Данные загружены");console.log("import from csv")},i}($u.View);n.GridView=t}(clients||(clients={})),function(n){var t=function(t){function i(){return t!==null&&t.apply(this,arguments)||this}return __extends(i,t),i.prototype.$reload=function(t){var i=n.db.html(t);this.setHtml(i)},i}($u.HtmlView);n.HtmlView=t}(clients||(clients={})),function(n){var t=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i.pivot=new $u.RefPivot,i.filterView=new n.FilterView(i),i}return __extends(i,t),i.prototype.$config=function(){var n=this;t.prototype.$config.call(this);this.filterView.onAction(function(){return n.refresh()});var i=$u.panelbar($u.button("Найти").Popup(this.filterView.$config(),function(){return n.onPopup()}),$u.icon("file-excel-o").Click(function(){return n.export()}).Tooltip("Экспортировать в Ексел"),{}),r=this.pivot.config().extend({columnWidth:80,fieldMap:{domain:"Партнер",name:"ФИО",email:"Email",city:"Город",logins:"Логины",orders:"Заказы",reservs:"Резервы",paids:"Оплаты",cancels:"Отмены",forfeits:"Штрафы",sOrders:"₽Заказы",sReservs:"₽Резервы",sPaids:"₽Оплаты",sCancels:"₽Отмены",sForfeits:"₽Штрафы",sDiscounts:"₽Скидки"},structure:{filters:[{name:"city",type:"select"},],columns:[],values:[{name:"logins",operation:"sum"},{name:"orders",operation:"sum"},{name:"reservs",operation:"sum"},{name:"paids",operation:"sum"},{name:"cancels",operation:"sum"},{name:"forfeits",operation:"sum"},{name:"sOrders",operation:"sum"},{name:"sReservs",operation:"sum"},{name:"sPaids",operation:"sum"},{name:"sCancels",operation:"sum"},{name:"sForfeits",operation:"sum"},{name:"sDiscounts",operation:"sum"},],rows:["domain","name"]}});return $u.rows(i,r)},i.prototype.$init=function(){t.prototype.$init.call(this);this.pivot.setConfig("pivot.client.totals")},i.prototype.onPopup=function(){},i.prototype.refresh=function(){var i=this.filterView.values,t=n.db.totals(i);this.pivot.refresh(t);webix.message("Загружено ".concat(t.length,", но не более 1000 записей"))},i.prototype.export=function(){this.pivot.toExcel({filename:"totals "+(new Date).toLocaleDateString("ru"),name:"totals",filterHTML:!0})},i}($u.View);n.TotalsView=t}(clients||(clients={})),function(n){function u(){return $u.element("clientId").Label("Клиент","top").AsSelect(n.db.searchUrl).Require().Tooltip("Для поиска введите часть ФИО, mail или телефон").Css("it-warning")}function f(n,t){return n===void 0&&(n="#clientId#"),t===void 0&&(t="#client#"),system.context.allow(auth.oper.clients)?$u.getViewLink("clients",t,n):t}var t,i,r;n.create={list:function(){return new n.GridView},edit:function(){return new n.EditView},totals:function(){return new n.TotalsView},forfeits:function(){return new n.ForfeitGridView}},function(n){n[n.Default=1]="Default";n[n.Trust=2]="Trust";n[n.Doubt=3]="Doubt";n[n.Card=4]="Card"}(t=n.ClientPayKind||(n.ClientPayKind={}));n.payKinds=[{id:t.Default,value:"По умолчанию"},{id:t.Trust,value:"Доверять"},{id:t.Doubt,value:"Сомневаться"},{id:t.Card,value:"Только по карте"},];n.genders=[{id:"m",value:"Муж"},{id:"w",value:"Жен"},];i=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.searchUrl=t.url("search"),t}return __extends(t,n),t.prototype.getClientName=function(n){if(!n)return"";return"".concat(n.firstName," ").concat(n.lastName," ").concat(n.surName," ").concat(n.phones," ").concat(n.email)},t.prototype.forfeits=function(n){return this.load("forfeits",n)},t.prototype.items=function(n){return this.load("list",n)},t.prototype.totals=function(n){return this.load("totals",n,!1)},t.prototype.html=function(n){return this.loadStr("html/"+n)},t}(app.AppDataSource);n.db=new i("clients");r=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t}(app.AppDataSource);n.partsdb=new r("clientparts");n.logic={allowSuper:function(){return system.context.isSuper},allowEdit:function(n){return n.isDomain||system.context.isSuper},allowFin:function(){return system.context.allow(auth.oper.clientFin)},allowDiscBan:function(){return system.context.allow(auth.oper.clientDiscBan)}};n.getSearchColumn=u;n.getClientColumnTemplate=f}(clients||(clients={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n}return __extends(i,t),i.prototype.$config=function(){var n=this,t=$u.getViewLink("clients","#fio#"),i=$u.cols($u.button("Обновить").Click(function(){return n.$reload()}),{}),r=this.grid.config().extend({columns:[$u.column("fio").Header("ФИО",-1).Template(t).Sort(),$u.column("isBanned").Header("Бан").AsCheckboxReadly().Sort(),$u.column("forfeit").Header("Штраф").AsInt().Footer().Sort(),$u.column("orders").Header("Броней").AsInt().Footer().Sort(),$u.column("last").Header("Посл.бронь").AsDate().Sort(),]}).Footer();return $u.rows(i,r)},i.prototype.$reload=function(i){t.prototype.$reload.call(this,i);var r=n.db.forfeits();this.grid.refresh(r)},i}($u.View);n.ForfeitGridView=t}(clients||(clients={})),function(n){var t=function(){function t(n,t){t===void 0&&(t="Название");this.type=n;this.header=t;this.form=new $u.RefForm}return t.prototype.config=function(){var i=this,t=this.form.config().extend({elements:[$u.element("name").Label(this.header,"top"),$u.element("isArchive").Label("Скрыть (архив)").AsCheckbox(),]});return this.type==n.GroupType.Version&&t.Elements($u.element("description").Label("E-mail партнера").AsHtmlEditor(300,"top")),(this.type==n.GroupType.Equipment||this.type==n.GroupType.RoomFeature)&&t.Elements($u.element("description").Label("Описание").AsTextArea(100,"top"),$u.uploader("api/core/upload",function(n,t){return i.setImage(t)}).extend({value:"Загрузить иконку",formData:{prefix:"spheres"}}),$u.element("icon").AsTemplate(function(n){return("res/"+n).img({height:"50px",width:"50px"})})),t.Elements({}),t},t.prototype.setImage=function(n){this.form.elements.icon.setValues(n.path)},t}();n.EditForm=t}(groups||(groups={})),function(n){var t=function(t){function i(i,r){var u=t.call(this)||this;return u.settings=i,u.template=r,u.list=new $u.RefList,u.form=new n.EditForm(u.settings.type),u}return __extends(i,t),i.prototype.$config=function(){var i=this,r,u;return t.prototype.$config.call(this),r=this.list.config().extend({template:this.template,type:{href:"#!",height:"auto"},scheme:{id:-1,name:this.settings.name||"новый элемент",type:this.settings.type}}).Editable(n.db.getSaveCfg(!0)),u=$u.rows($u.toolbar(this.list.btnAdd(undefined,0),this.list.btnDel(),this.list.btnRefresh(function(){return i.refresh()}),{},$u.button("Сохранить").Click(function(){return i.form.form.updateBindings()})),$u.cols(r,this.form.config().Size(350))),u},i.prototype.$init=function(){t.prototype.$init.call(this);this.form.form.bind(this.list)},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.first&&this.refresh()},i.prototype.refresh=function(){var t=n.db.list(this.settings);this.list.refresh(t)},i}($u.View);n.FormListView=t}(groups||(groups={})),function(n){var t=function(t){function i(n,i){var r=t.call(this)||this;return r.settings=n,r.header=i,r.grid=new $u.RefGrid,r}return __extends(i,t),i.prototype.$config=function(){var u=this;t.prototype.$config.call(this);var e=this,i=system.context.allowCrmEdit(),f=this.settings.type==n.GroupType.OrderOption,r=this.grid.config().extend({columns:[$u.column().AsOrderMarker().Visible(i),$u.column("domain").Header("Партнер",180).Sort().Filter().Visible(this.settings.viewDomain),$u.column("name").Header(this.header,180).Sort().Filter().Edit(),$u.column("description").Header("Описание",-2).Sort().Edit(),$u.column("isArchive").Header("Арх").AsCheckboxReadly(!i).Sort(),$u.column("isRange").Header("Диапазон").AsCheckboxReadly(!i).Sort().Visible(f),],scheme:{id:-1,name:"новый элемент",type:this.settings.type,index:1e3},save:n.db.getSaveCfg(!0)});return i&&r.Editable().DragOrder(function(t,i){return n.db.reindex(t,i)},!0),this.settings.gps&&r.Columns($u.column("gpsLat").Header("GPS Lat",100).Sort().Edit(),$u.column("gpsLong").Header("GPS Long",100).Sort().Edit()),$u.rows($u.panelbar(this.grid.btnAdd().Visible(i),this.grid.btnDel().Visible(i),this.grid.btnRefresh(function(){return u.refresh()}),{}),r)},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.first&&this.refresh()},i.prototype.refresh=function(){var t=n.db.list(this.settings);this.grid.refresh(t)},i}($u.View);n.GridView=t}(groups||(groups={})),function(n){var t=function(t){function i(n,i){var r=t.call(this)||this;return r.itemsArgs=n,r.template=i,r.list=new $u.RefList,r}return __extends(i,t),i.prototype.$config=function(){var r=this,n,i;return t.prototype.$config.call(this),n=this.list.config().extend({template:this.template,select:!1,type:{href:"#!",height:"auto"}}),i=$u.rows($u.panelbar(this.list.btnRefresh(function(){return r.refresh()}),{}),n),i},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.first&&this.refresh()},i.prototype.refresh=function(){var t=n.db.list(this.itemsArgs);this.list.refresh(t)},i}($u.View);n.ListView=t}(groups||(groups={})),function(n){var t,i;n.create={equipments:function(){return new n.EqTypesGridView},features:function(){return new n.FeaturesGridView},ftypes:function(){return new n.GridView({type:t.FeatureType},"Типы параметров")},clients:function(){return new n.GridView({type:t.ContactType,domain:!0},"Группа клиентов")},allclients:function(){return new n.GridView({type:t.ContactType,viewDomain:!0},"Группа клиентов (все)")},cities:function(){return new n.GridView({type:t.City,gps:!0},"Город")},"client-types":function(){return new n.GridView({type:t.ActivityType},"Тип клиента")},styles:function(){return new n.GridView({type:t.MusicStyle},"Музыкальный стиль")},tools:function(){return new n.GridView({type:t.Tool},"Музыкальный инструмент")},activities:function(){return new n.GridView({type:t.Activity},"Вид деятельности")},genres:function(){return new n.GridView({type:t.Genre},"Музыкальный жанр")},sources:function(){return new n.GridView({type:t.Skill},"Источник клиента")},expenses:function(){return new n.GridView({type:t.Expense,domain:!0},"Статья расходов")},options:function(){return new n.GridView({type:t.OrderOption,domain:!1},"Опции брони")},edversions:function(){return new n.FormListView({type:t.Version,sort:"-date",name:"версия"},"http->"+It.Web.WebSource.base+"/html/group-list.html")},versions:function(){return new n.ListView({type:t.Version,sort:"-date",archive:!1},"http->"+It.Web.WebSource.base+"/html/group-list.html")},reviews:function(){return new n.GridView({type:t.Reviews},"Типы отзывов")}},function(n){n[n.Equipment=1]="Equipment";n[n.ContactType=2]="ContactType";n[n.City=3]="City";n[n.Tool=4]="Tool";n[n.MusicStyle=5]="MusicStyle";n[n.ActivityType=6]="ActivityType";n[n.Skill=7]="Skill";n[n.Activity=8]="Activity";n[n.Genre=9]="Genre";n[n.RoomFeature=10]="RoomFeature";n[n.Expense=11]="Expense";n[n.Version=12]="Version";n[n.OrderOption=14]="OrderOption";n[n.FeatureType=15]="FeatureType";n[n.Reviews=16]="Reviews";n[n.Fin=17]="Fin"}(t=n.GroupType||(n.GroupType={}));i=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.names=function(n,i){return t.load("names",{type:n,domain:i})},t.options=function(){return t.load("options")},t.features=function(n){return t.load("features",n)},t.reindex=function(n,i){return t.post("reindex",{start:n,ids:i})},t}return __extends(t,n),t}(app.AppDataSource);n.db=new i("groups")}(groups||(groups={})),function(n){var t=function(t){function i(i,r){var u=t.call(this)||this;return u.settings=i,u.header=r,u.grid=new $u.RefGrid,u.form=new n.EditForm(u.settings.type),u}return __extends(i,t),i.prototype.$config=function(){var i=this,r,u;return t.prototype.$config.call(this),r=this.grid.config().extend({columns:[$u.column().AsOrderMarker(),$u.column("domain").Header("Партнер",180).Sort().Filter().Visible(this.settings.viewDomain),$u.column("name").Header(this.header,180).Sort().Filter().Edit(),$u.column("description").Header("Описание",-2).Sort().Edit(),$u.column("isArchive").Header("Арх").AsCheckbox().Sort().Edit(),],scheme:{id:-1,name:"новый элемент",type:this.settings.type,order:1e3},save:n.db.getSaveCfg(!0)}).Editable().DragOrder(function(t,i){return n.db.reindex(t,i)},!0),u=$u.rows($u.panelbar(this.grid.btnAdd(),this.grid.btnDel(),this.grid.btnRefresh(function(){return i.refresh()}),{},$u.button("Сохранить").Click(function(){return i.form.form.updateBindings()})),$u.cols(r,this.form.config().Size(350))),u},i.prototype.$init=function(){t.prototype.$init.call(this);this.form.form.bind(this.grid)},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.first&&this.refresh()},i.prototype.refresh=function(){var t=n.db.list(this.settings);this.grid.refresh(t)},i}($u.View);n.FormGridView=t}(groups||(groups={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n.form=new $u.RefForm,n}return __extends(i,t),i.prototype.$config=function(){var i=this;t.prototype.$config.call(this);var u=this,r=this.grid.config().extend({columns:[$u.column().AsOrderMarker(),$u.column("categoryId").Header("Тип",150).Sort().AsSelect(n.db.names(n.GroupType.FeatureType)).Filter().Edit(),$u.column("name").Header("Параметр",180).Sort().Filter().Edit(),$u.column("description").Header("Описание",-2).Sort().Edit(),$u.column("isArchive").Header("Арх").AsCheckbox().Sort().Edit(),],scheme:{id:-1,name:"новый параметр",type:n.GroupType.RoomFeature,order:1e3},save:n.db.getSaveCfg(!0)}).Editable().DragOrder(function(t,i){return n.db.reindex(t,i)},!0);return $u.rows($u.panelbar(this.grid.btnAdd(),this.grid.btnDel(),this.grid.btnRefresh(function(){return i.refresh()}),{},$u.button("Сохранить").Click(function(){return i.form.updateBindings()})),$u.cols(r,this.configForm().Size(350)))},i.prototype.configForm=function(){var n=this;return this.form.config().extend({elements:[$u.element("name").Label("Параметр комнаты","top"),$u.element("isArchive").Label("Скрыть (архив)").AsCheckbox(),$u.element("description").Label("Описание").AsTextArea(100,"top"),$u.element("sphereIds").Label("Сферы","top").AsMultiSelect(spheres.db.names()),$u.uploader("api/core/upload",function(t,i){return n.setImage(i)}).extend({value:"Загрузить иконку",formData:{prefix:"spheres"}}),$u.element("icon").AsTemplate(function(n){return("res/"+n).img({height:"50px",width:"50px"})}),{},]})},i.prototype.setImage=function(n){this.form.elements.icon.setValues(n.path)},i.prototype.$init=function(){t.prototype.$init.call(this);this.form.bind(this.grid)},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.first&&this.refresh()},i.prototype.refresh=function(){var t=n.db.list({type:n.GroupType.RoomFeature});this.grid.refresh(t)},i}($u.View);n.FeaturesGridView=t}(groups||(groups={})),function(n){var t=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i.grid=new $u.RefGrid,i.formview=new n.EditForm,i}return __extends(i,t),i.prototype.$config=function(){var i=this,r,u;return t.prototype.$config.call(this),r=this.grid.config().extend({columns:[$u.column("isArchive").Header("Арх").AsCheckboxReadly().Sort(),$u.column("name").Header("Название",100).Sort().Error("Длина не более 10 символов").Filter(),$u.column("discount").Header("Скидка",60).AsInt().Sort().Filter(),$u.column("description").Header("Описание",-1).Filter(),],scheme:{id:-1,name:"без имени",type:n.PromoKind.Action},rules:{name:function(n){return n&&n.length<=10}},save:n.db.getSaveCfg(!0)}).Editable(),u=$u.rows($u.toolbar(this.grid.btnAdd(),this.grid.btnDel(),this.grid.btnRefresh(function(){return i.refresh()}),{},$u.icon("save").Click(function(){return i.formview.form.updateBindings()})),$u.cols(r,$u.splitter(),this.formview.config())),u},i.prototype.$init=function(){t.prototype.$init.call(this);this.formview.form.bind(this.grid)},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.first&&this.refresh()},i.prototype.refresh=function(){var t=n.db.getItems(n.PromoKind.Action);this.grid.refresh(t)},i}($u.View);n.ActGridView=t}(promo||(promo={})),function(n){var t=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.form=new $u.RefForm,t}return __extends(t,n),t.prototype.$config=function(){n.prototype.$config.call(this);var t="Список разрешенных зон, баз, или комнат";return this.form.config().extend({width:400,elements:[$u.element("name").Label("Код").Disable(),$u.element("discount").Label("Скидка, %"),$u.element("discountSum").Label("Скидка, руб").Tooltip("Введите название условия. Например: «Соло» или «Преподаватели». Будет отображаться в окне выбора условия раздела «Цены»"),$u.element("minHours").Label("Мин.часов").Tooltip("Минимальная длительность бронирования, часов"),$u.element("isToday").Label("Сегодня").AsCheckbox().Tooltip("При выставлении этой галочки параметры условия будут работать только день в день (с 00:01 сегодняшней даты)"),$u.element("allowDomainIds").Label("Разрешенные партнеры","top").AsMultiSelect(domains.db.namesUrl).Tooltip(t),$u.element("allowBaseIds").Label("Разрешенные базы","top").AsMultiSelect(bases.db.namesUrl).Tooltip(t),$u.element("allowRoomIds").Label("Или разрешенные комнаты","top").AsMultiSelect(rooms.db.names(undefined,!0)).Tooltip(t),$u.element("maxOrders").Label("Макс.заказов"),$u.element("maxClientOrders").Label("Макс.по клиенту"),$u.element("options").Label("Опции","top").AsMultiSelect(groups.db.options()),$u.element("isArchive").Label("Архив").AsCheckbox(),$u.element("description").Label("Описание").AsTextArea(100),{},]})},t}($u.View);n.CodeEditView=t}(promo||(promo={})),function(n){var t=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i.grid=new $u.RefGrid,i.formview=new n.CodeEditView(i),i}return __extends(i,t),i.prototype.$config=function(){var i=this;t.prototype.$config.call(this);var r=$u.getLink("#name#","orders/search-s/#id#?promo=#id#"),u=this.grid.config().extend({columns:[$u.column("isArchive").Header("Арх").AsCheckboxReadly().Sort(),$u.column("name").Header("ПромоКод",100).Sort().Error("Длина не более 10 символов").Template(r),$u.column("discount").Header("Скидка",60).AsInt().Sort(),$u.column("maxOrders").Header("Заказы",60).AsInt().Sort(),$u.column("maxClientOrders").Header("Клиенты",62).AsInt().Sort(),$u.column("description").Header("Описание",-1),],scheme:{id:-1,name:"",type:n.PromoKind.Number},rules:{},save:n.db.getSaveCfg(!0)}).Editable();return $u.rows($u.panelbar(this.grid.btnAdd(),this.grid.btnDel(),this.grid.btnRefresh(function(){return i.refresh()}),{},$u.icon("save").Click(function(){return i.formview.form.updateBindings()})),$u.cols(u,$u.splitter(),this.formview.$config()))},i.prototype.$init=function(){t.prototype.$init.call(this);this.formview.form.bind(this.grid)},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.first&&this.refresh()},i.prototype.refresh=function(){var t=n.db.numItems();this.grid.refresh(t)},i}($u.View);n.CodeGridView=t}(promo||(promo={})),function(n){var t=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.form=new $u.RefForm,t}return __extends(t,n),t.prototype.$config=function(){n.prototype.$config.call(this);return this.form.config().extend({width:400,elements:[$u.element("name").Label("Имя"),$u.element("discount").Label("Скидка, %"),$u.element("discountSum").Label("Скидка, руб"),$u.element("eqDiscount").Label("Скидка,% оборуд."),$u.element("clientDiscountKind").Label("Скидка клиента").AsSelect(app.discountKinds),$u.element("isArchive").Label("Блокировать").AsCheckbox(),$u.element("description").Label("Описание").AsTextArea(200),{},]})},t}($u.View);n.EditActView=t}(promo||(promo={})),function(n){var t=function(){function n(){this.form=new $u.RefForm}return n.prototype.config=function(){var n="Введите название условия. Например: «Соло» или «Преподаватели». Будет отображаться в окне выбора условия раздела «Цены»",t="Укажите будет ли распространяться скидка из карточки клиента на комнату или позиции у созданного условия. Например, у клиента 10% скидка на все услуги, но при бронировании комнаты попадающей под созданное условие скидка на комнату и оборудование не будет учитываться если выбрать значение «Блокируем» в обоих полях",i="Выберите на каком объекте или в каких комнатах будут действовать параметры этого условия. Поля взаимоисключающие, это значит, что заполнено должно быть только одно (либо комнаты, либо базы).",r="Выберете календарный период действия параметров условия";return this.form.config().extend({width:400,elements:[$u.element("name").Label("Имя").Tooltip("Введите название условия. Например: «Соло» или «Преподаватели». Будет отображаться в окне выбора условия раздела «Цены»"),$u.element("discount").Label("Скидка, %").Tooltip(n),$u.element("discountSum").Label("Скидка, руб").Tooltip(n),$u.element("eqDiscount").Label("Скидка,% оборуд.").Tooltip(n),$u.element("dayKinds").Label("Дни").AsMultiSelect(app.dayKinds).Tooltip("Выберите по каким дням будет действовать это условие или скидка"),$u.element("options").Label("Опции","top").AsMultiSelect(groups.db.options()),$u.element("range1").Label("С..").AsInt().Tooltip("Диапазон С"),$u.element("range2").Label("..По").AsInt().Tooltip("Диапазон По"),$u.element("clientDiscountKind").Label("Cкидка клиента комн").AsSelect(app.discountKinds).Tooltip(t),$u.element("eqClientDiscountKind").Label("Cкидка клиента оборуд.").AsSelect(app.discountKinds).Tooltip(t),$u.element("hours").Label("Часы").Tooltip("Введите период действия этого условия или скидки в течении дня в формате «12-18». Например, если вы создаете условие для бронирование сольных репетиций заранее, то указав значение «9-12,21-24» условие будет работать с 9 до 12 утра и с 9 до 12 вечера"),$u.element("minHours").Label("Мин.часов").Tooltip("Минимальная длительность бронирования, часов"),$u.element("isOverride").Label("Перекрывает").AsCheckbox().Tooltip("Выставите эту галочку если у вас несколько условий со схожими параметрами, и вы хотите, чтобы это условие было в приоритете"),$u.element("isToday").Label("Сегодня").AsCheckbox().Tooltip("При выставлении этой галочки параметры условия будут работать только день в день (с 00:01 сегодняшней даты)"),$u.element("isArchive").Label("Архив").AsCheckbox().Tooltip("Выставив этот параметр условие прекратит свое действие, но останется доступным для редактирования"),$u.element("allowBaseIds").Label("Разрешенные базы","top").AsMultiSelect(bases.db.namesUrl).Tooltip(i),$u.element("allowRoomIds").Label("Или разрешенные комнаты","top").AsMultiSelect(rooms.db.names(undefined,!0)).Tooltip(i),$u.element("dateFrom").Label("Начало").AsDate().Tooltip(r),$u.element("dateTo").Label("Окончание").AsDate().Tooltip(r),$u.element("description").Label("Описание").AsTextArea(100).Tooltip(""),{},]})},n}();n.EditForm=t}(promo||(promo={})),function(n){var t=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.form=new $u.RefForm,t}return __extends(t,n),t.prototype.$config=function(){n.prototype.$config.call(this);return this.form.config().extend({elements:[$u.element("name").Label("Имя"),$u.element("discount").Label("Скидка, %").Error("Введите скидку в % или руб"),$u.element("discountSum").Label("Скидка, руб").Error("Введите скидку в % или руб"),$u.element("dateFrom").Label("С даты").AsDate(),$u.element("dateTo").Label("По дату").AsDate(),$u.element("hours").Label("Часы").Tooltip("Пример: 6-18,20-24").Error("Часы не разрешены в комнате"),$u.template("Часы горящей репетиции должны соответстовать временным промежуткам выбранных комнат").Css("it-error"),$u.element("isArchive").Label("Архив").AsCheckbox(),$u.element("allowRoomIds").Label("Разрешенные комнаты","top").AsMultiSelect(rooms.db.names(undefined,!0)),$u.element("options").Label("Опции","top").AsMultiSelect(groups.db.options()),$u.element("range1").Label("С..").AsInt().Tooltip("Диапазон С"),$u.element("range2").Label("..По").AsInt().Tooltip("Диапазон По"),$u.element("description").Label("Описание").AsTextArea(100),{},],rules:{$obj:function(n){var t=parseInt(n.discount),i=parseInt(n.discountSum);return t&&!i||!t&&i||It.UI.w.error("Не указана скидка или указаны обе скидки")}}})},t.prototype.checkHours=function(n,t){var i=rooms.db.allowHours(t.allowRoomIds,n);return i?(It.UI.w.error(i),!1):!0},t}($u.View);n.HotEditView=t}(promo||(promo={})),function(n){var t=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i.grid=new $u.RefGrid,i.formview=new n.HotEditView(i),i}return __extends(i,t),i.prototype.$config=function(){var u=this,i,r;return t.prototype.$config.call(this),i=this.grid.config().extend({columns:[$u.column("isArchive").Header("Арх").AsCheckboxReadly().Sort(),$u.column("name").Header("Название",100).Sort().Filter(),$u.column("discount").Header("%",60).AsInt().Sort().Filter(),$u.column("discountSum").Header("Руб",60).AsInt().Sort().Filter(),$u.column("hours").Header("Время",-1).Filter(),$u.column("description").Header("Описание",-3).Filter(),$u.column("dateTo").Header("Дата").AsDate(),],scheme:{id:-1,name:"без имени",type:n.PromoKind.Hot,clientDiscountKind:app.DiscountKind.IgnoreDiscount,eqClientDiscountKind:app.DiscountKind.UseDiscount,isOverride:!0,isToday:!0},save:n.db.getSaveCfg(!0)}).Editable(),r=$u.rows($u.toolbar(this.grid.btnAdd(),this.grid.btnDel(),this.grid.btnRefresh(),{},$u.icon("save").Click(function(){return u.formview.form.updateBindings()})),$u.cols(i,$u.splitter(),this.formview.$config().Size(300))),r},i.prototype.$init=function(){t.prototype.$init.call(this);this.formview.form.bind(this.grid)},i.prototype.$reload=function(i){t.prototype.$reload.call(this,i);var r=n.db.list({type:n.PromoKind.Hot});this.grid.refresh(r)},i}($u.View);n.HotGridView=t}(promo||(promo={})),function(n){var t=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i.grid=new $u.RefGrid,i.formview=new n.EditForm,i}return __extends(i,t),i.prototype.$config=function(){var i=this,r,u;return t.prototype.$config.call(this),r=this.grid.config().extend({columns:[$u.column("isArchive").Header("Арх").AsCheckboxReadly().Sort(),$u.column("name").Header("Название",100).Sort().Error("Длина не более 100 символов").Filter(),$u.column("discount").Header("Скидка",60).AsInt().Sort().Filter(),$u.column("description").Header("Описание",-1).Filter(),$u.column("isAction").Header("Акция").AsCheckboxReadly().Sort(),],scheme:{id:-1,name:"без имени",type:n.PromoKind.Rules,$init:function(n){n.dateFrom=parseDate(n.dateFrom);n.dateTo=parseDate(n.dateTo)}},rules:{name:function(n){return n&&n.length<100}},save:n.db.getSaveCfg(!0)}).Editable(),u=$u.rows($u.toolbar(this.grid.btnAdd(),this.grid.btnDel(),this.grid.btnRefresh(function(){return i.refresh()}),{},$u.icon("save").Click(function(){return i.formview.form.updateBindings()})),$u.cols(r,$u.splitter(),this.formview.config())),u},i.prototype.$init=function(){t.prototype.$init.call(this);this.formview.form.bind(this.grid)},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.first&&this.refresh()},i.prototype.refresh=function(){var t=n.db.getItems(n.PromoKind.Rules);this.grid.refresh(t)},i}($u.View);n.RulesGridView=t}(promo||(promo={})),function(n){var i,t;n.create={rulesgrid:function(){return new n.RulesGridView},actgrid:function(){return new n.ActGridView},codegrid:function(){return new n.CodeGridView},hotgrid:function(){return new n.HotGridView}},function(n){n[n.Action=0]="Action";n[n.Number=1]="Number";n[n.Rules=2]="Rules";n[n.Hot=3]="Hot"}(i=n.PromoKind||(n.PromoKind={}));t=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.getItems=function(n){return t.loadList("list",{type:n})},t.numItems=function(){return t.loadList("numItems")},t.names=function(n,i){return t.load("names",{actuals:n,type:i})},t}return __extends(t,n),t}(app.AppDataSource);n.db=new t("promo")}(promo||(promo={})),function(n){var t,i;(function(n){n[n.Registration=1]="Registration";n[n.Profile=2]="Profile";n[n.Booking=3]="Booking";n[n.Invite=4]="Invite";n[n.Manual=5]="Manual";n[n.Payment=10]="Payment";n[n.RetBooking=11]="RetBooking"})(t=n.PoinKind||(n.PoinKind={}));n.kinds=[{id:t.Registration,value:"Регистрация"},{id:t.Profile,value:"Профиль"},{id:t.Booking,value:"Бронирование"},{id:t.Invite,value:"Приглашение"},{id:t.Manual,value:"Вручную"},{id:t.Payment,value:"Оплата"},{id:t.RetBooking,value:"Отмена"},];i=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.list=function(n){return t.loadList("list",{client:n})},t}return __extends(t,n),t}(app.AppDataSource);n.db=new i("points")}(points||(points={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n}return __extends(i,t),i.prototype.$config=function(){return this.grid.config().extend({columns:[$u.column("domain").Header("Партнер",-1).Sort(),$u.column("base").Header("База",-1).Sort(),$u.column("room").Header("Комната",-1).Sort(),$u.column("dateAdded").Header("Добавлено").AsDate(webix.i18n.fullDateFormatStr).Sort(),$u.column("dateRemoved").Header("Удалено").AsDate(webix.i18n.fullDateFormatStr).Sort(),$u.column("isArchive").Header(It.symbols.Cross).AsCheckboxReadly().Sort(),]})},i.prototype.$reload=function(t){var i=n.db.list({client:t});this.grid.refresh(i)},i}($u.PopupView);n.GridView=t}(favorites||(favorites={})),function(n){var t=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.add=function(n){return this.post("add",{room:n})},t.prototype.remove=function(n){return this.post("remove",{room:n})},t}(app.AppDataSource);n.db=new t("favorites")}(favorites||(favorites={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n.form=new $u.RefForm,n}return __extends(i,t),i.prototype.$config=function(){var i=this;t.prototype.$config.call(this);var u=this,r=this.grid.config().extend({columns:[$u.column().AsOrderMarker(),$u.column("name").Header("Параметр",180).Sort().Filter().Edit(),$u.column("description").Header("Описание",-2).Sort().Edit(),$u.column("isArchive").Header("Арх").AsCheckbox().Sort().Edit(),],scheme:{id:-1,name:"новый тип",type:n.GroupType.Equipment,order:1e3},save:n.db.getSaveCfg(!0)}).Editable().DragOrder(function(t,i){return n.db.reindex(t,i)},!0);return $u.rows($u.panelbar(this.grid.btnAdd(),this.grid.btnDel(),this.grid.btnRefresh(function(){return i.refresh()}),{},$u.button("Сохранить").Click(function(){return i.form.updateBindings()})),$u.cols(r,this.configForm().Size(350)))},i.prototype.configForm=function(){return this.form.config().extend({elements:[$u.element("name").Label("Параметр комнаты","top"),$u.element("isArchive").Label("Скрыть (архив)").AsCheckbox(),$u.element("description").Label("Описание").AsTextArea(100,"top"),$u.element("sphereIds").Label("Сферы","top").AsMultiSelect(spheres.db.names()),{},]})},i.prototype.setImage=function(n){this.form.elements.icon.setValues(n.path)},i.prototype.$init=function(){t.prototype.$init.call(this);this.form.bind(this.grid)},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.first&&this.refresh()},i.prototype.refresh=function(){var t=n.db.list({type:n.GroupType.Equipment});this.grid.refresh(t)},i}($u.View);n.EqTypesGridView=t}(groups||(groups={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n}return __extends(i,t),i.prototype.$config=function(){var i=this;t.prototype.$config.call(this);var u=this,r=this.grid.config().extend({columns:[$u.column("fin").Header("Код").AsNumber().Edit().Sort().Filter(),$u.column("index").Header("Кф").AsNumber().Edit().Sort().Filter(),$u.column("name").Header("Группа",180).Sort().Filter().Edit(),$u.column("description").Header("Описание",-2).Sort().Edit(),$u.column("isArchive").Header("Арх").AsCheckbox().Sort().Edit(),],scheme:{id:-1,name:"фин.группа",type:n.GroupType.Fin,index:0},save:n.db.getSaveCfg(!0)}).Editable().DragOrder(function(t,i){return n.db.reindex(t,i)},!0);return $u.rows($u.panelbar(this.grid.btnAdd(),this.grid.btnDel(),this.grid.btnRefresh(function(){return i.refresh()}),{}),r)},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.first&&this.refresh()},i.prototype.refresh=function(){var t=n.db.list({type:n.GroupType.Fin});this.grid.refresh(t)},i}($u.View);n.FinGridView___old=t}(groups||(groups={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n}return __extends(i,t),i.prototype.$config=function(){var i=this,r,u;return t.prototype.$config.call(this),r=this.grid.config().extend({columns:[$u.column("date").Header("Дата").AsDate().Sort().Edit(),$u.column("kind").Header("Вид",120).AsSelect(n.kinds).Sort().Filter().Edit(),$u.column("prih").Header("Приход").AsInt().Sort().Edit().Footer({content:"summColumn"}),$u.column("rash").Header("Расход").AsInt().Sort().Edit().Footer({content:"summColumn"}),$u.column("description").Header("Описание",-1).Filter().Edit().Footer("Остаток"),$u.column("zcount").Header("",75).AsInt().Footer({content:"summColumn"}).Template(" ").Edit(),],scheme:{$save:function(n){return console.log("save",n)},$update:function(n){return console.log("update",n)},$change:function(n){return console.log("change",n)},$serialize:function(n){return console.log("serialize",n)}},save:n.db.getSaveCfg(!0)}).Footer().Editable(),u=$u.rows($u.panelbar(this.grid.btnAdd(),this.grid.btnDel(),this.grid.btnRefresh(function(){return i.reload(i.clientid)}),{}),r),u.Min(-1,400)},i.prototype.reload=function(t){this.clientid=t;var i=n.db.list(t);this.grid.refresh(i);this.grid.scheme({client:t})},i}($u.View);n.GridView=t}(points||(points={})),function(n){var t=function(){function n(){this.form=new $.RefForm}return n.prototype.config=function(){var n="Введите название условия. Например: «Соло» или «Преподаватели». Будет отображаться в окне выбора условия раздела «Цены»",t="Укажите будет ли распространяться скидка из карточки клиента на комнату или позиции у созданного условия. Например, у клиента 10% скидка на все услуги, но при бронировании комнаты попадающей под созданное условие скидка на комнату и оборудование не будет учитываться если выбрать значение «Блокируем» в обоих полях",i="Выберите на каком объекте или в каких комнатах будут действовать параметры этого условия. Поля взаимоисключающие, это значит, что заполнено должно быть только одно (либо комнаты, либо базы).",r="Выберете календарный период действия параметров условия";return this.form.config().extend({width:400,elements:[$.element("name").Label("Имя").Tooltip("Введите название условия. Например: «Соло» или «Преподаватели». Будет отображаться в окне выбора условия раздела «Цены»"),$.element("discount").Label("Скидка, %").Tooltip(n),$.element("discountSum").Label("Скидка, руб").Tooltip(n),$.element("eqDiscount").Label("Скидка,% оборуд.").Tooltip(n),$.element("dayKinds").Label("Дни").AsMultiSelect(app.dayKinds).Tooltip("Выберите по каким дням будет действовать это условие или скидка"),$.element("clientDiscountKind").Label("Cкидка клиента комн").AsSelect(app.discountKinds).Tooltip(t),$.element("eqClientDiscountKind").Label("Cкидка клиента оборуд.").AsSelect(app.discountKinds).Tooltip(t),$.element("hours").Label("Часы").Tooltip("Пример: 6-18,20-24").Tooltip("Введите период действия этого условия или скидки в течении дня в формате «12-18». Например, если вы создаете условие для бронирование сольных репетиций заранее, то указав значение «9-12,21-24» условие будет работать с 9 до 12 утра и с 9 до 12 вечера"),$.element("isOverride").Label("Перекрывает").AsCheckbox().Tooltip("Выставите эту галочку если у вас несколько условий со схожими параметрами, и вы хотите, чтобы это условие было в приоритете"),$.element("isToday").Label("Сегодня").AsCheckbox().Tooltip("При выставлении этой галочки параметры условия будут работать только день в день (с 00:01 сегодняшней даты)"),$.element("isArchive").Label("Архив").AsCheckbox().Tooltip("Выставив этот параметр условие прекратит свое действие, но останется доступным для редактирования"),$.element("allowBaseIds").Label("Разрешенные базы","top").AsMultiSelect(bases.db.namesUrl).Tooltip(i),$.element("allowRoomIds").Label("Или разрешенные комнаты","top").AsMultiSelect(rooms.db.names(undefined,!0)).Tooltip(i),$.element("dateFrom").Label("Начало").AsDate().Tooltip(r),$.element("dateTo").Label("Окончание").AsDate().Tooltip(r),$.element("description").Label("Описание").AsTextArea(100).Tooltip(""),{},]})},n}();n.FilterForm=t}(promo||(promo={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n.filterForm=new $u.RefForm,n.form=new $u.RefForm,n.ansForm=new $u.RefForm,n.msglist=new $u.RefList,n}return __extends(i,t),i.prototype.$config=function(){var t=this,i=this.grid.config().extend({columns:[$u.column("idd").Header("*",30).Template(It.symbols.calendar.link("{common.href}/orders/calendar/?base=#baseId#&date=#dateFrom#")),$u.column("domain").Header("Партнер",-1).Sort().Filter(),$u.column("client").Header("Клиент",100).Sort().Filter().Template($u.getViewLink("clients","#client#","#clientId#")),$u.column("base").Header("База",-1).Sort().Filter(),$u.column("room").Header("Комната",-1).Sort().Filter(),$u.column("date").Header("Дата").AsDate().Sort().Filter(),$u.column("status").Header("Статус брони").AsSelect(orders.statuses).Sort().Filter(),$u.column("rstatus").Header("Статус").AsSelect(n.statuses).Sort().Filter(),$u.column("groupId").Header("Правило").AsSelect(groups.db.names(groups.GroupType.Reviews)).Sort().Filter(),$u.column("value").Header("Оценка").Sort().AsInt().Footer({content:"avgColumn"}),$u.column("text").Header("Отзыв",-3).Sort().Filter(),],scheme:{$init:function(n){orders.logic.getStateCss(n)}},save:n.db.getSaveCfg(!0)}).Editable().Footer(),r=this.filterForm.config().extend({cols:[$u.element("date1").Label("Дата с",null,60).Size(170).AsDate(),$u.element("date2").Label("По",null,30).Size(140).AsDate(),$u.element("statuses").Label("Статусы",null,60).AsMultiSelect(n.statuses).Size(-1).Value([n.ReviewStatus.Moderate]),$u.button("Найти").Click(function(){return t.reload()}),$u.button("Ответить").PopupCfg(this.ui_answer()),]});return $u.rows(r,i)},i.prototype.ui_answer=function(){function u(){if(t=i.grid.getSelectedItem(),!t)return webix.message("Не выделена запись","debug");i.form.setValues(t);var n=messages.db.list({order:t.orderId,kind:messages.MessageKind.Review,desc:!1});i.msglist.refresh(n)}var r=this,i=this,t=null,f=this.form.config().extend({width:400,elements:[$u.element("domain").Label("Партнер"),$u.element("base").Label("База"),$u.element("room").Label("Комната"),$u.element("client").Label("Клиент"),$u.element("text").Label("Текст сообщения").AsTextArea(100),]}).Readonly(!0).Disable(!0),e=this.msglist.config().extend({template:"http->"+It.Web.WebSource.base+"/html/message-list.html",type:{href:"#!",height:"auto",d:function(n){return webix.i18n.fullDateFormatStr(n.date)}}}).Max(-1,300).Scrollable(),o=this.ansForm.config().extend({width:400,elements:[$u.element("text").Label("Текст ответа партнеру").AsTextArea(100).Require(),$u.cols($u.button("Обработать").Click(function(){return r.reply(n.ReviewStatus.Processed)}),$u.button("Удалить").Click(function(){return r.reply(n.ReviewStatus.Cancel)}),{}),]}),s=$u.rows($u.label("Форма ответа модератора").Css("w3-panel w3-large w3-theme-l5"),f,e,o,{height:40});return $u.popup(s).On("onShow",u)},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.first&&this.reload()},i.prototype.reload=function(){var t=this.filterForm.values(),i;t.all=!0;i=n.db.list(t);this.grid.refresh(i)},i.prototype.reply=function(t){var i,r,u;if(this.ansForm.validate()){if(i=this.grid.getSelectedItem(),!i)return webix.message("Не выделена запись","debug");r=this.ansForm.values();u=n.db.reply({review:i.id,text:r.text,status:t});this.ansForm.clear();this.reload();webix.message("Сообщение успешно отправлено")}},i}($u.View);n.GridAllView=t}(reviews||(reviews={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n.form=new $u.RefForm,n.filterForm=new $u.RefForm,n.ansForm=new $u.RefForm,n.msglist=new $u.RefList,n}return __extends(i,t),i.prototype.$config=function(){var t=this,i=this.grid.config().extend({columns:[$u.column("idd").Header("*",30).Template(It.symbols.calendar.link("{common.href}/orders/calendar/?base=#baseId#&date=#dateFrom#")),$u.column("client").Header("Клиент",100).Sort().Filter().Template($u.getViewLink("clients","#client#","#clientId#")),$u.column("base").Header("База",-1).Sort().Filter(),$u.column("room").Header("Комната",-1).Sort().Filter(),$u.column("date").Header("Дата").AsDate().Sort().Filter(),$u.column("status").Header("Статус брони").AsSelect(orders.statuses).Sort().Filter(),$u.column("rstatus").Header("Статус").AsSelect(n.statuses).Sort().Filter(),$u.column("groupId").Header("Правило").AsSelect(groups.db.names(groups.GroupType.Reviews)).Sort().Filter(),$u.column("value").Header("Оценка").Sort().AsInt().Footer({content:"avgColumn"}),$u.column("text").Header("Отзыв",-3).Sort().Filter(),],scheme:{$init:function(n){orders.logic.getStateCss(n)}},save:n.db.getSaveCfg(!0)}).Editable().Footer(),r=this.filterForm.config().extend({cols:[$u.element("date1").Label("Дата с",null,60).Size(170).AsDate(),$u.element("date2").Label("По",null,30).Size(140).AsDate(),$u.element("statuses").Label("Статусы",null,60).AsMultiSelect(n.statuses).Size(-1).Value([n.ReviewStatus.New]),$u.button("Найти").Click(function(){return t.reload()}),$u.button("Ответить").PopupCfg(this.ui_answer()),]});return $u.rows(r,i)},i.prototype.ui_answer=function(){function u(){if(t=i.grid.getSelectedItem(),!t)return webix.message("Не выделена запись","debug");i.form.setValues(t);var n=messages.db.list({order:t.orderId,kind:messages.MessageKind.Review,desc:!1});i.msglist.refresh(n)}var r=this,i=this,t=null,f=this.form.config().extend({width:400,elements:[$u.element("base").Label("База"),$u.element("room").Label("Комната"),$u.element("client").Label("Клиент"),$u.element("text").Label("Текст сообщения").AsTextArea(100),]}).Readonly(!0).Disable(!0),e=this.msglist.config().extend({template:"http->"+It.Web.WebSource.base+"/html/message-list.html",type:{href:"#!",height:"auto",d:function(n){return webix.i18n.fullDateFormatStr(n.date)}}}).Max(-1,300).Scrollable(),o=this.ansForm.config().extend({width:400,elements:[$u.element("text").Label("Текст ответа").AsTextArea(100).Require(),$u.cols($u.button("Пожаловаться").Click(function(){return r.reply(n.ReviewStatus.Moderate)}),$u.button("Ответить").Click(function(){return r.reply(n.ReviewStatus.Ok)}),{}),]}),s=$u.rows($u.label("Форма ответа").Css("w3-panel w3-large w3-theme-l5"),f,e,o,{height:40});return $u.popup(s).On("onShow",u)},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.first&&this.reload()},i.prototype.reload=function(){var t=this.filterForm.values(),i=n.db.list(t);this.grid.refresh(i)},i.prototype.reply=function(t){var i,r,u;if(this.ansForm.validate()){if(i=this.grid.getSelectedItem(),!i)return webix.message("Не выделена запись","debug");r=this.ansForm.values();u=n.db.reply({review:i.id,text:r.text,status:t});this.ansForm.clear();this.reload();webix.message("Сообщение успешно отправлено")}},i}($u.View);n.GridView=t}(reviews||(reviews={})),function(n){var t,i;n.create={grid:function(){return new n.GridView},"grid-all":function(){return new n.GridAllView}},function(n){n[n.Unknown=0]="Unknown";n[n.New=1]="New";n[n.Moderate=2]="Moderate";n[n.Processed=3]="Processed";n[n.Changed=4]="Changed";n[n.Ok=10]="Ok";n[n.Cancel=11]="Cancel"}(t=n.ReviewStatus||(n.ReviewStatus={}));n.statuses=[{id:t.New,value:"Новый"},{id:t.Moderate,value:"Модерация"},{id:t.Processed,value:"Обработано"},{id:t.Changed,value:"Изменено"},{id:t.Ok,value:"Отвечено"},{id:t.Cancel,value:"Отменено"},];i=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.add=function(n){return this.post("add",n)},t.prototype.reply=function(n){return this.post("reply",n)},t}(app.AppDataSource);n.db=new i("reviews")}(reviews||(reviews={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n.filterForm=new $u.RefForm,n}return __extends(i,t),i.prototype.$config=function(){var r=this;t.prototype.$config.call(this);var i=160,u=n.db.groups(1),f=n.db.groups(2),e=n.db.groups(3),s=this.grid.config().extend({scrollAlignY:!0,scrollX:!0,leftSplit:2,columns:[$u.column("date").Header("Дата").AsDate(webix.i18n.fullDateFormatStr).Sort(),$u.column("total").AsInt().Header("Стоимость",70).AsInt().Sort().Footer({content:"summColumn"}),$u.column("register").Header("Регистр",i).AsSelect(u).Sort().Filter(),$u.column("operation").Header("Операция",i).AsSelect(f).Sort().Filter(),$u.column("details").Header("Детали",i).AsSelect(e).Sort().Filter(),$u.column("sphere").Header("Сфера",i).Sort().Filter(),$u.column("domain").Header("Партнер",i).Sort().Filter(),$u.column("base").Header("База",i).Sort().Filter(),$u.column("room").Header("Комната",i).Sort().Filter(),$u.column("orderId").Header("Бронь",50).Template($u.getViewLink("orders","(...)","#orderId#")),$u.column("client").Header("Клиент",i).Sort().Template(clients.getClientColumnTemplate()).Filter(),$u.column("text").Header("Комментарий",i*3),],scheme:{}}).Footer(),o=new Date,h=this.filterForm.config().extend({width:400,elements:[$u.element("dfrom").Label("Дата с").AsDate().Value(o.addDays(-7)),$u.element("dto").Label("По").AsDate().Value(o.addDays(1)),$u.element("register").Label("Регистр").AsSelect(u),$u.element("operation").Label("Операция").AsSelect(f),$u.element("details").Label("Детали").AsSelect(e),$u.element("domain").Label("Партнер").AsSelect(domains.db.names()),$u.element("sphere").Label("Сфера").AsSelect(spheres.db.names()),$u.element("base").Label("База").AsSelect(bases.db.names(!0)),$u.element("room").Label("Комната").AsSelect(rooms.db.names(null,!0)),$u.element("eqtypes").Label("Тип позиции").AsMultiSelect(groups.db.names(groups.GroupType.Equipment)),$u.cols($u.button("Найти").Click(function(){return r.refresh()}).Tooltip("Пересчитать данные и обновить отчет"),$u.button("Очистить").Click(function(){return r.filterForm.clear()})),]});return $u.rows($u.cols($u.button("Поиск").Popup(h),$u.button("Открыть").Click(function(){return r.open()}),{}),s)},i.prototype.refresh=function(){var t=this.filterForm.values(),i=n.db.search(t);this.grid.refresh(i);webix.message("Отчет обновлен")},i.prototype.open=function(){var n=this.grid.getSelectedItem();!n},i}($u.View);n.GridView=t}(trans||(trans={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.filterForm=new $u.RefForm,n.pivot=new $u.RefPivot,n}return __extends(i,t),i.prototype.$config=function(){var i=this;t.prototype.$config.call(this);var r=n.db.groups(1),u=this.filterForm.config().extend({cols:[$u.icon("refresh").Click(function(){return i.refresh()}).Tooltip("Пересчитать данные и обновить отчет"),$u.element("register").Label("Регистр",null,70).AsSelect(r),$u.element("dfrom").Label("Дата с",null,50).Size(170).AsDate(),$u.element("dto").Label("По",null,40).Size(170).AsDate(),$u.icon("file-excel-o").Click(function(){return i.export()}).Tooltip("Экспортировать в Ексел"),$u.button("Сбросить").Click(function(){return i.pivot.clearConfig(!0)}).Tooltip("Сбросить настройки"),{},]}),f=this.pivot.config().extend({columnWidth:80,fieldMap:{register:"Регистр",operation:"Операция",details:"Детали",client:"Клиент",domain:"Партнер",sphere:"Сфера",group:"Опции",base:"База",room:"Комната",total:"Сумма",year:"Год",month:"Месяц",day:"День",week:"Неделя",weekDate:"Нач.Нед",weekDay:"Д/нед"},scheme:{},structure:{filters:[{name:"sphere",type:"select"},{name:"domain",type:"select"},],columns:[{id:"year",header:"Год"},{id:"weekDate",header:"Нач.Нед"},{id:"weekDay",header:"День",sort:"string"},],values:[{name:"total",operation:"sum"},],rows:["sphere","domain","operation"]}});return $u.rows(u,f)},i.prototype.$init=function(){var n,i;t.prototype.$init.call(this);n=new Date(Date.now());n=webix.Date.weekStart(n);i={dfrom:n,dto:n.addDays(6)};this.filterForm.setValuesEx(i);this.pivot.setConfig("pivot.trans.totals")},i.prototype.refresh=function(){var t=this.filterForm.values(),i=n.db.totals(t);this.pivot.refresh(i);webix.message("Отчет обновлен")},i.prototype.export=function(){var n={filename:"totals "+(new Date).toLocaleDateString("ru"),name:"totals",filterHTML:!0};this.pivot.toExcel(n)},i}($u.View);n.TotalsView=t}(trans||(trans={})),function(n){n.create={grid:function(){return new n.GridView},totals:function(){return new n.TotalsView}};var t=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.groups=function(n){return t.loadList("groups",{level:n})},t}return __extends(t,n),t.prototype.search=function(n){return this.loadList("search",n)},t.prototype.totals=function(n){return this.loadList("totals",n)},t}(app.AppDataSource);n.db=new t("trans")}(trans||(trans={})),function(n){var t=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i.grid=new $u.RefGrid,i.filterForm=new $u.RefForm,i.editor=new n.OrderEditor,i}return __extends(i,t),i.prototype.$config=function(){var i=this;t.prototype.$config.call(this);It.Web.loadJS("lib/webix-ext/xlsx.core.min.js");var u=n.logic,f=this.grid.config().extend({scrollAlignY:!0,scrollX:!0,leftSplit:1,columns:[$u.column("idd").Header("*",30).Template("&#128197;".link("{common.href}/orders/calendar/?base=#baseId#&date=#dateFrom#")),$u.column("client").Header("Клиент",150).Sort().Template(clients.getClientColumnTemplate()).Filter(),$u.column("sourceType").AsSelect(n.sourceTypes).Header("Источник").Sort().Filter(),$u.column("isPrepay").Header("Пред").AsCheckboxReadly(!0),$u.column("dateFrom").Header("Дата").AsDate().Sort(),$u.column("domainId").AsSelect(domains.db.names()).Header("Партнер",140).Sort().Filter(),$u.column("sphereId").AsSelect(spheres.db.names()).Header("Сфера",140).Sort().Filter(),$u.column("baseId").AsSelect(bases.db.names(!0)).Header("База",140).Sort().Filter(),$u.column("roomId").AsSelect(rooms.db.namesUrl).Header("Комната",140).Sort().Filter(),$u.column("promo").Header("Промокод",50).Sort().Filter(),$u.column("hours").Header("Часов",50).AsInt().Sort().Footer({content:"summColumn"}),$u.column("totalSum").AsInt().Header("Стоимость",70).AsNumber().Sort().Footer({content:"summColumn"}),$u.column("discounts").AsInt().Header("Скидка",70).AsInt().Sort().Footer({content:"summColumn"}),$u.column("eqSum").AsInt().Header("Доп.",70).AsInt().Sort().Footer({content:"summColumn"}),$u.column("mobComm").AsInt().Header("Ком.",70).AsInt().Sort().Footer({content:"summColumn"}),$u.column("comment").Header("Комментарий",100).Filter(),$u.column("clientComment").Header("Комм.клиента",100).Filter(),$u.column("status").AsSelect(n.statuses).Header("Статус",100).Sort().Filter(),$u.column("options").Header("Опции",180).Sort().Filter(),$u.column("reason").AsSelect(n.cancelReasons).Header("Отмена",100).Sort().Filter(),],scheme:{$init:function(n){n.date=parseDate(n.date);u.getStateCss(n)}}}).Tooltip("<h3>#client#<\/h3><hr/><blockquote>#comment# #clientComment#<br/>#options#<\/blockquote>").Footer(),r=new Date,e=this.filterForm.config().extend({width:400,elements:[$u.element("search").Label("Названия"),$u.element("dfrom").Label("Дата с").AsDate().Value(r.addDays(-7)),$u.element("dto").Label("По").AsDate().Value(r),$u.element("base").Label("База").AsSelect(bases.db.names(!0)),$u.element("promo").Label("Промокод","top").AsSelect(promo.db.names(!0,promo.PromoKind.Action)),$u.element("status").Label("Статус документа").AsSelect(n.statuses),$u.element("option").Label("Опция").AsSelect(groups.db.options()),$u.element("sources").Label("Источники").AsMultiSelect(n.sourceKinds),$u.element("eqtypes").Label("Тип позиции").AsMultiSelect(groups.db.names(groups.GroupType.Equipment)),$u.element("eqs").Label("Позиции").AsMultiSelect(equipments.db.names()),$u.element("sourceTypes").Label("Типы источн.").AsMultiSelect(n.sourceTypes),$u.element("prepay").Label("Только предоплата").AsCheckbox(),$u.element("domain").Label("Партнер").AsSelect(domains.db.names()),$u.element("sphere").Label("Сфера").AsSelect(spheres.db.names()),$u.cols($u.button("Найти").Click(function(){return i.refresh()}).Tooltip("Пересчитать данные и обновить отчет"),$u.button("Очистить").Click(function(){return i.filterForm.clear()})),]});return $u.rows($u.cols($u.button("Поиск").Popup(e),$u.button("Открыть").Click(function(){return i.open()}),$u.icon("file-excel-o").Click(function(){return i.exportxlsx()}).Tooltip("Экспортировать в Ексел"),{}),f)},i.prototype.refresh=function(){var t=this.filterForm.values(),i=n.db.search(t);this.grid.refresh(i);webix.message("Отчет обновлен")},i.prototype.open=function(){var n=this.grid.getSelectedItem();n&&this.editor.edit(n.id)},i.prototype.exportxlsx=function(){this.grid.toExcel({filename:"orders-"+(new Date).toLocaleDateString("ru"),name:"orders",filterHTML:!0,columns:[{id:"client",header1:"ККК"},{id:"sourceType"},{id:"dateFrom"},{id:"baseId"},{id:"roomId"},{id:"promo"},{id:"houurs"},{id:"totalSum",exportType:"number"},{id:"discounts",exportType:"number"},{id:"eqSum",exportType:"number",exportFormat1:"#-##0.00"},{id:"status"},]});console.log("export xlsx")},i}($u.View);n.FilterGridFullView=t}(orders||(orders={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.form=new $u.RefForm,n.grid=new $u.RefGrid,n}return __extends(i,t),i.prototype.$config=function(){var t=this,i=$u.panelbar($u.button("Сохранить").Click(function(){return t.save()}),{}),r=this.form.config().Labels(120).extend({elements:[$u.cols($u.rows($u.element("discount").Label("Скидка, %").AsInt()),$u.rows($u.element("comment").Label("Комментарий").AsTextArea(100),$u.element("clientForfeit").Label("Прошлый штраф").AsNumber(),$u.element("totalSum").Label("Cтоимость общ").Css("it-warning").AsNumber())),]}),u=this.grid.config().extend({height:200,columns:[$u.column("idd").Header("*",30).Template(Symbols.calendar.link("{common.href}/orders/calendar/?base=#baseId#&date=#dateFrom#")),$u.column("dateFrom").Header("Дата").AsDate().Sort(),$u.column("dateTo").Header("",1).Size(1),$.column("baseId").AsSelect(bases.db.names()).Header("База",-1).Sort(),$u.column("roomId").AsSelect(rooms.db.names()).Header("Комната",-1).Sort(),$u.column("totalOrder").AsInt().Header("Стоимость",80).Sort(),$u.column("status").AsSelect(n.statuses).Header("Статус").Sort(),],scheme:{}}).Tooltip();return $u.rows(i,r,u,{})},i.prototype.$reload=function(i){t.prototype.$reload.call(this,i);var u=this.form.load(n.db.getUrl(i)),r=n.db.list({request:i});this.grid.refresh(r)},i.prototype.save=function(){if(this.form.validate()){var t=this.form.save(n.db.saveUrl(this.objectId),!1);webix.message("Данные о заявке сохранены")}},i}($u.View);n.RequestView=t}(orders||(orders={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n.filterForm=new $u.RefForm,n.form=new $u.RefForm,n.ansForm=new $u.RefForm,n.msglist=new $u.RefList,n}return __extends(i,t),i.prototype.$config=function(){var t=this,i=this.grid.config().extend({columns:[$u.column("date").Header("Дата").AsDate().Sort().Filter(),$u.column("domainId").Header("Партнер",100).AsSelect(domains.db.names()).Sort().Filter(),$u.column("base").Header("База",-1).Sort().Filter(),$u.column("room").Header("Комната",-1).Sort().Filter(),$u.column("client").Header("Клиент",-1).Sort().Filter().Template($u.getViewLink("clients","#client#","#clientId#")),$u.column("requestStatus").Header("Статус").AsSelect(n.requestStatuses).Sort().Filter(),$u.column("countOrders").Header("Брони").Sort().AsInt().Footer(),$u.column("countOrders").Header("*",30).Template(It.symbols.calendar.link("{common.href}/orders/search/?request=#id#")),],scheme:{$init:function(t){n.logic.getRequstStateCss(t)}},save:n.db.getSaveCfg(!0)}).Editable().Footer(),r=this.filterForm.config().extend({cols:[$u.element("dfrom").Label("Дата с",null,60).Size(170).AsDate(),$u.element("dto").Label("По",null,30).Size(140).AsDate(),$u.button("Найти").Click(function(){return t.reload()}),{gravity:-1},]});return $u.rows(r,i)},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.first&&this.reload()},i.prototype.reload=function(){var t=this.filterForm.values(),i;t.all=!0;i=n.db.requests(t);this.grid.refresh(i)},i}($u.View);n.RequestsGridView=t}(orders||(orders={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n.form=new $u.RefForm,n}return __extends(i,t),i.prototype.$config=function(){var i=this,r,u;return t.prototype.$config.call(this),r=this.grid.config().extend({tooltip:!0,columns:[$u.column().AsOrderMarker(),$u.column("name").Header("Название",-1).Sort().Filter(),$u.column("description").Header("Описание",-2).Sort().Filter(),$u.column("baseId").Header("База",140).AsSelect(bases.db.names()).Sort().Filter(),$u.column("isArchive").Header("Арх").AsCheckboxReadly().Sort(),],scheme:{id:-1,name:"новое правило",index:1e4},save:n.db.getSaveCfg(!0)}).DragOrder(function(t,i){return n.db.reindex(t,i)},!0),u=$u.rows($u.panelbar(this.grid.btnAdd(),this.grid.btnDel(),this.grid.btnRefresh(function(){return i.refresh()}),{},$u.button("Сохранить").Click(function(){return i.form.updateBindings()})),$u.cols(r,this.configEditForm().Size(350))),u},i.prototype.configEditForm=function(){var t={background:"#ebedf2"};return this.form.config().extend({elements:[$u.element("name").Label("Название").Require(),$u.element("baseId").Label("База").AsSelect(bases.db.names(!0)),$u.element("sources").Label("Источники").AsMultiSelect(orders.sourceTypes),$u.label("ЕСЛИ бронирование").Css(t),$u.element("ifKind").Label("Условие").AsSelect(n.ifkinds).Require(),$u.element("ifHours").Label("Часов").AsInt(),$u.label("ТО отмена доступна").Css(t),$u.element("thenKind").Label("Отмена").AsSelect(n.thenkinds).Require(),$u.element("thenHours").Label("Часов").AsInt(),$u.element("description").Label("Описание").AsTextArea(100,"top"),$u.element("isDefault").Label("По умолчанию").AsCheckbox().Visible(system.context.isSuper),$u.element("isArchive").Label("Скрыть (архив)").AsCheckbox(),{},]})},i.prototype.$init=function(){t.prototype.$init.call(this);this.form.bind(this.grid)},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.first&&this.refresh()},i.prototype.refresh=function(){var t=n.db.list();this.grid.refresh(t)},i}($u.View);n.GridView=t}(order_rules||(order_rules={})),function(n){var t=function(t){function i(){return t!==null&&t.apply(this,arguments)||this}return __extends(i,t),i.prototype.$config=function(){return this.form.config().extend({elements:[$u.element("cityId").Label("Город").AsSelect(groups.db.names(groups.GroupType.City)),$u.element("tarifId").Label("Текущий тариф","top").AsSelect(tarifs.db.names()),$u.element("period").Label("Граница даты","top").AsSelect(n.periods),$u.element("isPayment").Label("Только для оплат").AsSelect(app.booleans),$u.element("status").Label("Статус").AsSelect(n.statuses),$u.element("limitDate").Label("Срок").AsDate(),$u.element("tarifIds").Label("Доступные тарифы","top").AsMultiSelect(tarifs.db.names()),$u.element("isArchive").Label("Архивная").AsSelect(app.booleans),t.prototype.$config.call(this,"Изменить"),{},]})},i}($u.PopupView);n.PopupForm=t}(domains||(domains={})),function(n){var t=function(){function t(){this.form=new $.RefForm}return t.prototype.config=function(){return this.form.config().extend({elements:[$.cols($.element("period").Label("Граница даты","top").AsSelect(n.periods).Require(),$.element("isPayment").Label("Только для оплаченных").AsCheckbox(!0),$.button("Пересчитать"),{}),]})},t}();n.QuickEditForm=t}(domains||(domains={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n}return __extends(i,t),i.prototype.$config=function(){var u=this,i,r;return t.prototype.$config.call(this),i=this.grid.config().extend({columns:[$u.column("order").Header("⟠",35).Sort().Edit().Tooltip("Сортировка в календаре"),$u.column("name").Header("Название",200).Sort().Filter(),$u.column("base").Header("База",150).Sort().Filter(),$u.column("square").Header("Площадь").AsInt().Sort(),$u.column("isArchive").Header("Арх").AsCheckboxReadly().Sort(),$u.column("allowMobile").Header("Моб").AsCheckboxReadly().Sort(),],scheme:{id:-1,name:"без имени",color:"#f89623"},type:{href:"#!"},save:n.db.getSaveCfg(!0)}).Editable(),r={rows:[$u.panelbar(this.grid.btnRefresh(function(){return u.reload("")}),{}),i,]},r},i.prototype.reload=function(n){var t=rooms.db.list({domain:n});this.grid.refresh(t)},i}($u.View);n.RoomsView=t}(domains||(domains={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.form=new $u.RefForm,n.grid=new $u.RefGrid,n}return __extends(i,t),i.prototype.$config=function(){var i=this;t.prototype.$config.call(this);var r=$u.rows($u.toolbar(this.grid.btnDel(),this.grid.btnRefresh(function(){return i._reload_jobs(i.objectId)}),{}),this.grid.config().extend({columns:[$u.column("status").Header("Статус").AsSelect(jobs.statuses).Filter().Edit(),$u.column("date").Header("Дата",120).AsDate(webix.i18n.fullDateFormatStr),$u.column("attempts").Header("Попыток").AsNumber().Filter(),$u.column("description").Header("Описание",-1).Edit().Filter(),],scheme:{},rules:{status:webix.rules.isNotEmpty}}).Editable(jobs.db.getSaveCfg(!0)).Footer()),u=templates.db.names({key:templates.TemplateKind.Manual});return this.form.config().Labels(100).extend({elements:[$u.cols($u.button("Сохранить").Click(function(){return i.save()}),$u.button("Разослать").Click(function(){return i.send()}),{}),$u.element("name").Label("Название"),$u.cols($u.rows($u.element("templateId").Label("Шаблон").AsSelect(u).Require(),$u.element("fromDate").Label("Старт с").AsDate(!0),$u.element("status").Label("Статус").AsSelect(n.statuses).Readonly(),$u.element("description").Label("Описание").AsTextArea(100),$u.element("isArchive").Label("Архив").AsCheckbox()),$u.element("values").Label("Почтовые адреса").AsTextArea(400)),$u.tabview().Tab("Рассылка",r).Autoheight()]})},i.prototype.$reload=function(i){t.prototype.$reload.call(this,i);var r=this.form.load(n.db.getUrl(i));this._reload_jobs(i)},i.prototype._reload_jobs=function(n){var t=jobs.db.list(n);this.grid.refresh(t)},i.prototype.save=function(){if(!this.form.validate())return!1;return this.form.save(n.db.saveUrl(this.objectId),!1),webix.message("Данные сохранены на сервере"),!0},i.prototype.send=function(){this.save()==!0&&(n.db.send(this.objectId),this.$reload(this.objectId),webix.message("Отправлена рассылка"))},i}($u.View);n.EditView=t}(mailings||(mailings={})),function(n){var t=function(t){function i(){var n=t!==null&&t.apply(this,arguments)||this;return n.grid=new $u.RefGrid,n}return __extends(i,t),i.prototype.$config=function(){var i=this;t.prototype.$config.call(this);var r=templates.db.names({key:templates.TemplateKind.Manual}),u=this.grid.config().extend({columns:[$u.column("name").Header("Название",200).Sort().Filter().Template($u.getViewLink("mailings","#name#")),$u.column("description").Header("Описание",-1).Filter(),$u.column("fromDate").Header("Старт",110).AsDate(webix.i18n.fullDateFormatStr).Edit(),$u.column("status").Header("Статус").AsSelect(n.statuses).Filter().Edit(),$u.column("ok").Header("Ок",40),$u.column("errors").Header("Ошиб",45),$u.column("templateId").Header("Шаблон",250).AsSelect(r).Filter(),$u.column("isArchive").Header("Арх").AsCheckboxReadly().Sort(),],scheme:{name:"новая рассылка"}}).Editable(n.db.getSaveCfg(!0));return{rows:[$u.panelbar(this.grid.btnAdd(),this.grid.btnDel(),this.grid.btnRefresh(function(){return i.refresh()}),{}),u,]}},i.prototype.$activate=function(n){t.prototype.$activate.call(this,n);this.first&&this.refresh()},i.prototype.refresh=function(){var t=n.db.list();this.grid.refresh(t)},i}($u.View);n.GridView=t}(mailings||(mailings={})),function(n){var t,i;n.create={grid:function(){return new n.GridView},edit:function(){return new n.EditView}};t=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.send=function(n){return t.post("send",{id:n})},t}return __extends(t,n),t}(lists.DataSource);n.db=new t("mailings"),function(n){n[n.Unknown=0]="Unknown";n[n.Ok=10]="Ok"}(i=n.MailingStatus||(n.MailingStatus={}));n.statuses=[{id:i.Ok,value:"ОК"},]}(mailings||(mailings={}));